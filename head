<style>
  :root{
    --bg-body:#050505;
    --bg-panel:#111111;
    --bg-card:#181818;
    --bg-input:#222222;
    --border:#2b2b2b;
    --accent:#2b6cff;
    --accent-hover:#1a5cff;
    --text-main:#ffffff;
    --text-sec:#a0a0a0;
    --header-h:74px;
  }

  .t-tilda-label, #tilda-copyright, #tilda-copy { display:none !important; }

  #lfhdr * { box-sizing:border-box; }
  #lfhdr{
    font-family:Inter,system-ui,-apple-system,Segoe UI,Roboto,Arial,sans-serif;
    color:var(--text-main);
  }

  #lfhdr header{
    height:var(--header-h);
    padding:0 22px;
    display:flex;
    align-items:center;
    justify-content:space-between;
    background:rgba(5,5,5,.92);
    border-bottom:1px solid var(--border);
    position:sticky;
    top:0;
    z-index:1000;
    backdrop-filter: blur(10px);
  }

  .lfhdr-brand{
    display:flex; align-items:center; gap:10px;
    font-weight:1000; letter-spacing:-.4px; font-size:20px;
    cursor:pointer;
    user-select:none;
  }

  .lfhdr-switch{
    background:var(--bg-input);
    padding:5px;
    border-radius:999px;
    display:flex; gap:5px;
    border:1px solid var(--border);
    align-items:center;
  }
  .lfhdr-switch button{
    border:0; background:transparent;
    color:var(--text-sec);
    padding:9px 16px;
    border-radius:999px;
    cursor:pointer;
    font-weight:900;
    font-size:14px;
    white-space:nowrap;
    display:flex; align-items:center; gap:8px;
    transition: .15s;
  }
  .lfhdr-switch button:hover{ color:#fff; background:rgba(255,255,255,0.05); }
  .lfhdr-switch button.active{
    background:var(--bg-body);
    color:var(--text-main);
    box-shadow:0 6px 16px rgba(0,0,0,.35);
  }

  /* ChatGPT tab */
  .lfhdr-switch .lfhdr-tab-chatgpt{
    margin-left:8px;
    padding-left:18px;
    padding-right:18px;
    color:rgba(255,255,255,.95);
    border:1px solid rgba(255,255,255,.12);
    background:rgba(255,255,255,.05);
    position:relative;
  }
  .lfhdr-switch .lfhdr-tab-chatgpt::before{
    content:"";
    width:1px;
    height:18px;
    background:rgba(255,255,255,.10);
    display:inline-block;
    margin-right:12px;
    transform: translateY(2px);
  }
  .lfhdr-switch .lfhdr-tab-chatgpt.active{
    background:rgba(255,255,255,.08);
    border-color:rgba(255,255,255,.20);
    box-shadow:0 10px 26px rgba(0,0,0,.45);
  }

  .lfhdr-profile{ position:relative; }
  .lfhdr-avatar{
    width:42px; height:42px;
    border-radius:999px;
    background:linear-gradient(135deg,#2b2b2b,#4a4a4a);
    display:flex; align-items:center; justify-content:center;
    font-weight:1000;
    cursor:pointer;
    border:1px solid rgba(255,255,255,.08);
    user-select:none;
    overflow:hidden;
  }
  .lfhdr-avatar img{ width:100%; height:100%; object-fit:cover; display:block; }
  /* Emoji avatars */
  .avatar.emoji,
  .pava.emoji,
  .pava#p-ava.emoji,
  .lfhdr-avatar.emoji,
  .lfhdr-dd-ava.emoji{
    display:flex;
    align-items:center;
    justify-content:center;
    line-height:1;
    user-select:none;
    font-family:"Apple Color Emoji","Segoe UI Emoji","Segoe UI Symbol","Noto Color Emoji",sans-serif;
  }
  .avatar.emoji{ font-size:18px; }
  .pava.emoji{ font-size:34px; }
  .lfhdr-avatar.emoji, .lfhdr-dd-ava.emoji{ font-size:22px; }

  .lfhdr-dd{
    position:absolute;
    top:52px; right:0;
    width:300px;
    background:var(--bg-panel);
    border:1px solid var(--border);
    border-radius:14px;
    padding:10px;
    box-shadow:0 18px 70px rgba(0,0,0,.7);
    display:none;
    z-index:2000;
  }
  .lfhdr-dd.show{ display:block; }

  /* ✅ NEW: user card */
  .lfhdr-usercard{
    display:flex;
    gap:12px;
    align-items:center;
    padding:12px;
    border-radius:12px;
    border:1px solid rgba(255,255,255,.10);
    background:rgba(255,255,255,.03);
    cursor:pointer;
    transition:.15s;
  }
  .lfhdr-usercard:hover{
    background:rgba(255,255,255,.06);
    border-color:rgba(255,255,255,.16);
  }
  .lfhdr-dd-ava{
    width:44px; height:44px;
    border-radius:999px;
    overflow:hidden;
    background:linear-gradient(135deg,#2b2b2b,#4a4a4a);
    border:1px solid rgba(255,255,255,.10);
    flex:0 0 auto;
    display:flex; align-items:center; justify-content:center;
    font-weight:1000;
  }
  .lfhdr-dd-ava img{ width:100%; height:100%; object-fit:cover; display:block; }
  .lfhdr-udata{ min-width:0; }
  .lfhdr-uname{
    font-weight:1000;
    letter-spacing:-.2px;
    font-size:14px;
    white-space:nowrap; overflow:hidden; text-overflow:ellipsis;
    color:#fff;
  }
  .lfhdr-uuser{
    margin-top:2px;
    font-weight:900;
    font-size:12px;
    color:rgba(255,255,255,.65);
    white-space:nowrap; overflow:hidden; text-overflow:ellipsis;
  }
  .lfhdr-uemail{
    margin-top:6px;
    font-size:12px;
    color:rgba(255,255,255,.55);
    white-space:nowrap; overflow:hidden; text-overflow:ellipsis;
  }

  .lfhdr-dd .item{
    padding:12px 12px;
    border-radius:10px;
    color:var(--text-sec);
    display:flex; justify-content:space-between; gap:10px;
    cursor:pointer;
    font-weight:800;
    font-size:14px;
  }
  .lfhdr-dd .item:hover{ background:rgba(255,255,255,.04); color:var(--text-main); }
  .lfhdr-dd .divider{ height:1px; background:var(--border); margin:10px 0; }

  .lfhdr-dd .item.primary {
    color:#fff;
    border:1px solid rgba(255,255,255,.10);
    background:rgba(255,255,255,.03);
  }
  .lfhdr-dd .item.primary:hover{
    border-color:rgba(255,255,255,.18);
    background:rgba(255,255,255,.06);
  }
</style>

<div id="lfhdr">
  <header>
    <div class="lfhdr-brand" id="lfhdr-brand">Lightfull</div>

    <div class="lfhdr-switch">
      <button type="button" data-tab="flow">Flow</button>
      <button type="button" data-tab="video">Video</button>
      <button type="button" data-tab="image">Image</button>

      <button type="button" data-tab="cinema_lab">Cinema Lab</button>
      <button type="button" data-tab="node_studio">Node Studio</button>
      <button type="button" data-tab="product">Product Creation</button>

      <button type="button" data-tab="editor">Editor</button>
      <button type="button" data-tab="feed">Feed</button>
      <button type="button" data-tab="library">Library</button>

      <button type="button" data-tab="chatgpt" class="lfhdr-tab-chatgpt">ChatGPT</button>
    </div>

    <div class="lfhdr-profile">
      <div class="lfhdr-avatar" id="lfhdr-avatar">U</div>

      <div class="lfhdr-dd" id="lfhdr-dd">

        <!-- ✅ NEW: avatar + name + username + email (avatar + name clickable to public profile) -->
        <div class="lfhdr-usercard" id="lfhdr-usercard" style="display:none;">
          <div class="lfhdr-dd-ava" id="lfhdr-dd-ava">U</div>
          <div class="lfhdr-udata">
            <div class="lfhdr-uname" id="lfhdr-name">—</div>
            <div class="lfhdr-uuser" id="lfhdr-username">@—</div>
            <div class="lfhdr-uemail" id="lfhdr-email">—</div>
          </div>
        </div>

        <div class="divider" id="lfhdr-userdiv" style="display:none;"></div>

        <div class="item" style="cursor:default">
          <span>Credits</span>
          <strong id="lfhdr-credits" style="color:#fff">—</strong>
        </div>

        <div class="item" id="lfhdr-plans" style="color:var(--text-sec); cursor:default;">
          <span>Plans</span>
        </div>

        <!-- ✅ Profile editor link stays -->
        <div class="item" id="lfhdr-profile-link"><span>Profile</span></div>

        <div class="item" id="lfhdr-promo"><span>Promo code</span></div>

        <div class="divider"></div>

        <div class="item primary" id="lfhdr-login" style="display:none"><span>Login</span></div>
        <div class="item" id="lfhdr-logout" style="color:#ff465a"><span>Logout</span></div>
      </div>
    </div>
  </header>
</div>

<script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
<script>
(() => {
  const BASE = location.origin;

  const EDITOR_URL  = "https://lightfull.ai/lf-editor";
  const FEED_URL    = "https://lightfull.ai/feed";
  const PROFILE_URL = "https://lightfull.ai/profile"; // profile editor
  const ARTIST_URL  = (uname) => "https://lightfull.ai/artist?username=" + encodeURIComponent(uname || "");

  const SUPABASE_URL = "https://vqnmzstiaosqeoltcwbq.supabase.co";
  const SUPABASE_ANON_KEY = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InZxbm16c3RpYW9zcWVvbHRjd2JxIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjgwMDA1MzcsImV4cCI6MjA4MzU3NjUzN30.12MycLBd_SpBwFz52alQFtIuWiguAunqh4AX7TbIkkk";
  const BACKEND_BASE = "https://api.lightfull.ai";

  const sb = window.supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY, {
    auth: { persistSession:true, autoRefreshToken:true, detectSessionInUrl:true }
  });
  window.sb = sb;

  const $ = (id)=>document.getElementById(id);
  const btns = Array.from(document.querySelectorAll('[data-tab]'));

  function mark(tab){
    btns.forEach(b => b.classList.toggle("active", b.dataset.tab === tab));
  }

  function setActiveByUrl(){
    const href = location.href.toLowerCase();
    const p = location.pathname.toLowerCase();

    if (href.includes("/lf-editor")) return mark("editor");
    if (p.includes("/feed")) return mark("feed");

    if (p.includes("node_studio")) return mark("node_studio");

    if (p.includes("cinema_lab") ||
        p.includes("cinema_animation") ||
        p.includes("cinema_shot") ||
        p.includes("cinema_character")) {
      return mark("cinema_lab");
    }

    if (p.includes("product_creation")) return mark("product");
    if (p.includes("chatgpt")) return mark("chatgpt");
    if (p.includes("library")) return mark("library");

    if (p.includes("/video")) return mark("video");
    if (p.includes("/image")) return mark("image");

    if (p.includes("nano")) return mark("image");
    if (p.includes("kling")) return mark("video");

    if (p === "/" || p.includes("flow")) return mark("flow");
    return mark("flow");
  }

  function go(tab){
    if (tab === "video")       return location.href = "https://lightfull.ai/video";
    if (tab === "image")       return location.href = "https://lightfull.ai/image";
    if (tab === "cinema_lab")  return location.href = "https://lightfull.ai/cinema_lab";
    if (tab === "node_studio") return location.href = "https://lightfull.ai/node_studio";
    if (tab === "flow")        return location.href = BASE + "/flow";
    if (tab === "product")     return location.href = "https://lightfull.ai/product_creation";
    if (tab === "editor")      return location.href = EDITOR_URL;
    if (tab === "feed")        return location.href = FEED_URL;
    if (tab === "library")     return location.href = BASE + "/library";
    if (tab === "chatgpt")     return location.href = BASE + "/chatgpt";
  }

  $("lfhdr-brand").addEventListener("click", ()=>go("flow"));
  btns.forEach(b => b.addEventListener("click", ()=>go(b.dataset.tab)));

  // dropdown
  const dd = $("lfhdr-dd");
  $("lfhdr-avatar").addEventListener("click",(e)=>{ e.stopPropagation(); dd.classList.toggle("show"); });
  document.addEventListener("click", ()=>dd.classList.remove("show"));

  // profile editor link
  $("lfhdr-profile-link").addEventListener("click", () => {
    dd.classList.remove("show");
    location.href = PROFILE_URL;
  });

  async function refreshMeAndUI(){
    try{
      const { data } = await sb.auth.getSession();
      const s = data?.session;
      if (!s?.user?.id || !s?.access_token) return null;

      const r = await fetch(BACKEND_BASE + "/api/me", {
        headers: { Authorization: "Bearer " + s.access_token }
      });
      const me = await r.json().catch(()=>({}));

      if (r.ok && me && me.ok !== false) {
        $("lfhdr-credits").textContent = me.credits ?? 0;
      }
      return me;
    } catch(e){
      const msg = String(e?.message || e);
      if (msg.toLowerCase().includes("abort") || e?.name === "AbortError") return null;
      console.warn("refreshMeAndUI failed:", e);
      return null;
    }
  }

  async function fetchMyPublicProfile(accessToken){
    // tries to read profile from backend (auth)
    try{
      const r = await fetch(BACKEND_BASE + "/api/profile_public", {
        method: "GET",
        headers: { Authorization: "Bearer " + accessToken }
      });
      const j = await r.json().catch(()=> ({}));
      if(!r.ok) return null;
      return j?.profile || null;
    }catch(e){
      return null;
    }
  }

  function escapeHtml(s){
    return String(s||"")
      .replaceAll("&","&amp;").replaceAll("<","&lt;").replaceAll(">","&gt;")
      .replaceAll('"',"&quot;").replaceAll("'","&#039;");
  }

  function renderAvatarInto(el, avatar_type, avatar_url, avatar_emoji, fallbackLetter){
    const t = String(avatar_type || "image").toLowerCase();
    const em = (avatar_emoji || "").trim();
    const url = (avatar_url || "").trim();

    el.classList.remove("emoji");
    el.innerHTML = "";

    if(t === "emoji" && em){
      el.classList.add("emoji");
      el.innerHTML = `<span aria-label="avatar emoji">${escapeHtml(em)}</span>`;
      return;
    }

    if(url){
      el.innerHTML = `<img src="${escapeHtml(url)}" alt="" />`;
      return;
    }

    if(fallbackLetter){
      el.textContent = String(fallbackLetter).slice(0,1).toUpperCase();
    }
  }

  function setAvatarEl(el, avatar_type, avatar_url, avatar_emoji, fallbackLetter){
    renderAvatarInto(el, avatar_type, avatar_url, avatar_emoji, fallbackLetter);
  }

  async function initProfile(){
    const $avatarBtn = $("lfhdr-avatar");
    const $userCard = $("lfhdr-usercard");
    const $userDiv = $("lfhdr-userdiv");

    const $name = $("lfhdr-name");
    const $uname = $("lfhdr-username");
    const $email = $("lfhdr-email");

    const $ddAva = $("lfhdr-dd-ava");

    const $credits = $("lfhdr-credits");
    const $logout = $("lfhdr-logout");
    const $login = $("lfhdr-login");
    const $promo = $("lfhdr-promo");
    const $profileLink = $("lfhdr-profile-link");

    try{
      const { data } = await sb.auth.getSession();
      const s = data?.session;

      if (!s?.user || !s?.access_token) {
        // Guest
        setAvatarEl($avatarBtn, "image", "", "", "?");
        $credits.textContent = "—";

        $userCard.style.display = "none";
        $userDiv.style.display = "none";

        $promo.style.display = "none";
        $profileLink.style.display = "none";
        $logout.style.display = "none";

        $login.style.display = "flex";
        $login.onclick = ()=>location.href = BASE + "/login";
        return;
      }

      $promo.style.display = "flex";
      $profileLink.style.display = "flex";
      $logout.style.display = "flex";
      $login.style.display = "none";

      // email always
      const email = s.user.email || "—";
      $email.textContent = email;

      // fetch credits
      await refreshMeAndUI();

      // fetch profile public data
      const p = await fetchMyPublicProfile(s.access_token);

      const displayName = (p?.display_name || "").trim() || "User";
      const username = (p?.username || "").trim(); // may be empty if not set yet
      const avatarType = p?.avatar_type || "image";
      const avatarUrl  = (p?.avatar_url || "").trim();
      const avatarEmoji = (p?.avatar_emoji || "").trim();

      $name.textContent = displayName;
      $uname.textContent = username ? ("@" + username) : "@—";

      setAvatarEl($avatarBtn, avatarType, avatarUrl, avatarEmoji, email.slice(0,1));
      setAvatarEl($ddAva, avatarType, avatarUrl, avatarEmoji, email.slice(0,1));

      $userCard.style.display = "flex";
      $userDiv.style.display = "block";

      // click to public profile (avatar + name block clickable)
      const publicUrl = username ? ARTIST_URL(username) : PROFILE_URL; // fallback to editor profile if no username
      $userCard.onclick = () => { dd.classList.remove("show"); location.href = publicUrl; };

    } catch(e){
      console.warn("initProfile failed:", e);
    }
  }

  $("lfhdr-logout").addEventListener("click", async ()=>{
    try{ await sb.auth.signOut(); }catch(e){}
    location.href = BASE + "/login";
  });

  sb.auth.onAuthStateChange(() => { initProfile(); });

  setActiveByUrl();
  initProfile();
  window.addEventListener("hashchange", setActiveByUrl);
})();
</script>
