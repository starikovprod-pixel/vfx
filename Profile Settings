<style>
  #lf-profile *{ box-sizing:border-box; }
  #lf-profile{
    background:var(--bg-body,#050505);
    color:#fff;
    font-family:Inter,system-ui,-apple-system,Segoe UI,Roboto,Arial,sans-serif;
    min-height: calc(100vh - 74px);
  }
  #lf-profile .wrap{ max-width: 980px; margin:0 auto; padding: 26px 18px 50px; }
  #lf-profile .top{
    display:flex; justify-content:space-between; align-items:center; gap:16px; flex-wrap:wrap;
    border-bottom:1px solid rgba(255,255,255,0.10); padding-bottom:18px; margin-bottom:18px;
  }
  #lf-profile h1{ margin:0; font-size:34px; font-weight:900; letter-spacing:-.6px; }
  #lf-profile .sub{ margin-top:6px; color:rgba(255,255,255,0.55); font-size:13px; }

  .card{
    background: rgba(255,255,255,0.04);
    border:1px solid rgba(255,255,255,0.10);
    border-radius: 18px;
    padding: 18px;
  }

  .grid{
    display:grid;
    grid-template-columns: 1fr 1fr;
    gap:14px;
  }
  @media(max-width: 860px){ .grid{ grid-template-columns:1fr; } }

  .field{ display:flex; flex-direction:column; gap:8px; }
  .label{ font-size:12px; font-weight:900; color:rgba(255,255,255,0.70); letter-spacing:.2px; }

  .input, .textarea{
    width:100%;
    border-radius: 14px;
    padding: 12px 12px;
    background: rgba(255,255,255,0.05);
    border:1px solid rgba(255,255,255,0.12);
    color:#fff;
    font-size:14px;
  }
  .input:focus, .textarea:focus{ border-color: rgba(255,255,255,0.25); }
  .textarea{ min-height: 110px; resize: vertical; }

  .preview{
    display:flex; gap:14px; align-items:center; margin-bottom:14px;
  }
  .avatar{
    width:56px; height:56px; border-radius:50%;
    background: rgba(255,255,255,0.08);
    border:1px solid rgba(255,255,255,0.12);
    overflow:hidden;
    flex:0 0 auto;
  }
  .avatar img{ width:100%; height:100%; object-fit:cover; display:block; }
  .pname{ font-weight:900; font-size:16px; }
  .puser{ color:rgba(255,255,255,0.55); font-size:13px; margin-top:2px; }

  /* top actions */
  .actions{ display:flex; gap:10px; align-items:center; }
  .iconbtn{
    height:42px;
    padding: 0 14px;
    border-radius: 14px;
    border:1px solid rgba(255,255,255,0.12);
    background: rgba(255,255,255,0.06);
    color:#fff;
    cursor:pointer;
    display:flex;
    align-items:center;
    gap:10px;
    font-weight:900;
    transition:.15s;
  }
  .iconbtn:hover{ background: rgba(255,255,255,0.10); border-color: rgba(255,255,255,0.22); }
  .iconbtn.primary{
    background:#fff;
    color:#000;
    border:none;
  }
  .iconbtn.primary:hover{ background:#ddd; }
  .iconbtn svg{ width:16px; height:16px; display:block; opacity:.95; }

  /* file upload */
  .uploadRow{
    display:flex;
    gap:10px;
    align-items:center;
  }
  .fileHidden{ display:none; }
  .uploadBtn{
    flex:0 0 auto;
    height:42px;
    padding: 0 14px;
    border-radius: 14px;
    border:1px solid rgba(255,255,255,0.12);
    background: rgba(255,255,255,0.06);
    color:#fff;
    cursor:pointer;
    display:flex;
    align-items:center;
    gap:10px;
    font-weight:900;
    transition:.15s;
  }
  .uploadBtn:hover{ background: rgba(255,255,255,0.10); border-color: rgba(255,255,255,0.22); }
  .uploadMeta{
    color: rgba(255,255,255,0.55);
    font-size:12px;
    white-space:nowrap;
    overflow:hidden;
    text-overflow:ellipsis;
    flex:1;
  }

  /* status */
  .status{
    margin-top:12px;
    padding: 10px 12px;
    border-radius: 14px;
    border:1px solid rgba(255,255,255,0.10);
    background: rgba(0,0,0,0.25);
    font-size:13px;
    color: rgba(255,255,255,0.78);
    display:none;
  }
  .status.err{ border-color: rgba(255,70,90,0.35); color:#ff98a2; background: rgba(255,70,90,0.08); }
  .status.ok{ border-color: rgba(57,255,20,0.25); color:#b7ffb0; background: rgba(57,255,20,0.08); }
</style>

<div id="lf-profile">
  <div class="wrap">
    <div class="top">
      <div>
        <h1>Profile</h1>
        <div class="sub">Username, avatar, links.</div>
      </div>

      <div class="actions">
        <button class="iconbtn" id="btn-open-public" style="display:none;" title="Open public profile">
          <svg viewBox="0 0 24 24" fill="none">
            <path d="M14 3h7v7" stroke="currentColor" stroke-width="2" stroke-linecap="round"/>
            <path d="M10 14L21 3" stroke="currentColor" stroke-width="2" stroke-linecap="round"/>
            <path d="M21 14v5a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V7a2 2 0 0 1 2-2h5" stroke="currentColor" stroke-width="2" stroke-linecap="round"/>
          </svg>
          Public
        </button>

        <button class="iconbtn primary" id="btn-save" title="Save">
          <svg viewBox="0 0 24 24" fill="none">
            <path d="M5 21h14a2 2 0 0 0 2-2V8l-3-3H5a2 2 0 0 0-2 2v12a2 2 0 0 0 2 2Z" stroke="currentColor" stroke-width="2" stroke-linejoin="round"/>
            <path d="M7 21v-8h10v8" stroke="currentColor" stroke-width="2" stroke-linejoin="round"/>
            <path d="M7 5v4h8" stroke="currentColor" stroke-width="2" stroke-linecap="round"/>
          </svg>
          Save
        </button>
      </div>
    </div>

    <div class="card">
      <div class="preview">
        <div class="avatar" id="pv-avatar"></div>
        <div>
          <div class="pname" id="pv-name">—</div>
          <div class="puser" id="pv-user">@—</div>
        </div>
      </div>

      <div class="grid">
        <div class="field">
          <div class="label">Username</div>
          <input class="input" id="f-username" placeholder="starikov" autocomplete="off" />
        </div>

        <div class="field">
          <div class="label">Display name</div>
          <input class="input" id="f-display" placeholder="Alex Starikov" />
        </div>

        <div class="field">
          <div class="label">Avatar</div>
          <div class="uploadRow">
            <input class="fileHidden" type="file" id="f-avatar-file" accept="image/*" />
            <button class="uploadBtn" id="btn-pick-avatar" type="button">
              <svg viewBox="0 0 24 24" fill="none">
                <path d="M12 5v10" stroke="currentColor" stroke-width="2" stroke-linecap="round"/>
                <path (d="M7 10l5-5 5 5") stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
                <path d="M5 19h14" stroke="currentColor" stroke-width="2" stroke-linecap="round"/>
              </svg>
              Upload
            </button>
            <div class="uploadMeta" id="avatar-meta">JPG/PNG/WebP • max 5MB</div>
          </div>
        </div>

        <div class="field">
          <div class="label">Bio</div>
          <textarea class="textarea" id="f-bio" placeholder="VFX / 3D / Lightfull"></textarea>
        </div>

        <div class="field">
          <div class="label">YouTube</div>
          <input class="input" id="f-yt" placeholder="https://youtube.com/..." />
        </div>

        <div class="field">
          <div class="label">Website</div>
          <input class="input" id="f-site" placeholder="https://..." />
        </div>
      </div>

      <div class="status" id="status"></div>
    </div>
  </div>
</div>

<script>
(() => {
  const BACKEND = "https://api.lightfull.ai";
  const ENDPOINT = "/api/profile_public";

  const $status = document.getElementById("status");
  const $btnSave = document.getElementById("btn-save");
  const $btnOpenPublic = document.getElementById("btn-open-public");

  const $u = document.getElementById("f-username");
  const $d = document.getElementById("f-display");
  const $b = document.getElementById("f-bio");
  const $yt = document.getElementById("f-yt");
  const $site = document.getElementById("f-site");

  const $pvAvatar = document.getElementById("pv-avatar");
  const $pvName = document.getElementById("pv-name");
  const $pvUser = document.getElementById("pv-user");

  const $avatarFile = document.getElementById("f-avatar-file");
  const $btnPickAvatar = document.getElementById("btn-pick-avatar");
  const $avatarMeta = document.getElementById("avatar-meta");

  let avatarUrl = "";
  let autosaveTimer = null;
  let saving = false;
  let dirty = false;

  function showStatus(msg, type){
    $status.style.display = msg ? "block" : "none";
    $status.className = "status" + (type ? (" " + type) : "");
    $status.textContent = msg || "";
  }

  function updatePreview(){
    const username = ($u.value || "").trim();
    const display = ($d.value || "").trim();
    const avatar = (avatarUrl || "").trim();

    $pvName.textContent = display || "—";
    $pvUser.textContent = username ? ("@" + username) : "@—";
    $pvAvatar.innerHTML = avatar ? `<img src="${avatar}" />` : "";

    $btnOpenPublic.style.display = username ? "inline-flex" : "none";
  }

  async function getAccessToken(){
    if(!window.sb) return null;
    const { data } = await window.sb.auth.getSession();
    return data?.session?.access_token || null;
  }

  async function api(method, body){
    const token = await getAccessToken();
    if(!token) throw new Error("Login required");
    const res = await fetch(BACKEND + ENDPOINT, {
      method,
      headers: {
        "Content-Type":"application/json",
        "Authorization":"Bearer " + token
      },
      body: body ? JSON.stringify(body) : undefined
    });
    const j = await res.json().catch(()=> ({}));
    if(!res.ok) throw new Error(j?.error || j?.details || ("HTTP " + res.status));
    return j;
  }

  function buildBody(){
    return {
      username: ($u.value || "").trim(),
      display_name: ($d.value || "").trim(),
      avatar_url: avatarUrl,
      bio: ($b.value || "").trim(),
      links: {
        youtube: ($yt.value || "").trim(),
        site: ($site.value || "").trim()
      }
    };
  }

  function scheduleAutosave(){
    dirty = true;
    if(autosaveTimer) clearTimeout(autosaveTimer);
    autosaveTimer = setTimeout(() => saveProfile({ silent:true }), 700);
  }

  async function saveProfile({ silent=false } = {}){
    if(saving) return;
    if(!dirty && silent) return;

    saving = true;
    $btnSave.disabled = true;
    if(!silent) showStatus("Saving...", "");
    else showStatus("Saving…", "");

    try{
      const body = buildBody();
      const j = await api("POST", body);
      const p = j?.profile;

      // sync from backend (if it normalizes)
      $u.value = p?.username ?? body.username;
      $d.value = p?.display_name ?? body.display_name;
      avatarUrl = p?.avatar_url ?? avatarUrl;

      dirty = false;
      updatePreview();
      showStatus("Saved", "ok");
      setTimeout(()=> showStatus("", ""), 900);

    }catch(e){
      showStatus(e.message, "err");
    }finally{
      saving = false;
      $btnSave.disabled = false;
    }
  }

  async function uploadAvatar(){
    if(!window.sb) throw new Error("Supabase not found");

    const { data } = await window.sb.auth.getSession();
    const userId = data?.session?.user?.id;
    if(!userId) throw new Error("Login required");

    const file = $avatarFile.files?.[0];
    if(!file) return;

    if(file.size > 5 * 1024 * 1024) throw new Error("Max 5MB");

    const ext = (file.name.split(".").pop() || "png").toLowerCase();
    const safeExt = ["png","jpg","jpeg","webp"].includes(ext) ? ext : "png";
    const path = `${userId}/avatar.${safeExt}`;

    showStatus("Uploading…", "");

    const up = await window.sb.storage
      .from("avatars")
      .upload(path, file, { upsert:true, contentType:file.type, cacheControl:"3600" });

    if(up.error) throw new Error(up.error.message);

    const { data: pub } = window.sb.storage.from("avatars").getPublicUrl(path);
    if(!pub?.publicUrl) throw new Error("No public URL");

    // сохраняем чистый URL в профиль, а для превью добавляем cache-bust
    avatarUrl = pub.publicUrl;
    updatePreview();
    $pvAvatar.innerHTML = `<img src="${avatarUrl}?v=${Date.now()}" />`;

    // автосейв после аплоада
    dirty = true;
    await saveProfile({ silent:true });

    showStatus("Avatar saved", "ok");
    setTimeout(()=> showStatus("", ""), 900);
  }

  async function load(){
    try{
      showStatus("Loading…", "");
      const j = await api("GET");
      const p = j?.profile || null;

      $u.value = p?.username || "";
      $d.value = p?.display_name || "";
      avatarUrl = p?.avatar_url || "";
      $b.value = p?.bio || "";
      $yt.value = p?.links?.youtube || "";
      $site.value = p?.links?.site || "";

      dirty = false;
      updatePreview();
      showStatus("", "");
    }catch(e){
      showStatus(e.message, "err");
    }
  }

  // events
  $btnSave.onclick = () => saveProfile({ silent:false });

  [$u,$d,$b,$yt,$site].forEach(el => {
    el.addEventListener("input", () => {
      updatePreview();
      scheduleAutosave();
    });
  });

  $btnPickAvatar.onclick = () => $avatarFile.click();

  $avatarFile.addEventListener("change", async () => {
    const file = $avatarFile.files?.[0];
    $avatarMeta.textContent = file ? (file.name + " • uploading…") : "JPG/PNG/WebP • max 5MB";
    try{
      await uploadAvatar();
      $avatarMeta.textContent = "Uploaded";
    }catch(e){
      $avatarMeta.textContent = "Upload failed";
      showStatus(e.message, "err");
    }
  });

  $btnOpenPublic.onclick = () => {
    const username = ($u.value || "").trim();
    if(!username) return;
    window.open("/u?username=" + encodeURIComponent(username), "_blank");
  };

  load();
})();
</script>

