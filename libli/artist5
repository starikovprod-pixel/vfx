<style>
  :root{
    --bg-body:#050505;
    --bg-card:#181818;
    --bg-modal:#1f1f1f;
    --border:#2b2b2b;
    --text:#fff;
    --muted:rgba(255,255,255,0.65);

    --glass: rgba(255,255,255,0.06);
    --glass2: rgba(255,255,255,0.10);
    --glassBorder: rgba(255,255,255,0.12);
    --shadow: 0 50px 100px -20px rgba(0,0,0,0.7);

    --blue:#6ea8ff;
    --violet:#7c5cff;
    --good:#39ff14;
    --danger:#ff465a;
  }

  .t-tilda-label, #tilda-copyright, #tilda-copy { display:none !important; }
  #lf-u *{ box-sizing:border-box; }
  /* Chrome/Edge */
  *::-webkit-scrollbar{ width:10px; height:10px; }
  *::-webkit-scrollbar-track{ background: rgba(255,255,255,0.04); border-radius:999px; }
  *::-webkit-scrollbar-thumb{ background: rgba(255,255,255,0.14); border-radius:999px; border:2px solid rgba(0,0,0,0.0); }
  *::-webkit-scrollbar-thumb:hover{ background: rgba(255,255,255,0.22); }

  /* Firefox */
  *{ scrollbar-width: thin; scrollbar-color: rgba(255,255,255,0.18) rgba(255,255,255,0.05); }
  #lf-u{
    background:var(--bg-body);
    color:var(--text);
    font-family:Inter,system-ui,-apple-system,Segoe UI,Roboto,Arial,sans-serif;
    min-height: calc(100vh - 74px);
  }
  #lf-u .wrap{ max-width:1400px; margin:0 auto; padding: 26px 18px 60px; }

  .top{
  position:relative;
  padding-top: 10px;
}

.pcover{
  position:relative;
  width:100%;
  height:170px;
  border-radius:22px;
  overflow:hidden;
  border:1px solid rgba(255,255,255,0.10);
  background: rgba(255,255,255,0.03);
  margin-bottom:-56px;
}

.pcover-bg{
  position:absolute; inset:0;
}
.pcover-bg img{
  position:absolute; inset:0;
  width:100%; height:100%;
  object-fit:cover;
  object-position:50% 50%;
  transform:scale(1.05);
}
.pcover-bg::after{
  content:"";
  position:absolute; inset:0;
  /* ✅ снизу темнее, вверх прозрачнее */
  background: linear-gradient(to top,
    rgba(0,0,0,.55) 0%,
    rgba(0,0,0,.22) 45%,
    rgba(0,0,0,.06) 100%);
}

.pcover-edit, .pcover-del{
  position:absolute;
  top:12px;
  width:40px; height:40px;
  border-radius:14px;
  border:1px solid rgba(255,255,255,0.18);
  background: rgba(0,0,0,0.45);
  color:#fff;
  cursor:pointer;
  font-weight:950;
  display:flex; align-items:center; justify-content:center;
  z-index:5;
}
.pcover-edit{ right:12px; }
.pcover-del{ right:58px; }
.pcover-edit:hover, .pcover-del:hover{ background:#fff; color:#000; }

.phead{
  position:relative;
  display:flex;
  gap:14px;
  align-items:center;
  margin-top:-26px;
  margin-bottom:8px;
}
.pava{
  width:76px; height:76px;
  border-radius:50%;
  border:2px solid rgba(255,255,255,0.10);
  background: rgba(255,255,255,0.06);
  overflow:hidden;
  flex:0 0 auto;
}
.pava img{ width:100%; height:100%; object-fit:cover; display:block; }
  .avatar.emoji,
  .pava.emoji{
    display:flex; align-items:center; justify-content:center; line-height:1; user-select:none;
    font-family:"Apple Color Emoji","Segoe UI Emoji","Segoe UI Symbol","Noto Color Emoji",sans-serif;
  }
  .avatar.emoji{ font-size:18px; }
  .pava.emoji{ font-size:34px; }

  .pname{ font-weight:900; font-size:22px; letter-spacing:-.2px; display:flex; align-items:center; gap:8px; }
  .puser{ color:var(--muted); margin-top:2px; font-size:13px; }
  .pbio{ margin-top:10px; color: rgba(255,255,255,0.78); font-size:13px; max-width:720px; line-height:1.4; }
  .fcnt{ display:inline-flex; align-items:center; gap:8px; margin-top:4px; padding:5px 10px; border-radius:999px; background: rgba(255,255,255,0.06); border: 1px solid rgba(255,255,255,0.10); color: rgba(255,255,255,0.85); font-size:12px; font-weight:900; }
  .fcnt span{ color: rgba(255,255,255,0.55); font-weight:800; }
  .fcnt b{ color:#fff; }

  .vfy{
    width:16px;
    height:16px;
    display:inline-flex;
    align-items:center;
    justify-content:center;
    color:var(--blue);
    flex:0 0 auto;
    transform:none;
    vertical-align:middle;
  }
  .vfy svg{
    width:16px;
    height:16px;
    display:block;
    fill:currentColor;
  }
  .pname .vfy{ width:20px; height:20px; }
  .pname .vfy svg{ width:20px; height:20px; }
  .vfy-tip{ position:fixed; z-index:20050; display:none; max-width:220px; background:#0b0b0b; color:#fff; border:1px solid rgba(255,255,255,0.15); border-radius:10px; padding:8px 10px; font-size:12px; line-height:1.3; pointer-events:none; }
  #fsTip{
    white-space:pre-line;
    max-width:380px;
    line-height:1.35;
  }

  .links{ display:flex; gap:8px; flex-wrap:wrap; margin-top:10px; }
  .chip{
    display:inline-flex; align-items:center; gap:8px; padding: 8px 10px;
    border-radius: 999px; background: rgba(255,255,255,0.06);
    border: 1px solid rgba(255,255,255,0.12); color:#fff; text-decoration:none;
    font-weight:800; font-size:12px; transition:.15s;
  }
  .chip:hover{ background: rgba(255,255,255,0.10); border-color: rgba(255,255,255,0.22); }
  .chip svg{ width:14px; height:14px; display:block; }

  .controls{ display:flex; gap:10px; flex-wrap:wrap; align-items:center; width:100%; justify-content:space-between; }
  .p-follow{
    height:38px; padding:0 14px; border-radius:999px; border:1px solid rgba(255,255,255,0.12);
    background: rgba(255,255,255,0.06); color:#fff; cursor:pointer; font-weight:900; transition:.15s;
    display:inline-flex; align-items:center; justify-content:center; line-height:38px; margin:0;
  }
  .p-follow:hover{ background: rgba(255,255,255,0.10); border-color: rgba(255,255,255,0.22); }
  .p-follow.on{ border-color: rgba(110,168,255,0.45); background: rgba(110,168,255,0.18); }

  .seg{
    display:flex; gap:6px; padding:6px;
    background: rgba(255,255,255,0.03);
    border:1px solid rgba(255,255,255,0.08);
    border-radius:999px;
  }
  .seg button{
    border:0; background: transparent; color: rgba(255,255,255,0.75);
    padding: 8px 12px; border-radius:999px; cursor:pointer;
    font-weight:900; font-size:13px; transition:.15s; white-space:nowrap;
  }
  .seg button:hover{ background: rgba(255,255,255,0.06); color:#fff; }
  .seg button.active{ background:#fff; color:#000; }

  .pill{
    display:flex; gap:8px; align-items:center; padding: 8px 12px;
    border-radius: 999px; background: rgba(255,255,255,0.03);
    border:1px solid rgba(255,255,255,0.08); color: rgba(255,255,255,0.85);
    font-size:13px; font-weight:800;
  }
  .pill select{
    background: rgba(15,15,15,0.95);
    color:#fff;
    border:1px solid rgba(255,255,255,0.12);
    border-radius: 12px;
    padding: 8px 10px;
    appearance: none;
    font-weight:900;
    outline:none;
    cursor:pointer;
  }
  .pill select option{ background: #0f0f0f; color:#fff; }

  .tabs-row{ display:flex; align-items:center; justify-content:flex-end; gap:12px; flex-wrap:wrap; }
  .tab-actions{ display:flex; gap:10px; align-items:center; flex-wrap:wrap; }
  .btn-primary{
    height:38px; padding:0 14px; border-radius:999px; border:1px solid rgba(255,255,255,0.12);
    background:#fff; color:#000; cursor:pointer; font-weight:950; transition:.15s;
    display:inline-flex; align-items:center; justify-content:center; gap:8px;
  }
  .btn-primary:hover{ transform: translateY(-1px); }
  .btn-ghost{
    height:38px; padding:0 14px; border-radius:999px; border:1px solid rgba(255,255,255,0.12);
    background: rgba(255,255,255,0.06); color:#fff; cursor:pointer; font-weight:900; transition:.15s;
    display:inline-flex; align-items:center; justify-content:center; gap:8px;
  }
  .btn-ghost:hover{ background: rgba(255,255,255,0.10); border-color: rgba(255,255,255,0.22); }

  .grid-wrap{ position:relative; min-height:240px; }
  .tab-pane{
    position:absolute;
    inset:0;
    opacity:0;
    transform: translateY(6px);
    pointer-events:none;
    transition: opacity .18s ease, transform .18s ease;
  }
  .tab-pane.active{ opacity:1; transform:none; pointer-events:auto; position:relative; }

  .loader{ display:none; justify-content:center; color: rgba(255,255,255,0.55); padding: 18px 0 0; font-size: 13px; }
  .empty{ padding:40px; text-align:center; color: rgba(255,255,255,0.55); border: 1px dashed rgba(255,255,255,0.18); border-radius: 18px; background: rgba(255,255,255,0.02); }

  /* отступ между ссылками и табами */
  #p-links{ margin-bottom: 18px; }

  /* отступ между шапкой/метой и контролами */
  .controls{ margin-top: 16px; }

  /* отступ между табами и сетками */
  .grid-wrap{ margin-top: 16px; }

  .panel-sep{
    height:1px;
    width:100%;
    background: rgba(255,255,255,0.10);
    margin: 14px 0 18px;
  }

  /* чтобы табы не липли к контенту */
  .tabs-row{ margin-bottom: 14px; }

  /* POSTS FEED */
  .feed{
    width: min(860px, 100%);
    margin:0;
    display:flex;
    flex-direction:column;
    gap:0;
  }
  .feed-sep{
    height:1px;
    background: rgba(255,255,255,0.10);
    margin: 18px 0;
  }
  .post{
    width:100%;
    display:flex;
    flex-direction:column;
    gap:12px;
  }
  .post-head{
    display:flex; gap:10px; align-items:center;
  }
  .avatar{
    width:36px; height:36px; border-radius:50%;
    background: rgba(255,255,255,0.12);
    border:1px solid rgba(255,255,255,0.12);
    overflow:hidden; flex:0 0 auto;
  }
  .avatar img{ width:100%; height:100%; object-fit:cover; display:block; }
  .post-meta{ min-width:0; display:flex; flex-direction:column; gap:2px; }
  .post-name{
    font-weight:950; font-size:14px;
    display:flex; align-items:center; gap:6px;
  }
  .post-time{ font-size:12px; color:rgba(255,255,255,0.6); }
  .post-body{
    font-size:15px;
    line-height:1.5;
    color: rgba(255,255,255,0.92);
    white-space:pre-wrap;
    word-break:break-word;
  }

  /* Collection embed inside post */
  .embed-collection{
    margin-top:10px;
    border-radius:18px;
    border:1px solid rgba(255,255,255,0.12);
    background: rgba(255,255,255,0.04);
    overflow:hidden;
    cursor:pointer;
    position:relative;
  }
  .embed-bg{
    position:absolute; inset:0;
    background:#000;
  }
  .embed-bg img,
  .embed-bg video{
    position:absolute; inset:0;
    width:100%; height:100%;
    object-fit:cover;
    opacity:0;
    transition: opacity .6s ease;
  }
  .embed-bg img.on,
  .embed-bg video.on{ opacity:0.85; }
  .embed-overlay{
    position:relative;
    padding:16px;
    backdrop-filter: none;
    background: linear-gradient(to top, rgba(0,0,0,0.70), rgba(0,0,0,0.10));
  }
  .embed-title{ font-weight:950; font-size:14px; }
  .embed-desc{
    margin-top:6px;
    font-size:13px;
    color: rgba(255,255,255,0.75);
    display:-webkit-box;
    -webkit-line-clamp:2;
    -webkit-box-orient:vertical;
    overflow:hidden;
  }

  /* Slider for post media (big) */
  .pslider{
    width:fit-content;
    max-width:100%;
    margin:0 auto;
    background:transparent;
    border:0;
    position:relative;
  }
  .pslide{
    width:fit-content;
    height:auto;
    max-width:100%;
    background:transparent;
  }
  .pslide img, .pslide video{
    position:static;
    display:block;
    width:auto;
    height:auto;
    max-width:100%;
    max-height:420px;
    object-fit:contain;
    background:transparent;
    margin:0 auto;
    border-radius:22px;
    border:1px solid rgba(255,255,255,0.10);
  }
  .pnav{
    position:absolute;
    top:50%;
    transform: translateY(-50%);
    width:44px; height:44px;
    border-radius:999px;
    border:1px solid rgba(255,255,255,0.18);
    background: rgba(0,0,0,0.45);
    color:#fff;
    cursor:pointer;
    display:flex; align-items:center; justify-content:center;
    backdrop-filter: blur(6px);
    transition:.15s;
    z-index:2;
  }
  .pnav:hover{ background: rgba(255,255,255,0.12); border-color: rgba(255,255,255,0.28); }
  .pslider .pnav, .pslider .pdots{ position:absolute; }
  .pnav.prev{ left:10px; top:50%; transform: translateY(-50%); }
  .pnav.next{ right:10px; top:50%; transform: translateY(-50%); }
  .pdots{
    left:50%;
    transform: translateX(-50%);
    bottom:10px;
    display:flex; gap:6px;
    padding:7px 10px;
    border-radius:999px;
    background: rgba(0,0,0,0.45);
    border:1px solid rgba(255,255,255,0.14);
    backdrop-filter: blur(6px);
    z-index:2;
  }
  .pdots button{
    width:7px; height:7px; border-radius:99px;
    border:0; cursor:pointer;
    background: rgba(255,255,255,0.35);
  }
  .pdots button.on{ background:#fff; }

  .post-actions{
    display:flex;
    gap:10px;
    flex-wrap:wrap;
    align-items:center;
  }
  .mini{
    padding:8px 10px;
    border-radius:999px;
    background: rgba(255,255,255,0.06);
    border: 1px solid rgba(255,255,255,0.10);
    color:#fff;
    cursor:pointer;
    font-weight:900;
    font-size:12px;
    display:inline-flex;
    align-items:center;
    gap:8px;
    transition:.15s;
  }
  .mini:hover{ background: rgba(255,255,255,0.10); border-color: rgba(255,255,255,0.22); }
  .mini.on.like{ color:var(--danger); border-color: rgba(255,70,90,0.45); background: rgba(255,70,90,0.14); }
  .mini.on.save{ color:#2b6cff; border-color: rgba(43,108,255,0.45); background: rgba(43,108,255,0.18); }
  .mini svg{ width:16px; height:16px; stroke: currentColor; fill:none; stroke-width:2; }
  .mini.danger{ color:#ffd3d8; border-color: rgba(255,70,90,0.35); }

  .cic{
    width:auto;
    height:28px;
    padding:0 10px;
    border-radius:999px;
    border:1px solid rgba(255,255,255,0.10);
    background: rgba(255,255,255,0.06);
    color:#fff;
    display:inline-flex;
    align-items:center;
    gap:6px;
    cursor:pointer;
    font-weight:900;
    font-size:12px;
  }
  .cic svg{ width:14px; height:14px; stroke:currentColor; fill:none; stroke-width:2; }
  .cic.on{ color: var(--danger); border-color: rgba(255,70,90,0.45); background: rgba(255,70,90,0.14); }

  .cact{
    width:30px;
    height:30px;
    border-radius:10px;
    border:1px solid rgba(255,255,255,0.12);
    background: rgba(255,255,255,0.06);
    display:inline-flex;
    align-items:center;
    justify-content:center;
    cursor:pointer;
    color:#fff;
  }
  .cact:hover{ background: rgba(255,255,255,0.10); border-color: rgba(255,255,255,0.22); }
  .cact svg{ width:16px; height:16px; stroke:#fff; fill:none; stroke-width:2; }
  .cact.danger{ color:#ffd3d8; border-color: rgba(255,70,90,0.35); }
  .cact.danger svg{ stroke:#ffd3d8; }
  .cact.danger:hover{ border-color: rgba(255,70,90,0.55); }

  /* Comments block under post */
  .pc{
    border-top:1px solid rgba(255,255,255,0.10);
    padding-top:12px;
    margin-top:6px;
    display:flex;
    flex-direction:column;
    gap:10px;
  }
  .pc-list{
    display:flex;
    flex-direction:column;
    gap:10px;
    max-height: 320px;
    overflow:auto;
    overflow-x:hidden;
    padding-right:6px;
  }
  .pc-item{
    display:flex;
    gap:10px;
    align-items:flex-start;
  }
  .pc-bubble{
    flex:1;
    max-width:100%;
    border-radius:14px;
    border:1px solid rgba(255,255,255,0.10);
    background: rgba(255,255,255,0.05);
    padding:8px 12px;
  }
  .pc-top{
    display:flex; gap:8px; align-items:center; flex-wrap:wrap;
    min-width:0;
    margin-bottom:4px;
  }
  .pc-footer{
    margin-top:6px;
    display:flex;
    align-items:center;
    justify-content:space-between;
    gap:10px;
  }
  .pc-actions{
    display:flex;
    gap:8px;
    align-items:center;
    flex:0 0 auto;
  }
  .pc-name{ font-weight:950; font-size:12px; color:#fff; text-decoration:none; display:flex; gap:6px; align-items:center; min-width:0; max-width:70%; }
  .pc-time{ font-size:11px; color:rgba(255,255,255,0.55); transform:none; }
  .pc-body{ font-size:13px; line-height:1.3; max-width:100%; white-space:pre-wrap; overflow-wrap:anywhere; word-break:break-word; }
  .pc-mention{
    color:#fff;
    font-weight:900;
    text-decoration:none;
  }
  .pc-mention:hover{ text-decoration:underline; }
  .pc-edit-ta{
    width:100%;
    min-height:90px;
    resize:vertical;
    background: rgba(255,255,255,0.05);
    border:1px solid rgba(255,255,255,0.12);
    border-radius:14px;
    color:#fff;
    padding:10px 12px;
    outline:none;
    font-weight:800;
    font-size:13px;
    line-height:1.35;
  }
  .pc-ava-link{ display:block; flex:0 0 auto; }
  .pc-ava-link:hover{ opacity:.9; }

  .pc-form{
    display:flex; gap:10px; align-items:flex-start;
  }
  .pc-form .avatar{
    width:36px;
    height:36px;
    border-radius:999px;
    overflow:hidden;
    border:1px solid rgba(255,255,255,0.14);
    background: rgba(255,255,255,0.10);
    flex:0 0 auto;
  }
  .pc-form .avatar img{
    width:100%;
    height:100%;
    object-fit:cover;
    display:block;
  }
  .pc-input{
    flex:1;
    background: rgba(255,255,255,0.05);
    border:1px solid rgba(255,255,255,0.12);
    border-radius:14px;
    color:#fff;
    padding:10px 12px;
    outline:none;
  }
  .pc-ta{
    width:100%;
    min-width:0;
    resize:none;
    min-height:44px;
    max-height:180px;
    overflow:hidden;
    line-height:1.35;
  }
  .pc-ta:focus{
    min-height:96px;
  }
  .pc-send{
    width:44px; height:44px;
    border:0; border-radius:14px;
    background:#fff; color:#000;
    font-weight:950; cursor:pointer;
    display:flex; align-items:center; justify-content:center;
  }
  .pc-send svg{ width:16px; height:16px; stroke:currentColor; fill:none; stroke-width:2.6; }

  /* COLLECTIONS GRID */
  .cgrid{
    display:grid;
    grid-template-columns:repeat(auto-fill,minmax(280px,1fr));
    gap:16px;
    padding-top:18px;
  }
  .ccard{
    position:relative;
    border-radius:22px;
    overflow:hidden;
    border:1px solid rgba(255,255,255,0.12);
    background: rgba(255,255,255,0.04);
    cursor:pointer;
    transition:.18s;
    min-height: 320px;
  }
  .ccard:hover{ transform: translateY(-4px); border-color: rgba(255,255,255,0.25); }
  .cc-bg{
    position:absolute; inset:0;
    background:#000;
  }
  .cc-bg img,
  .cc-bg video{
    position:absolute; inset:0;
    width:100%; height:100%;
    object-fit:cover;
    opacity:0;
    transition: opacity .8s ease;
    filter: saturate(1.05) contrast(1.05);
  }
  .cc-bg img.on,
  .cc-bg video.on{ opacity:0.85; }
  .cc-glass{
    position:relative;
    height:100%;
    display:flex;
    align-items:center;
    justify-content:center;
    text-align:center;
    padding:20px;
    backdrop-filter: none;
    background: linear-gradient(to top, rgba(0,0,0,0.72), rgba(0,0,0,0.14));
  }
  .cc-title{
    font-weight:1000;
    font-size:18px;
    letter-spacing:-.2px;
  }
  .cc-desc{
    margin-top:10px;
    font-size:13px;
    color: rgba(255,255,255,0.75);
    display:-webkit-box;
    -webkit-line-clamp:3;
    -webkit-box-orient:vertical;
    overflow:hidden;
    max-width: 520px;
    margin-left:auto;
    margin-right:auto;
  }
  .cc-meta{
    position:absolute;
    left:14px;
    right:14px;
    bottom:14px;
    display:flex;
    justify-content:space-between;
    align-items:center;
    gap:10px;
  }
  .cc-pill{
    padding:7px 10px;
    border-radius:999px;
    background: rgba(0,0,0,0.40);
    border:1px solid rgba(255,255,255,0.14);
    backdrop-filter: none;
    font-weight:900;
    font-size:12px;
    color:#fff;
    display:flex;
    gap:8px;
    align-items:center;
  }
  .cc-pill[data-csave], .cc-pill[data-clike]{ cursor:pointer; }
  .cc-pill svg{ width:14px; height:14px; fill: currentColor; }

  /* LIBRARY GRID (existing cards) */
  .lf-grid{ display:grid; grid-template-columns:repeat(auto-fill,minmax(280px,1fr)); gap:16px; padding-top:18px; }
  .lf-card{
    background:var(--bg-card); border:1px solid var(--border); border-radius:18px;
    overflow:hidden; display:flex; flex-direction:column; height:340px;
    cursor:pointer; transition: transform 0.2s ease, border-color 0.2s ease; position: relative;
  }
  .lf-card:hover { transform: translateY(-4px); border-color: rgba(255,255,255,0.3); }
  .lf-media{ position:relative; width:100%; height:100%; background:#000; }
  .lf-media video{ position:absolute; inset:0; width:100%; height:100%; object-fit:cover; display:block; }
  .lf-media .lf-hover-video{ opacity:0; pointer-events:none; transition:opacity .15s ease; }
  .lf-card:hover .lf-hover-video{ opacity:1; }
  .lf-card:hover .lf-poster-video{ opacity:0; }
  .lf-media .lf-thumb{ width:100%; height:100%; object-fit:cover; display:block; }

  .card-bottom{
    position:absolute; left:0; right:0; bottom:0; padding: 46px 14px 12px;
    background: linear-gradient(to top, rgba(0,0,0,0.92), transparent);
    display:flex; flex-direction:column; gap:10px; opacity:0; transition:0.2s;
  }
  .lf-card:hover .card-bottom { opacity: 1; }

  .card-author{ display:flex; align-items:center; gap:10px; min-width:0; }
  .author-txt{ min-width:0; }
  .author-name,.author-username{ white-space:nowrap; overflow:hidden; text-overflow:ellipsis; }
  .author-name{ font-size:13px; font-weight:800; display:flex; align-items:center; gap:6px; }
  .author-username{ font-size:12px; color: rgba(255,255,255,0.65); }
  .card-title{ font-size:14px; font-weight:800; margin-top:2px; white-space:nowrap; overflow:hidden; text-overflow:ellipsis; }
  .card-stats{ display:flex; gap:10px; flex-wrap:wrap; color: rgba(255,255,255,0.78); font-size:12px; font-weight:700; }
  .stat{ display:flex; gap:6px; align-items:center; padding: 6px 10px; border-radius: 999px; background: rgba(255,255,255,0.06); border: 1px solid rgba(255,255,255,0.08); }
  .stat svg { width: 14px; height: 14px; fill: currentColor; }

  /* Work modal (existing) z-index lower than Media Viewer */
  .lf-modal-backdrop {
    position: fixed; top: 0; left: 0; width: 100vw; height: 100vh;
    background: rgba(0,0,0,0.85); backdrop-filter: blur(5px); z-index: 11000;
    display: flex; align-items: center; justify-content: center;
    opacity: 0; pointer-events: none; transition: opacity 0.2s;
  }
  .lf-modal-backdrop.open { opacity: 1; pointer-events: auto; }
  .lf-modal {
    width: 92%; max-width: 1200px; height: 88vh; background: var(--bg-modal);
    border: 1px solid var(--border); border-radius: 24px; display: flex; overflow: hidden;
    box-shadow: var(--shadow); position: relative;
  }
  .m-preview { flex:1; background:#000; display:flex; align-items:center; justify-content:center; overflow:hidden; }
  .m-preview img, .m-preview video { max-width:100%; max-height:100%; width:100%; height:100%; object-fit:contain; display:block; }
  .m-sidebar {
    width:380px; border-left: 1px solid var(--border); display:flex; flex-direction:column;
    padding:22px; background: var(--bg-card); flex-shrink:0; gap:14px;
  }
  .m-close{
    position:absolute; top:16px; right:16px; background: rgba(0,0,0,0.5); color:#fff;
    border:1px solid rgba(255,255,255,0.2); width:40px; height:40px; border-radius:50%;
    cursor:pointer; font-size:20px; display:flex; align-items:center; justify-content:center; z-index:10;
  }
  .m-close:hover { background:#fff; color:#000; }
  .m-head{ display:flex; gap:12px; align-items:center; }
  .m-head .avatar{ width:36px; height:36px; }
  .m-head a{ color:#fff; text-decoration:none; font-weight:900; }
  .m-head a:hover{ text-decoration:underline; }
  .m-head .sub{ color: rgba(255,255,255,0.65); font-size:12px; margin-top:2px; }
  .m-meta{ color: rgba(255,255,255,0.65); font-size:12px; }
  .m-title-row{ display:flex; gap:8px; align-items:center; }
  .m-title{ font-size:18px; font-weight:900; letter-spacing:-.2px; margin-top:2px; flex:1; }
  .title-edit-btn{ width:30px; height:30px; border-radius:10px; border:1px solid rgba(255,255,255,0.2); background:rgba(255,255,255,0.06); color:#fff; cursor:pointer; }
  .title-edit{ display:flex; gap:8px; }
  .title-edit input{ flex:1; background: rgba(255,255,255,0.05); color:#fff; border:1px solid rgba(255,255,255,0.12); border-radius:12px; padding:8px 10px; }

  .m-actions{ display:flex; gap:10px; }
  .btn-act{
    flex:1; border:0; padding: 12px 10px; border-radius: 14px; cursor:pointer; font-weight:900; color:#fff;
    background: rgba(255,255,255,0.06); border: 1px solid rgba(255,255,255,0.12);
    display:flex; align-items:center; justify-content:center; gap:8px;
  }
  .btn-act:hover{ background: rgba(255,255,255,0.10); border-color: rgba(255,255,255,0.22); }
  .btn-act.on.like { color: var(--danger); border-color: rgba(255,70,90,0.45); background: rgba(255,70,90,0.14); }
  .btn-act.on.save { color: #2b6cff; border-color: rgba(43,108,255,0.45); background: rgba(43,108,255,0.18); }
  .btn-act svg { width: 18px; height: 18px; }
  .abtn svg { stroke: currentColor; fill:none; }

  .m-stats{ display:flex; gap:8px; flex-wrap:wrap; }
  .m-stats .stat{ background: rgba(0,0,0,0.35); border-color: rgba(255,255,255,0.10); }
  .m-comments{ margin-top:6px; border-top:1px solid rgba(255,255,255,0.08); padding-top:12px; display:flex; flex-direction:column; gap:10px; min-height:0; flex:1; }
  .icon-btn{ width:30px; height:30px; border-radius:9px; border:1px solid rgba(255,255,255,0.14); background:rgba(255,255,255,0.06); color:#fff; cursor:pointer; display:flex; align-items:center; justify-content:center; }
  .icon-btn svg{ width:15px; height:15px; }
  .c-list{ overflow:auto; padding-right:6px; display:flex; flex-direction:column; gap:10px; flex:1; min-height:0; }
  .c-item{ display:flex; gap:10px; align-items:flex-start; }
  .c-item .avatar{ width:28px; height:28px; flex:0 0 auto; }
  .c-bubble{ background: rgba(255,255,255,0.06); border:1px solid rgba(255,255,255,0.10); border-radius:14px; padding:10px 12px; flex:1; }
  .c-top{ display:flex; align-items:center; gap:10px; flex-wrap:wrap; margin-bottom:6px; }
  .c-name{ font-weight:900; font-size:12px; }
  .c-time{ color: rgba(255,255,255,0.55); font-size:11px; margin-left:6px; }
  .c-body{ color:#fff; font-size:13px; line-height:1.35; white-space:pre-wrap; }
  .c-form{ display:flex; gap:8px; }
  .c-input{ flex:1; background: rgba(255,255,255,0.05); border:1px solid rgba(255,255,255,0.12); border-radius:14px; color:#fff; padding: 10px 12px; }
  .c-send{ width:46px; border:0; border-radius:14px; background:#fff; color:#000; font-weight:900; cursor:pointer; display:flex; align-items:center; justify-content:center; }
  .c-send svg { width:16px; height:16px; stroke:currentColor; fill:none; stroke-width:2.6; }

  /* Collection modal */
  .col-backdrop{ position:fixed; inset:0; z-index:10500; background:rgba(0,0,0,0.86); backdrop-filter: blur(5px); display:flex; align-items:center; justify-content:center; opacity:0; pointer-events:none; transition:.18s; }
  .col-backdrop.open{ opacity:1; pointer-events:auto; }
  .col-modal{
    width:92%;
    max-width:1200px;
    height:88vh;
    background: rgba(255,255,255,0.05);
    border:1px solid rgba(255,255,255,0.12);
    border-radius:24px;
    overflow:hidden;
    box-shadow: var(--shadow);
    display:flex;
    flex-direction:column;
    position:relative;
    backdrop-filter: blur(14px);
  }
  .col-close{
    position:absolute; top:16px; right:16px;
    background: rgba(0,0,0,0.5); color:#fff;
    border:1px solid rgba(255,255,255,0.2);
    width:40px; height:40px; border-radius:50%;
    cursor:pointer; font-size:20px; display:flex; align-items:center; justify-content:center;
    z-index:10;
  }
  .col-close:hover{ background:#fff; color:#000; }
  .col-header{
    padding:18px 18px 16px;
    border-bottom:1px solid rgba(255,255,255,0.10);
    display:flex;
    flex-direction:column;
    gap:12px;
  }
  .col-toprow{
    display:flex;
    align-items:flex-start;
    justify-content:space-between;
    gap:12px;
    flex-wrap:wrap;
  }
  .col-h-actions{
    display:flex;
    gap:10px;
    align-items:center;
    flex-wrap:wrap;
  }
  .col-header::after{
    content:"";
    display:block;
    height:1px;
    width:100%;
    background: rgba(255,255,255,0.10);
    margin-top:2px;
  }
  .col-h-left{ min-width:0; }
  .col-h-title{ font-weight:950; font-size:18px; letter-spacing:-.2px; }
  .col-h-desc{ margin-top:6px; color: rgba(255,255,255,0.75); font-size:13px; line-height:1.4; max-width:820px; }
  .col-h-meta{ margin-top:8px; display:flex; gap:8px; flex-wrap:wrap; }
  .col-h-meta .stat{ background: rgba(0,0,0,0.35); border-color: rgba(255,255,255,0.10); }
  .col-body{
    padding:18px;
    overflow:auto;
    flex:1;
  }
  .col-scenes{ display:flex; flex-direction:column; gap:14px; }
  .scene{
    border:1px solid rgba(255,255,255,0.10);
    background: rgba(255,255,255,0.03);
    border-radius:18px;
    overflow:hidden;
  }
  .scene-head{
    padding:12px 14px;
    display:flex; justify-content:space-between; gap:10px; align-items:flex-start;
    border-bottom:1px solid rgba(255,255,255,0.08);
  }
  .scene-title{ font-weight:950; }
  .scene-desc{ margin-top:6px; color:rgba(255,255,255,0.72); font-size:13px; line-height:1.35; }
  .scene-actions{ display:flex; gap:8px; flex-wrap:wrap; }
  .scene-grid{
    padding:14px;
    display:grid;
    grid-template-columns: repeat(auto-fill, minmax(240px, 1fr));
    gap:12px;
  }
  .col-grid{
    display:grid;
    grid-template-columns: repeat(auto-fill, minmax(240px, 1fr));
    gap:14px;
  }
  .col-item{
    position:relative;
    border-radius:18px;
    overflow:hidden;
    border:1px solid rgba(255,255,255,0.10);
    background:#000;
    aspect-ratio: 1 / 1;
    cursor:pointer;
    transition: transform .12s ease, box-shadow .12s ease, opacity .12s ease;
  }
  .col-item img, .col-item video{
    position:absolute; inset:0;
    width:100%; height:100%;
    object-fit:cover;
    display:block;
  }
  .drag-handle{
    position:absolute;
    top:50%;
    left:50%;
    right:auto;
    transform: translate(-50%, -50%);
    padding:0;
    width:42px;
    height:42px;
    border-radius:14px;
    background: rgba(0,0,0,0.55);
    border:1px solid rgba(255,255,255,0.12);
    display:flex;
    align-items:center;
    justify-content:center;
    color:#fff;
    cursor:grab;
    user-select:none;
  }
  .drag-handle svg{
    width:20px;
    height:20px;
    stroke:#fff;
    opacity:.9;
  }
  .col-item.dragging{
    opacity:.6;
    transform: scale(.98);
    box-shadow: 0 20px 50px rgba(0,0,0,0.35);
  }
  .reorder-footer{
    position:sticky;
    bottom:0;
    z-index:3;
    margin-top:14px;
    padding:12px;
    border-radius:14px;
    border:1px solid rgba(255,255,255,0.14);
    background: rgba(12,12,12,0.92);
    display:none;
    align-items:center;
    justify-content:space-between;
    gap:10px;
    flex-wrap:wrap;
  }
  .reorder-footer.open{ display:flex; }
  .col-film{
    margin-top:12px;
    padding:12px;
    border-radius:18px;
    border:1px solid rgba(255,255,255,0.12);
    background: rgba(0,0,0,0.25);
  }
  .col-film h3{ margin:0; font-size:14px; font-weight:950; }
  .col-film p{ margin:8px 0 0; color:rgba(255,255,255,0.75); font-size:13px; line-height:1.35; }
  .col-film video{
    width:100%;
    border-radius:16px;
    margin-top:10px;
    border:1px solid rgba(255,255,255,0.10);
    background:#000;
  }
  .col-film .formRow{ display:grid; grid-template-columns:1fr 1fr; gap:10px; margin-top:10px; }
  .col-film input, .col-film textarea{
    width:100%;
    background: rgba(255,255,255,0.05);
    border:1px solid rgba(255,255,255,0.12);
    border-radius:14px;
    padding:10px 12px;
    color:#fff;
    font-weight:800;
  }
  .col-film textarea{ min-height:90px; resize:vertical; }
  .col-film .tip{
    margin-top:8px;
    font-size:12px;
    color:rgba(255,255,255,0.65);
    line-height:1.35;
    border:1px dashed rgba(255,255,255,0.14);
    border-radius:14px;
    padding:10px 12px;
  }

  /* ===== Film hero inside collection header ===== */
  .film-hero{
    margin-top:12px;
    border-radius:22px;
    border:1px solid rgba(255,255,255,0.12);
    background: rgba(0,0,0,0.28);
    overflow:hidden;
  }
  .film-hero .film-media{
    position:relative;
    aspect-ratio: 16/9;
    background:#000;
  }
  .film-hero video{
    position:absolute; inset:0;
    width:100%; height:100%;
    object-fit:cover;
    display:block;
  }
  .film-hero .film-media::after{
    content:"";
    position:absolute; inset:0;
    background: linear-gradient(to top,
      rgba(0,0,0,.70) 0%,
      rgba(0,0,0,.25) 45%,
      rgba(0,0,0,.05) 100%);
  }
  .film-hero .film-caption{
    padding:14px 14px 16px;
  }
  .film-hero .film-title{
    font-weight:1000;
    font-size:20px;
    letter-spacing:.6px;
    text-transform:uppercase;
    margin:0;
  }
  .film-hero .film-desc{
    margin-top:8px;
    color:rgba(255,255,255,0.78);
    font-size:13px;
    line-height:1.45;
    display:-webkit-box;
    -webkit-line-clamp:3;
    -webkit-box-orient:vertical;
    overflow:hidden;
  }
  .film-hero .film-desc.open{
    -webkit-line-clamp:unset;
  }
  .film-hero .film-more{
    margin-top:10px;
    display:inline-flex;
    gap:8px;
    align-items:center;
    height:34px;
    padding:0 12px;
    border-radius:999px;
    border:1px solid rgba(255,255,255,0.12);
    background: rgba(255,255,255,0.06);
    color:#fff;
    cursor:pointer;
    font-weight:900;
    font-size:12px;
  }
  .film-hero .film-more:hover{
    background: rgba(255,255,255,0.10);
    border-color: rgba(255,255,255,0.22);
  }
  .film-hero .film-more svg{
    width:18px;
    height:18px;
    transition: transform .18s ease;
  }

  .picked-grid{ display:grid; grid-template-columns:repeat(auto-fill,minmax(110px,1fr)); gap:10px; }
  .picked-item{ position:relative; aspect-ratio:1/1; border-radius:12px; overflow:hidden; border:1px solid rgba(255,255,255,0.16); background:#000; cursor:pointer; }
  .picked-item img{ width:100%; height:100%; object-fit:cover; display:block; }
  .picked-item.is-cover{ border-color: rgba(110,168,255,0.9); box-shadow: 0 0 0 2px rgba(110,168,255,0.35) inset; }
  .picked-remove{ position:absolute; top:8px; right:8px; width:24px; height:24px; border-radius:999px; border:1px solid rgba(255,255,255,0.22); background:rgba(0,0,0,0.62); color:#fff; cursor:pointer; font-weight:900; display:flex; align-items:center; justify-content:center; }
  .picked-cover{ position:absolute; left:8px; bottom:8px; padding:4px 7px; border-radius:10px; background: rgba(0,0,0,0.65); border:1px solid rgba(255,255,255,0.14); font-size:10px; font-weight:900; }

  /* Media Viewer (super top) */
  .mv-backdrop{
    position:fixed; inset:0;
    z-index:15000;
    background: rgba(0,0,0,0.90);
    backdrop-filter: blur(6px);
    opacity:0; pointer-events:none;
    transition:.18s;
    display:flex; align-items:center; justify-content:center;
  }
  .mv-backdrop.open{ opacity:1; pointer-events:auto; }
  .mv{
    width:92%; max-width:1320px;
    height:90vh;
    border-radius:24px;
    overflow:hidden;
    border:1px solid rgba(255,255,255,0.12);
    background: rgba(255,255,255,0.04);
    box-shadow: var(--shadow);
    position:relative;
    display:flex;
    flex-direction:column;
    backdrop-filter: blur(10px);
  }
  .mv-close{
    position:absolute; top:14px; right:14px;
    width:40px; height:40px;
    border-radius:999px;
    border:1px solid rgba(255,255,255,0.18);
    background: rgba(0,0,0,0.45);
    color:#fff;
    cursor:pointer;
    display:flex; align-items:center; justify-content:center;
    z-index:10;
    font-size:20px;
  }
  .mv-close:hover{ background:#fff; color:#000; }
  .mv-stage{
    flex:1;
    position:relative;
    background:#000;
    display:flex;
    align-items:center;
    justify-content:center;
  }
  .mv-media{
    width:100%;
    height:100%;
    object-fit:contain;
    max-width:100%;
    max-height:100%;
  }
  .mv-nav{
    position:absolute;
    top:50%;
    transform: translateY(-50%);
    width:54px; height:54px;
    border-radius:999px;
    border:1px solid rgba(255,255,255,0.18);
    background: rgba(0,0,0,0.45);
    color:#fff;
    cursor:pointer;
    display:flex; align-items:center; justify-content:center;
    backdrop-filter: blur(6px);
    transition:.15s;
    z-index:5;
  }
  .mv-nav:hover{ background: rgba(255,255,255,0.12); border-color: rgba(255,255,255,0.28); }
  .mv-nav.prev{ left:14px; }
  .mv-nav.next{ right:14px; }

  .mv-bar{
    padding:12px 14px;
    border-top:1px solid rgba(255,255,255,0.10);
    display:flex;
    align-items:center;
    justify-content:space-between;
    gap:12px;
    flex-wrap:wrap;
    background: rgba(0,0,0,0.35);
    backdrop-filter: blur(10px);
  }
  .mv-title{
    font-weight:950;
    font-size:13px;
    color: rgba(255,255,255,0.9);
    white-space:nowrap;
    overflow:hidden;
    text-overflow:ellipsis;
    max-width: 60ch;
  }
  .mv-dots{
    display:flex;
    gap:6px;
    padding:7px 10px;
    border-radius:999px;
    background: rgba(0,0,0,0.40);
    border:1px solid rgba(255,255,255,0.14);
  }
  .mv-dots button{
    width:7px; height:7px; border-radius:99px;
    border:0; cursor:pointer;
    background: rgba(255,255,255,0.35);
  }
  .mv-dots button.on{ background:#fff; }

  /* Sheets */

  #emoGrid button{
    height:44px;
    border-radius:14px;
    border:1px solid rgba(255,255,255,0.12);
    background: rgba(255,255,255,0.06);
    cursor:pointer;
    font-size:22px;
    display:flex;
    align-items:center;
    justify-content:center;
    font-family:"Apple Color Emoji","Segoe UI Emoji","Segoe UI Symbol","Noto Color Emoji",sans-serif;
  }
  #emoGrid button:hover{ background: rgba(255,255,255,0.10); border-color: rgba(255,255,255,0.22); }
  .sheet-backdrop{ position:fixed; inset:0; z-index:14000; background:rgba(0,0,0,0.86); backdrop-filter: blur(5px); display:flex; align-items:center; justify-content:center; opacity:0; pointer-events:none; transition:.18s; }
  .sheet-backdrop.open{ opacity:1; pointer-events:auto; }
  .sheet{
    width:92%;
    max-width:980px;
    height:88vh;
    background: rgba(255,255,255,0.05);
    border:1px solid rgba(255,255,255,0.12);
    border-radius:24px;
    overflow:hidden;
    box-shadow: var(--shadow);
    position:relative;
    display:flex;
    flex-direction:column;
    backdrop-filter: blur(14px);
  }
  .sheet-head{
    padding:16px 16px 12px;
    border-bottom:1px solid rgba(255,255,255,0.10);
    display:flex;
    justify-content:space-between;
    gap:10px;
    align-items:center;
  }
  .sheet-title{ font-weight:950; font-size:16px; }
  .sheet-close{ width:40px; height:40px; border-radius:50%; border:1px solid rgba(255,255,255,0.2); background: rgba(0,0,0,0.45); color:#fff; cursor:pointer; font-size:20px; display:flex; align-items:center; justify-content:center; }
  .sheet-close:hover{ background:#fff; color:#000; }
  .sheet-body{ padding:14px 16px 16px; overflow:auto; flex:1; display:flex; flex-direction:column; gap:12px; }
  .field{ display:flex; flex-direction:column; gap:8px; }
  .field label{ font-size:12px; color: rgba(255,255,255,0.65); font-weight:800; }
  .field input, .field textarea{
    background: rgba(255,255,255,0.05);
    color:#fff;
    border:1px solid rgba(255,255,255,0.12);
    border-radius:14px;
    padding:10px 12px;
    outline:none;
    font-weight:800;
    font-size:14px;
  }
  .field textarea{ min-height:110px; resize:vertical; }
  .sheet-actions{ display:flex; gap:10px; flex-wrap:wrap; padding-top:8px; }
  .btn-danger{
    height:38px; padding:0 14px; border-radius:999px; border:1px solid rgba(255,70,90,0.40);
    background: rgba(255,70,90,0.16); color: #ffd3d8; cursor:pointer; font-weight:950; transition:.15s;
    display:inline-flex; align-items:center; justify-content:center; gap:8px;
  }
  .btn-danger:hover{ border-color: rgba(255,70,90,0.65); }
  .muted{ color: rgba(255,255,255,0.65); font-size:12px; line-height:1.4; }

  /* Picker */
  .pickbar{ display:flex; align-items:center; justify-content:space-between; gap:10px; flex-wrap:wrap; }
  .search{
    display:flex; gap:8px; align-items:center;
    padding:8px 10px;
    border-radius:999px;
    border:1px solid rgba(255,255,255,0.12);
    background: rgba(255,255,255,0.04);
    color:#fff;
  }
  .search input{ border:0; outline:none; background:transparent; color:#fff; font-weight:850; min-width:220px; }
  .lib-grid{
    display:grid;
    grid-template-columns: repeat(auto-fill, minmax(180px, 1fr));
    gap:10px;
    margin-top:8px;
  }
  .lib-item{
    position:relative;
    border-radius:16px;
    overflow:hidden;
    border:1px solid rgba(255,255,255,0.12);
    background:#000;
    aspect-ratio: 1 / 1;
    cursor:pointer;
  }
  .lib-item img, .lib-item video{
    position:absolute; inset:0;
    width:100%; height:100%;
    object-fit:cover;
  }
  .lib-item .check{
    position:absolute; top:10px; right:10px;
    width:28px; height:28px;
    border-radius:999px;
    border:1px solid rgba(255,255,255,0.18);
    background: rgba(0,0,0,0.45);
    display:flex; align-items:center; justify-content:center;
    font-weight:950;
  }
  .lib-item.selected{ border-color: rgba(110,168,255,0.55); box-shadow: 0 0 0 2px rgba(110,168,255,0.18) inset; }
  .lib-item.selected .check{ background: rgba(110,168,255,0.25); border-color: rgba(110,168,255,0.55); }

  .pick-list{
    display:flex;
    flex-direction:column;
    gap:10px;
  }
  .pick-row{
    border:1px solid rgba(255,255,255,0.12);
    background: rgba(255,255,255,0.04);
    border-radius:16px;
    padding:12px;
    cursor:pointer;
    display:flex;
    gap:12px;
    align-items:center;
  }
  .pick-row:hover{ background: rgba(255,255,255,0.08); border-color: rgba(255,255,255,0.22); }
  .pick-row.on{ border-color: rgba(110,168,255,0.55); box-shadow: 0 0 0 2px rgba(110,168,255,0.16) inset; }
  .pick-thumb{
    width:64px; height:64px; border-radius:14px; overflow:hidden;
    background:#000; border:1px solid rgba(255,255,255,0.10); flex:0 0 auto;
  }
  .pick-thumb img{ width:100%; height:100%; object-fit:cover; display:block; }
  .pick-main{ min-width:0; flex:1; }
  .pick-name{ font-weight:950; }
  .pick-sub{ color:rgba(255,255,255,0.65); font-size:12px; margin-top:4px; white-space:nowrap; overflow:hidden; text-overflow:ellipsis; }
  .pick-topbar{ position:sticky; top:0; z-index:2; display:flex; gap:8px; align-items:center; flex-wrap:wrap; padding:10px; border-radius:12px; border:1px solid rgba(255,255,255,0.12); background: rgba(10,10,10,0.95); margin-bottom:12px; }
  .pick-filters{ display:flex; gap:8px; }
  .pick-filter{ padding:6px 10px; border-radius:999px; border:1px solid rgba(255,255,255,0.12); background:rgba(255,255,255,0.04); color:#fff; cursor:pointer; font-weight:800; }
  .pick-filter.on{ background:#fff; color:#000; }
  .pick-list.wide{
    display:grid;
    grid-template-columns: repeat(4, 1fr);
    gap:12px;
    max-height: 520px;
    overflow:auto;
    padding-right:4px;
  }
  .pick-row.wide{ display:block; padding:0; overflow:hidden; position:relative; }
  .pick-check{
    position:absolute; top:12px; right:12px;
    width:30px; height:30px;
    border-radius:999px;
    border:1px solid rgba(255,255,255,0.18);
    background: rgba(0,0,0,0.45);
    display:flex; align-items:center; justify-content:center;
    font-weight:950;
  }
  .pick-row.wide.on .pick-check{
    background: rgba(110,168,255,0.25);
    border-color: rgba(110,168,255,0.55);
  }
  .pick-thumb.wide{ width:100%; height:auto; aspect-ratio:16/9; border-radius:0; border:0; }
  .pick-thumb.wide img{ width:100%; height:100%; }
  .pick-main.wide{ padding:10px 12px 12px; }

  #pickB{ z-index:14500; }
  .lib-item .kind{
    position:absolute; left:10px; top:10px;
    background: rgba(0,0,0,0.55);
    border:1px solid rgba(255,255,255,0.12);
    border-radius:10px;
    padding:5px 8px;
    font-size:11px;
    font-weight:900;
    display:flex; gap:6px; align-items:center;
    backdrop-filter: blur(4px);
  }
  .kind .dot{ width:7px; height:7px; border-radius:50%; background:#fff; }
  .kind .dot.video{ background:var(--violet); }
  .kind .dot.image{ background:var(--good); }

  .toast{ position:fixed; left:50%; bottom:22px; transform:translateX(-50%) translateY(12px); background:rgba(15,15,15,0.96); color:#fff; border:1px solid rgba(255,255,255,0.16); border-radius:12px; padding:10px 14px; font-weight:800; font-size:13px; z-index:20020; opacity:0; pointer-events:none; transition:.18s ease; }
  .toast.show{ opacity:1; transform:translateX(-50%) translateY(0); }

  @media(max-width: 980px){
    .feed{ width:min(720px,100%); margin:0; }
    .pslide img, .pslide video{ max-height:300px; }
    .lf-modal { flex-direction:column; height:92vh; }
    .m-sidebar { width:100%; height:46vh; border-left:none; border-top:1px solid var(--border); }
    .m-preview { height:46vh; }
    .col-grid{ grid-template-columns: repeat(2, 1fr); }
  }
  @media(max-width:1180px){ .pick-list.wide{ grid-template-columns: repeat(3, 1fr); } }
  @media(max-width:820px){ .pick-list.wide{ grid-template-columns: repeat(2, 1fr); } }
  @media(max-width:760px){ .col-film .formRow{ grid-template-columns:1fr; } }
</style>

<div id="lf-u">
  <div class="vfy-tip" id="vfyTip">Verified — awarded at 100 followers. Helps ranking in Feed.</div>
  <div class="toast" id="toast"></div>

    <div class="wrap">
      <div class="top">
  <div class="pcover" id="pcover">
    <div class="pcover-bg" id="pcoverBg"></div>
    <button class="pcover-edit" id="pcoverEdit" type="button" style="display:none;" title="Change cover">✎</button>
    <button class="pcover-del" id="pcoverDel" type="button" style="display:none;" title="Remove cover">✕</button>
  </div>

  <div class="phead">
    <div class="pava" id="p-ava"></div>
    <div class="pmeta">
      <div class="pname" id="p-name">Loading…</div>
      <div class="puser" id="p-user">@…</div>
      <div class="fcnt"><span>Followers</span><b id="p-followers">0</b></div>
    </div>
  </div>

  <div class="pbio" id="p-bio" style="display:none;"></div>
  <div class="links" id="p-links" style="display:none;"></div>

  <div class="controls">
    <button class="p-follow" id="p-follow-btn" style="display:none;">Follow</button>

    <div class="tabs-row">
      <div class="seg" id="seg-tabs">
        <button class="active" data-tab="posts">Posts</button>
        <button data-tab="collections">Collections</button>
        <button data-tab="library">Library</button>
      </div>

            <div class="tab-actions">
        <button class="btn-primary" id="btn-new-post" style="display:none;">+ New post</button>
        <button class="btn-primary" id="btn-new-col" style="display:none;">+ New collection</button>

        <div class="seg" id="seg-sort" style="display:none;">
          <button class="active" data-sort="new">New</button>
          <button data-sort="top">Top</button>
        </div>

        <!-- ✅ чтобы JS не падал на $range.onchange -->
        <div class="pill" id="pill-range" style="display:none;">
          <span style="opacity:.8;">Range</span>
          <select id="range">
            <option value="newest">Newest</option>
            <option value="oldest">Oldest</option>
          </select>
        </div>
      </div>
    </div>
  </div>
</div>

    <div class="panel-sep"></div>

    <div class="grid-wrap" id="gridWrap">
      <div class="tab-pane active" id="gridPosts"></div>
      <div class="tab-pane" id="gridCollections"></div>
      <div class="tab-pane" id="gridLibrary"></div>
    </div>
    <div class="loader" id="loader">Loading…</div>
  </div>

  <!-- Work modal (Library item) -->
  <div class="lf-modal-backdrop" id="mb">
    <button class="m-close" id="mclose">✕</button>
    <div class="lf-modal" onclick="event.stopPropagation()">
      <div class="m-preview" id="mp"></div>

      <div class="m-sidebar">
        <div class="m-head">
          <div class="avatar" id="m-avatar"></div>
          <div style="min-width:0">
            <div style="display:flex;gap:10px;align-items:center;flex-wrap:wrap;">
              <a id="m-userlink" href="#" target="_blank" rel="noopener">user</a>
              <span class="m-meta" id="mmeta"></span>
            </div>
            <div class="sub" id="m-userline">@username</div>
            <div class="fcnt" id="m-followers" style="display:none;"></div>
          </div>
        </div>

        <div class="m-title-row" id="title-row">
          <div class="m-title" id="mtitle">—</div>
          <button class="title-edit-btn" id="title-edit-btn" style="display:none;">✎</button>
        </div>

        <div class="title-edit" id="title-edit" style="display:none;">
          <input id="title-input" maxlength="120" />
          <button class="btn-act" id="title-save">Save</button>
          <button class="btn-act" id="title-cancel">Cancel</button>
        </div>

        <div class="m-stats" id="mstats"></div>

        <div class="m-actions">
          <button class="btn-act abtn" id="likeBtn">Like</button>
          <button class="btn-act abtn" id="saveBtn">Save</button>
          <button class="btn-act" id="dlBtn" title="Download"></button>
        </div>

        <div class="m-comments">
          <div style="display:flex;justify-content:space-between;align-items:center;">
            <div style="font-weight:900">Comments</div>
            <button class="icon-btn" id="reloadComments" title="Reload">
              <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M23 4v6h-6M1 20v-6h6M20.49 15a9 9 0 1 1-2.12-9.36L23 10"/></svg>
            </button>
          </div>
          <div class="c-list" id="clist"></div>
          <div class="c-form">
            <input class="c-input" id="cinput" placeholder="Write a comment…" />
            <button class="c-send" id="csend"><svg viewBox="0 0 24 24"><path d="M12 19V5M5 12l7-7 7 7"/></svg></button>
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- Collection modal -->
  <div class="col-backdrop" id="cb">
    <button class="col-close" id="cclose">✕</button>
    <div class="col-modal" onclick="event.stopPropagation()">
      <div class="col-header">
        <div class="col-toprow">
          <div class="col-h-left">
            <div class="col-h-title" id="ctitle">Collection</div>
            <div class="col-h-desc" id="cdesc"></div>
            <div class="col-h-meta" id="cmeta"></div>
          </div>

          <div class="col-h-actions">
            <button class="btn-ghost" id="btn-col-edit" style="display:none;">Edit</button>
            <button class="btn-primary" id="btn-scene-new" style="display:none;">+ Scene</button>
            <button class="btn-ghost" id="btn-col-reorder" style="display:none;">Reorder</button>
            <button class="btn-danger" id="btn-col-delete" style="display:none;">Delete</button>
          </div>
        </div>

        <div class="col-film" id="colFilm" style="display:none;"></div>
      </div>
      <div class="col-body">
        <div class="col-scenes" id="cScenes"></div>
        <div class="reorder-footer" id="colReorderFooter">
          <div class="muted">Reorder mode is active</div>
          <div style="display:flex;gap:8px;flex-wrap:wrap;">
            <button class="btn-primary" id="btn-col-reorder-save">Save order</button>
            <button class="btn-ghost" id="btn-col-reorder-cancel">Cancel</button>
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- Media Viewer (top) -->
  <div class="mv-backdrop" id="mvb">
    <div class="mv" onclick="event.stopPropagation()">
      <button class="mv-close" id="mvClose">✕</button>
      <div class="mv-stage" id="mvStage">
        <button class="mv-nav prev" id="mvPrev">‹</button>
        <button class="mv-nav next" id="mvNext">›</button>
        <div id="mvMediaHost" style="width:100%;height:100%;display:flex;align-items:center;justify-content:center;"></div>
      </div>
      <div class="mv-bar">
        <div class="mv-title" id="mvTitle">—</div>
        <div class="mv-dots" id="mvDots"></div>
      </div>
    </div>
  </div>

  <!-- New/Edit Post sheet -->
  <div class="sheet-backdrop" id="pb">
    <div class="sheet" onclick="event.stopPropagation()">
      <div class="sheet-head">
        <div class="sheet-title" id="ptitle">New post</div>
        <button class="sheet-close" id="pclose">✕</button>
      </div>
      <div class="sheet-body">
        <div class="field">
          <label>Post text</label>
          <textarea id="ptext" placeholder="Write something…"></textarea>
        </div>

        <div class="pickbar">
          <div class="muted">Add media from Library (optional). Uploading from ПК is disabled.</div>
          <div style="display:flex;gap:10px;flex-wrap:wrap;">
            <button class="btn-ghost" id="pPickMedia">+ Add from Library</button>
            <button class="btn-ghost" id="pPickCollection">+ Attach collection</button>
          </div>
        </div>

        <div class="muted" id="pPickedInfo">Selected: 0</div>
        <div class="lib-grid" id="pPickGrid" style="display:none;"></div>

        <div class="sheet-actions">
          <button class="btn-primary" id="psave">Save post</button>
          <button class="btn-ghost" id="pcancel">Cancel</button>
        </div>
      </div>
    </div>
  </div>

  <!-- New/Edit Collection sheet -->
  <div class="sheet-backdrop" id="kb">
    <div class="sheet" onclick="event.stopPropagation()">
      <div class="sheet-head">
        <div class="sheet-title" id="ktitle">New collection</div>
        <button class="sheet-close" id="kclose">✕</button>
      </div>
      <div class="sheet-body">
        <div class="field">
          <label>Title</label>
          <input id="kname" maxlength="80" placeholder="Untitled collection" />
        </div>
        <div class="field">
          <label>Description</label>
          <textarea id="kdesc" placeholder="Short description…"></textarea>
        </div>

        <div class="pickbar">
          <div class="search">
            <span style="opacity:.75;font-weight:900;">Search</span>
            <input id="ksearch" placeholder="Title contains…" />
          </div>

          <div class="pill">
            <span style="opacity:.8;">Sort</span>
            <select id="ksort">
              <option value="new">New</option>
              <option value="top">Top</option>
            </select>
          </div>

          <button class="btn-ghost" id="kPickMedia">+ Add from Library</button>
        </div>

        <div class="muted" id="kPickedInfo">Selected: 0</div>
        <div id="kSelectedWrap" style="display:none;">
          <div class="muted" style="margin-bottom:8px;">Selected items (click card to set cover)</div>
          <div class="picked-grid" id="kSelectedGrid"></div>
        </div>
        <div class="lib-grid" id="kPickGrid" style="display:none;"></div>

        <div class="sheet-actions">
          <button class="btn-primary" id="ksave">Save collection</button>
          <button class="btn-ghost" id="kcancel">Cancel</button>
        </div>
      </div>
    </div>
  </div>


  <!-- Universal Picker Modal -->
  <div class="sheet-backdrop" id="pickB">
    <div class="sheet" onclick="event.stopPropagation()">
      <div class="sheet-head">
        <div class="sheet-title" id="pickTitle">Pick</div>
        <button class="sheet-close" id="pickClose">✕</button>
      </div>
      <div class="sheet-body">
        <div class="pickbar">
          <div class="search" id="pickSearchWrap">
            <span style="opacity:.75;font-weight:900;">Search</span>
            <input id="pickSearch" placeholder="Search…" />
          </div>
          <div class="muted" id="pickHint"></div>
          <div class="pick-filters" id="pickFilters" style="display:none;">
            <button class="pick-filter on" data-type="all">All</button>
            <button class="pick-filter" data-type="image">Image</button>
            <button class="pick-filter" data-type="video">Video</button>
          </div>
        </div>
        <div id="pickList"></div>
        <div class="sheet-actions">
          <button class="btn-primary" id="pickOk">OK</button>
          <button class="btn-ghost" id="pickCancel">Cancel</button>
        </div>
      </div>
    </div>
  </div>


  <div class="sheet-backdrop" id="scB">
    <div class="sheet" onclick="event.stopPropagation()" style="max-width:640px;height:auto;max-height:80vh;">
      <div class="sheet-head">
        <div class="sheet-title" id="scTitle">New scene</div>
        <button class="sheet-close" id="scClose">✕</button>
      </div>
      <div class="sheet-body">
        <div class="field">
          <label>Scene title</label>
          <input id="scName" maxlength="80" placeholder="Scene 1" />
        </div>
        <div class="field">
          <label>Description</label>
          <textarea id="scDesc" placeholder="Short description…"></textarea>
        </div>
        <div class="sheet-actions">
          <button class="btn-primary" id="scSave">Save</button>
          <button class="btn-ghost" id="scCancel">Cancel</button>
        </div>
        <div class="status" id="scStatus"></div>
      </div>
    </div>
  </div>

  <!-- Film submit sheet -->
  <div class="sheet-backdrop" id="fsB">
    <div class="sheet" onclick="event.stopPropagation()" style="max-width:760px;height:auto;max-height:86vh;">
      <div class="sheet-head">
        <div class="sheet-title">Submit your film</div>
        <button class="sheet-close" id="fsClose">✕</button>
      </div>
      <div class="sheet-body">
        <div class="muted" style="margin-top:-2px;">
          Want to share your film? Send it to us and if it doesn’t violate the rules, we’ll publish it within 1–2 days.
        </div>

        <div class="field">
          <label>Film title</label>
          <input id="fsTitle" maxlength="80" placeholder="My short film" />
        </div>

        <div class="field">
          <label>Description</label>
          <textarea id="fsDesc" placeholder="What is this film about?"></textarea>
        </div>

        <div class="field">
          <label style="display:flex;align-items:center;gap:10px;">
            Cloud download link
            <span class="pill" id="fsRulesBtn" style="cursor:pointer;">Rules</span>
          </label>
          <input id="fsUrl" placeholder="https://drive.google.com/..." />
          <div class="muted">Make sure we can download the file from your link.</div>
        </div>

        <div class="sheet-actions">
          <button class="btn-primary" id="fsSubmit">Submit film</button>
          <button class="btn-ghost" id="fsCancel">Cancel</button>
        </div>

        <div class="status" id="fsStatus"></div>
      </div>
    </div>
  </div>

  <!-- Film rules tooltip -->
  <div class="vfy-tip" id="fsTip"></div>

  <div class="sheet-backdrop" id="cfB">
    <div class="sheet" onclick="event.stopPropagation()" style="max-width:520px;height:auto;">
      <div class="sheet-head">
        <div class="sheet-title" id="cfTitle">Confirm</div>
        <button class="sheet-close" id="cfClose">✕</button>
      </div>
      <div class="sheet-body">
        <div class="muted" id="cfText">—</div>
        <div class="sheet-actions" style="justify-content:flex-end">
          <button class="btn-ghost" id="cfCancel">Cancel</button>
          <button class="btn-danger" id="cfOk">Delete</button>
        </div>
      </div>
    </div>
  </div>

  <div class="sheet-backdrop" id="emoB">
    <div class="sheet" onclick="event.stopPropagation()" style="max-width:560px;height:auto;max-height:80vh;">
      <div class="sheet-head">
        <div class="sheet-title">Emoji</div>
        <button class="sheet-close" id="emoClose">✕</button>
      </div>
      <div class="sheet-body">
        <div class="search" style="width:100%;">
          <span style="opacity:.75;font-weight:900;">Search</span>
          <input id="emoSearch" placeholder="smile, fire, cat..." />
        </div>
        <div id="emoGrid" style="display:grid;grid-template-columns:repeat(10,1fr);gap:8px;margin-top:12px;max-height:320px;overflow:auto;"></div>
      </div>
    </div>
  </div>

</div>

<script>
(() => {
  const READ_BACKEND = "https://api.lightfull.ai";
  const WRITE_BACKEND = "https://ai-vfx-backend.vercel.app";
  const DEFAULT_PROFILE_COVER = "https://fs.getcourse.ru/fileservice/file/download/a/384380/sc/439/h/fdef161860d4b1a6fbfd9ce6813dcd8b.png";
  const PAGE_SIZE = 24;
  const VERIFIED_SVG = "<svg viewBox=\"0 0 24 24\" aria-hidden=\"true\"><path d=\"M12 2l2.6 2.1 3.3-.2.8 3.2 2.7 1.9-1.3 3 1.3 3-2.7 1.9-.8 3.2-3.3-.2L12 22l-2.6-2.1-3.3.2-.8-3.2-2.7-1.9 1.3-3-1.3-3 2.7-1.9.8-3.2 3.3.2L12 2zm-1.1 13.4l6-6-1.4-1.4-4.6 4.6-2.4-2.4-1.4 1.4 3.8 3.8z\"/></svg>";
  const VFY_TOOLTIP = "Verified — awarded at 100 followers. Helps ranking in Feed.";
  const LS_FOLLOW = "lf_follow_cache_v1";

  const $gridWrap = document.getElementById("gridWrap");
  const $gridPosts = document.getElementById("gridPosts");
  const $gridCollections = document.getElementById("gridCollections");
  const $gridLibrary = document.getElementById("gridLibrary");
  let $grid = $gridPosts;
  const $loader = document.getElementById("loader");
  const $pAva = document.getElementById("p-ava");
  const $pName = document.getElementById("p-name");
  const $pUser = document.getElementById("p-user");
  const $pBio = document.getElementById("p-bio");
  const $pLinks = document.getElementById("p-links");
  const $pFollowers = document.getElementById("p-followers");
  const $pFollowBtn = document.getElementById("p-follow-btn");
  const $pcover = document.getElementById("pcover");
  const $pcoverBg = document.getElementById("pcoverBg");
  const $pcoverEdit = document.getElementById("pcoverEdit");
  const $pcoverDel = document.getElementById("pcoverDel");
  const $toast = document.getElementById("toast");

  const $segTabs = document.getElementById("seg-tabs");
  const $btnNewPost = document.getElementById("btn-new-post");
  const $btnNewCol = document.getElementById("btn-new-col");

  const $segSort = document.getElementById("seg-sort");
  const $pillRange = document.getElementById("pill-range");
  const $range = document.getElementById("range");

  // Work modal (library)
  const $mb = document.getElementById("mb");
  const $mclose = document.getElementById("mclose");
  const $mp = document.getElementById("mp");
  const $mAvatar = document.getElementById("m-avatar");
  const $mUserlink = document.getElementById("m-userlink");
  const $mUserline = document.getElementById("m-userline");
  const $mmeta = document.getElementById("mmeta");
  const $mFollowers = document.getElementById("m-followers");
  const $mtitle = document.getElementById("mtitle");
  const $mstats = document.getElementById("mstats");
  const $likeBtn = document.getElementById("likeBtn");
  const $saveBtn = document.getElementById("saveBtn");
  const $dlBtn = document.getElementById("dlBtn");
  const $clist = document.getElementById("clist");
  const $cinput = document.getElementById("cinput");
  const $csend = document.getElementById("csend");
  const $reloadComments = document.getElementById("reloadComments");
  const $titleEditBtn = document.getElementById("title-edit-btn");
  const $titleEdit = document.getElementById("title-edit");
  const $titleInput = document.getElementById("title-input");
  const $titleSave = document.getElementById("title-save");
  const $titleCancel = document.getElementById("title-cancel");
  const $vfyTip = document.getElementById("vfyTip");

  // Collection modal
  const $cb = document.getElementById("cb");
  const $cclose = document.getElementById("cclose");
  const $ctitle = document.getElementById("ctitle");
  const $cdesc = document.getElementById("cdesc");
  const $cmeta = document.getElementById("cmeta");
  const $cgrid = document.getElementById("cScenes");
  const $colFilm = document.getElementById("colFilm");
  const $btnColEdit = document.getElementById("btn-col-edit");
  const $btnSceneNew = document.getElementById("btn-scene-new");
  const $btnColReorder = document.getElementById("btn-col-reorder");
  const $btnColDelete = document.getElementById("btn-col-delete");
  const $colReorderFooter = document.getElementById("colReorderFooter");
  const $btnColReorderSave = document.getElementById("btn-col-reorder-save");
  const $btnColReorderCancel = document.getElementById("btn-col-reorder-cancel");

  // Media viewer
  const $mvb = document.getElementById("mvb");
  const $mvClose = document.getElementById("mvClose");
  const $mvPrev = document.getElementById("mvPrev");
  const $mvNext = document.getElementById("mvNext");
  const $mvHost = document.getElementById("mvMediaHost");
  const $mvTitle = document.getElementById("mvTitle");
  const $mvDots = document.getElementById("mvDots");

  // Post sheet
  const $pb = document.getElementById("pb");
  const $pclose = document.getElementById("pclose");
  const $ptitle = document.getElementById("ptitle");
  const $ptext = document.getElementById("ptext");
  const $pPickMedia = document.getElementById("pPickMedia");
  const $pPickCollection = document.getElementById("pPickCollection");
  const $pPickGrid = document.getElementById("pPickGrid");
  const $pPickedInfo = document.getElementById("pPickedInfo");
  const $psave = document.getElementById("psave");
  const $pcancel = document.getElementById("pcancel");

  // Collection sheet
  const $kb = document.getElementById("kb");
  const $kclose = document.getElementById("kclose");
  const $ktitle = document.getElementById("ktitle");
  const $kname = document.getElementById("kname");
  const $kdesc = document.getElementById("kdesc");
  const $ksearch = document.getElementById("ksearch");
  const $ksort = document.getElementById("ksort");
  const $kPickMedia = document.getElementById("kPickMedia");
  const $kPickGrid = document.getElementById("kPickGrid");
  const $kPickedInfo = document.getElementById("kPickedInfo");
  const $kSelectedWrap = document.getElementById("kSelectedWrap");
  const $kSelectedGrid = document.getElementById("kSelectedGrid");
  const $ksave = document.getElementById("ksave");
  const $kcancel = document.getElementById("kcancel");


  // Universal picker
  const $pickB = document.getElementById("pickB");
  const $pickTitle = document.getElementById("pickTitle");
  const $pickClose = document.getElementById("pickClose");
  const $pickOk = document.getElementById("pickOk");
  const $pickCancel = document.getElementById("pickCancel");
  const $pickList = document.getElementById("pickList");
  const $pickSearch = document.getElementById("pickSearch");
  const $pickHint = document.getElementById("pickHint");
  const $pickFilters = document.getElementById("pickFilters");

  const $scB = document.getElementById("scB");
  const $scTitle = document.getElementById("scTitle");
  const $scClose = document.getElementById("scClose");
  const $scCancel = document.getElementById("scCancel");
  const $scSave = document.getElementById("scSave");
  const $scName = document.getElementById("scName");
  const $scDesc = document.getElementById("scDesc");
  const $scStatus = document.getElementById("scStatus");

  const $fsB = document.getElementById("fsB");
  const $fsClose = document.getElementById("fsClose");
  const $fsCancel = document.getElementById("fsCancel");
  const $fsSubmit = document.getElementById("fsSubmit");
  const $fsTitle = document.getElementById("fsTitle");
  const $fsDesc = document.getElementById("fsDesc");
  const $fsUrl = document.getElementById("fsUrl");
  const $fsStatus = document.getElementById("fsStatus");
  const $fsRulesBtn = document.getElementById("fsRulesBtn");
  const $fsTip = document.getElementById("fsTip");

  const $cfB = document.getElementById("cfB");
  const $cfTitle = document.getElementById("cfTitle");
  const $cfText = document.getElementById("cfText");
  const $cfClose = document.getElementById("cfClose");
  const $cfCancel = document.getElementById("cfCancel");
  const $cfOk = document.getElementById("cfOk");

  const $emoB = document.getElementById("emoB");
  const $emoClose = document.getElementById("emoClose");
  const $emoSearch = document.getElementById("emoSearch");
  const $emoGrid = document.getElementById("emoGrid");

  // State
  let username = "";
  let profile = null;
  let myProfile = null;
  let myUserId = null;
  let isOwnProfile = false;
  let followState = false;

  let tab = "posts";
  let sort = "new";
  let range = "newest";

  const tabState = {
    posts: { offset:0, loading:false, hasMore:true, loadedOnce:false },
    collections: { offset:0, loading:false, hasMore:true, loadedOnce:false },
    library: { offset:0, loading:false, hasMore:true, loadedOnce:false }
  };
  let isSwitching = false;
  let activeAbort = null;

  let libraryItems = [];      // works
  let postItems = [];         // profile posts
  let collectionItems = [];   // collections

  // Work modal state
  let currentWork = null;
  let liked = false;
  let saved = false;

  // Collection modal state
  let currentCol = null;
  let colReorderMode = false;
  let colOriginalOrderIds = [];
  let dragFromIndex = null;
  let editingSceneId = null;
  let fsCollectionId = null;

  // Create/edit
  let editingPostId = null;
  let postDraftMedia = [];

  let editingColId = null;
  let colDraftMedia = [];
  let colDraftCover = null;

  // Media Viewer state
  let mvItems = [];
  let mvIndex = 0;
  let mvOnChange = null;

  let pickMode = null;
  let pickSelectedId = null;
  let pickSelectedSet = new Set();
  let pickResolve = null;

  const postCommentsMode = new Map();
  const replyToByPost = new Map(); // post_id -> { comment_id, username }
  const ICONS = {
    like: '<svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M12 21s-7-4.6-9.5-9C.6 8.6 2.6 5 6.5 5c2.1 0 3.6 1.2 4.5 2.4C11.9 6.2 13.4 5 15.5 5 19.4 5 21.4 8.6 21.5 12c-2.5 4.4-9.5 9-9.5 9z"/></svg>',
    comm: '<svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M21 15a2 2 0 0 1-2 2H7l-4 4V5a2 2 0 0 1 2-2h14a2 2 0 0 1 2 2z"/></svg>',
    save: '<svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M17 3H7c-1.1 0-1.99.9-1.99 2L5 21l7-3 7 3V5c0-1.1-.9-2-2-2z"/></svg>',
    view: '<svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M1 12s4-7.5 11-7.5S23 12 23 12s-4 7.5-11 7.5S1 12 1 12z"/><path d="M12 15.5a3.5 3.5 0 1 0 0-7 3.5 3.5 0 0 0 0 7z"/></svg>',
    dl: '<svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M12 3v12"/><path d="M7 10l5 5 5-5"/><path d="M5 21h14"/></svg>',
    link: `<svg viewBox="0 0 24 24" fill="none"><path d="M10 13a5 5 0 0 0 7 0l2-2a5 5 0 0 0-7-7l-1 1" stroke="currentColor" stroke-width="2" stroke-linecap="round"/><path d="M14 11a5 5 0 0 0-7 0l-2 2a5 5 0 0 0 7 7l1-1" stroke="currentColor" stroke-width="2" stroke-linecap="round"/></svg>`,
    youtube: `<svg viewBox="0 0 24 24"><path fill="#ff0000" d="M23.5 6.2s-.2-1.6-.9-2.3c-.8-.9-1.7-.9-2.1-1C17.4 2.6 12 2.6 12 2.6h0s-5.4 0-8.5.3c-.4 0-1.3 0-2.1 1C.7 4.6.5 6.2.5 6.2S.3 8 .3 9.8v1.6C.3 13.2.5 15 .5 15s.2 1.6.9 2.3c.8.9 1.9.9 2.4 1C5.7 18.6 12 18.6 12 18.6s5.4 0 8.5-.3c.4 0 1.3 0 2.1-1 .7-.7.9-2.3.9-2.3s.2-1.8.2-3.6V9.8c0-1.8-.2-3.6-.2-3.6zM9.8 14.7V7.9l6.2 3.4-6.2 3.4z"/></svg>`,
    send: '<svg viewBox="0 0 24 24" fill="none"><path d="M12 19V5M5 12l7-7 7 7" stroke="currentColor" stroke-width="2.6"/></svg>',
    edit: '<svg viewBox="0 0 24 24" fill="none"><path d="M12 20h9" stroke="currentColor" stroke-width="2"/><path d="M16.5 3.5a2.1 2.1 0 0 1 3 3L7 19l-4 1 1-4 12.5-12.5z" stroke="currentColor" stroke-width="2"/></svg>',
    trash: '<svg viewBox="0 0 24 24" fill="none"><path d="M3 6h18" stroke="currentColor" stroke-width="2"/><path d="M8 6V4h8v2" stroke="currentColor" stroke-width="2"/><path d="M19 6l-1 14H6L5 6" stroke="currentColor" stroke-width="2"/><path d="M10 11v6" stroke="currentColor" stroke-width="2"/><path d="M14 11v6" stroke="currentColor" stroke-width="2"/></svg>'
  };

  const EMOJI_CPS = [
    0x1F600,0x1F604,0x1F601,0x1F60E,0x1F913,0x1F978,0x1F607,0x1F642,0x1F609,0x1F60D,0x1F618,0x1F929,0x1F624,0x1F608,0x1F47B,0x1F916,
    0x1F525,0x26A1,0x1F48E,0x2728,0x1F319,0x2B50,0x2600,0x1F308,0x2601,0x2744,0x1F480,0x1F9E0,0x1F441,0x1F3AC,0x1F3A5,0x1F39E,
    0x1F3AE,0x1F579,0x1F3A8,0x1F58C,0x1F9E9,0x1F3A7,0x1F3B5,0x1F977,0x1F98A,0x1F431,0x1F436,0x1F43C,0x1F984,0x1F438,0x1F435,0x1F989,
    0x1F33F,0x2618,0x1F344,0x1F30A,0x1F3DD,0x1F3D4,0x1F3D9,0x1F680,0x1F6F8,0x1F6F0,0x1F9EA,0x2699,0x1F9F0,0x1F527,0x1F52E,0x1F4CC,
    0x2764,0x1F5A4,0x1F499,0x1F49C,0x1F90D,0x1F49B,0x1F49A,0x1F4A5,0x1F4AB,0x1FAE7,0x1F9FF,0x1F3C6,0x1F4BC,0x1F4F7,0x1F4A1,0x1F9CA
  ];
  const EMOJIS = EMOJI_CPS.map(cp => String.fromCodePoint(cp));

  let emoTargetInput = null;

  function openEmojiPicker(inputEl){
    if(!$emoB || !$emoSearch || !$emoGrid) return;
    emoTargetInput = inputEl;
    $emoSearch.value = "";
    renderEmojiGrid("");
    $emoB.classList.add("open");
    setTimeout(()=> $emoSearch.focus(), 0);
  }
  function closeEmojiPicker(){
    if(!$emoB) return;
    $emoB.classList.remove("open");
    emoTargetInput = null;
  }
  function renderEmojiGrid(q){
    if(!$emoGrid) return;
    const query = (q||"").trim().toLowerCase();
    const list = EMOJIS.filter(e => !query || e.includes(query));
    $emoGrid.innerHTML = list.map(e=> `<button type="button" data-em="${e}">${e}</button>`).join("");
    $emoGrid.querySelectorAll("[data-em]").forEach(b=>{
      b.onclick = ()=>{
        if(!emoTargetInput) return;
        emoTargetInput.value = (emoTargetInput.value || "") + b.getAttribute("data-em");
        emoTargetInput.focus();
        closeEmojiPicker();
      };
    });
  }

  function confirmUI(title, text, okText="OK", danger=false){
    $cfTitle.textContent = title || "Confirm";
    $cfText.textContent = text || "";
    $cfOk.textContent = okText;

    $cfOk.classList.remove("btn-danger","btn-primary");
    $cfOk.classList.add(danger ? "btn-danger" : "btn-primary");

    $cfB.classList.add("open");
    return new Promise((resolve)=>{
      const done = (v)=>{ $cfB.classList.remove("open"); resolve(v); };
      $cfClose.onclick = ()=> done(false);
      $cfCancel.onclick = ()=> done(false);
      $cfB.onclick = (e)=>{ if(e.target === $cfB) done(false); };
      $cfOk.onclick = ()=> done(true);
    });
  }

  function qs(name){ const u = new URL(location.href); return u.searchParams.get(name) || ""; }
  function safe(s){ return String(s||""); }
  function escapeHtml(s){
    return String(s||"")
      .replaceAll("&","&amp;").replaceAll("<","&lt;").replaceAll(">","&gt;")
      .replaceAll('"',"&quot;").replaceAll("'","&#039;");
  }
  function linkifyMentions(text){
    const safeTxt = escapeHtml(text);
    return safeTxt.replace(/(^|\s)@([a-zA-Z0-9_\.]{2,32})/g, (m, p1, u)=> {
      return `${p1}<a class="pc-mention" href="/artist?username=${encodeURIComponent(u)}">@${u}</a>`;
    });
  }
  function toast(msg){
    $toast.textContent = String(msg || "");
    $toast.classList.add("show");
    setTimeout(()=> $toast.classList.remove("show"), 1600);
  }
  function fmtDate(ts){ return safe(ts).replace("T"," ").slice(0,16); }

  function fsShowStatus(msg, type){
    if(!$fsStatus) return;
    $fsStatus.style.display = msg ? "block" : "none";
    $fsStatus.className = "status" + (type ? (" " + type) : "");
    $fsStatus.textContent = msg || "";
  }

  function openFilmSheet(collectionId){
    if(!$fsB) return;
    fsCollectionId = collectionId;
    $fsTitle.value = "";
    $fsDesc.value = "";
    $fsUrl.value = "";
    fsShowStatus("", "");
    $fsB.classList.add("open");
    setTimeout(()=> $fsTitle.focus(), 0);
  }
  function closeFilmSheet(){
    if(!$fsB) return;
    $fsB.classList.remove("open");
    fsCollectionId = null;
    if($fsTip) $fsTip.style.display = "none";
  }

  function bindFilmRulesTooltip(){
    if(!$fsRulesBtn || !$fsTip) return;
    const text = `Rules:
• No porn / nudity
• No politics / propaganda
• No hate / violence
• No doxxing / personal data

Requirements:
• Duration: 20 sec – 5 min
• Quality: HD – 4K

Download link:
• Make sure we can download the file from your link.`;

    $fsRulesBtn.addEventListener("mouseenter", (ev)=>{
      $fsTip.textContent = text;
      $fsTip.style.display = "block";
      $fsTip.style.left = `${ev.clientX + 12}px`;
      $fsTip.style.top  = `${ev.clientY + 12}px`;
    });
    $fsRulesBtn.addEventListener("mousemove", (ev)=>{
      if($fsTip.style.display === "block"){
        $fsTip.style.left = `${ev.clientX + 12}px`;
        $fsTip.style.top  = `${ev.clientY + 12}px`;
      }
    });
    $fsRulesBtn.addEventListener("mouseleave", ()=>{
      $fsTip.style.display = "none";
    });
  }

  function scStatus(msg, type){
    if(!$scStatus) return;
    $scStatus.style.display = msg ? "block" : "none";
    $scStatus.className = "status" + (type ? (" " + type) : "");
    $scStatus.textContent = msg || "";
  }
  function openSceneSheet(mode, scene=null){
    editingSceneId = scene ? scene.id : null;
    $scTitle.textContent = mode === "edit" ? "Edit scene" : "New scene";
    $scName.value = scene?.title || "";
    $scDesc.value = scene?.description || "";
    scStatus("", "");
    $scB.classList.add("open");
  }
  function closeSceneSheet(){
    $scB.classList.remove("open");
    editingSceneId = null;
  }

  function getFollowCache(){
    try { return JSON.parse(localStorage.getItem(LS_FOLLOW) || "{}"); } catch(e){ return {}; }
  }
  function setFollowCache(m){ localStorage.setItem(LS_FOLLOW, JSON.stringify(m)); }
  function cacheSet(userId, val){ const m = getFollowCache(); m[String(userId)] = !!val; setFollowCache(m); }
  function cacheGet(userId){ const m = getFollowCache(); return m[String(userId)] === true; }
  function cacheHas(userId){ const m = getFollowCache(); return Object.prototype.hasOwnProperty.call(m, String(userId)); }

  function verifiedBadgeHTML(v){ return v ? `<span class="vfy" data-tip="verified">${VERIFIED_SVG}</span>` : ""; }
  function bindVerifiedTooltip(root=document){
    root.querySelectorAll('.vfy[data-tip="verified"]').forEach((el)=>{
      if(el.dataset.tipBound) return;
      el.dataset.tipBound = "1";
      const host = el.closest('.post-name, .author-name, .pname, .m-head') || el;
      host.addEventListener('mouseenter', (ev)=>{ $vfyTip.textContent = VFY_TOOLTIP; $vfyTip.style.display='block'; $vfyTip.style.left=`${ev.clientX+12}px`; $vfyTip.style.top=`${ev.clientY+12}px`; });
      host.addEventListener('mousemove', (ev)=>{ if($vfyTip.style.display==='block'){ $vfyTip.style.left=`${ev.clientX+12}px`; $vfyTip.style.top=`${ev.clientY+12}px`; } });
      host.addEventListener('mouseleave', ()=>{ $vfyTip.style.display='none'; });
    });
  }

  function isVideoUrl(url){
    const u = String(url||"").toLowerCase();
    return u.endsWith(".mp4") || u.endsWith(".webm") || u.endsWith(".mov") || u.includes("fal.media");
  }

  function renderAvatarInto(el, avatar_type, avatar_url, avatar_emoji, fallbackLetter){
    const t = String(avatar_type || "image").toLowerCase();
    const em = (avatar_emoji || "").trim();
    const url = (avatar_url || "").trim();

    el.classList.remove("emoji");
    el.innerHTML = "";

    if(t === "emoji" && em){
      el.classList.add("emoji");
      el.innerHTML = `<span aria-label="avatar emoji">${escapeHtml(em)}</span>`;
      return;
    }
    if(url){
      el.innerHTML = `<img src="${escapeHtml(url)}" alt="" />`;
      return;
    }
    if(fallbackLetter){
      el.textContent = String(fallbackLetter).slice(0,1).toUpperCase();
    }
  }

  async function getSessionToken(){
    try{ if(!window.sb) return null; const { data } = await window.sb.auth.getSession(); return data?.session?.access_token || null; }
    catch(e){ return null; }
  }
  async function getCurrentUserId(){
    try{ if(!window.sb) return null; const { data } = await window.sb.auth.getUser(); return data?.user?.id || null; }
    catch(e){ return null; }
  }
  async function fetchMyPublicProfile(accessToken){
    try{
      const r = await fetch(READ_BACKEND + "/api/profile_public", {
        method:"GET",
        headers:{ Authorization: "Bearer " + accessToken }
      });
      const j = await r.json().catch(()=> ({}));
      if(!r.ok) return null;
      return j?.profile || null;
    }catch(e){
      return null;
    }
  }
  async function requireToken(){ const t = await getSessionToken(); if(!t) throw new Error("Login required"); return t; }

  async function api(path, opts={}){
    const method = (opts.method || "GET").toUpperCase();
    const token = await getSessionToken();
    const headers = Object.assign({}, opts.headers || {});
    if(opts.body && !headers["Content-Type"]) headers["Content-Type"] = "application/json";

    // auth GET only for feed/state
    const needsAuthGet = method === "GET" && path.startsWith("/api/feed/state");
    if(token && (method !== "GET" || needsAuthGet)) headers.Authorization = "Bearer " + token;

    const base = (method === "GET") ? READ_BACKEND : WRITE_BACKEND;
    const r = await fetch(base + path, Object.assign({}, opts, { headers, signal: opts.signal }));
    const j = await r.json().catch(()=> ({}));
    if(!r.ok) {
      const msg = j?.error || j?.details || ("HTTP " + r.status);
      console.error("API FAIL:", path, { status: r.status, body: j });
      throw new Error(msg);
    }
    return j;
  }

  async function syncFollowState(userId){
    if(!userId) return false;
    let value = false;
    if(cacheHas(userId)) value = cacheGet(userId);

    const token = await getSessionToken();
    if(!token) return value;

    try{
      const st = await api(`/api/social/state?user_id=${encodeURIComponent(userId)}`, { method:"GET" });
      value = !!st.following;
      cacheSet(userId, value);
      return value;
    }catch(e){
      return value;
    }
  }

  function showLoader(v){ $loader.style.display = v ? "flex" : "none"; }

  // -------- Profile header ----------
  function renderProfileCover(p){
    if(!$pcover || !$pcoverBg) return;
    const coverId = (p && p.header_feed_post_id) ? String(p.header_feed_post_id) : "";
    const byId = new Map(libraryItems.map(it => [String(it.id), it]));

    let url = DEFAULT_PROFILE_COVER;

    if(coverId && byId.has(coverId)){
      const it = byId.get(coverId);
      const candidate = (it.thumb_url || it.media_url || "").trim();
      if(candidate && !isVideoUrl(candidate)) url = candidate;
    }

    $pcoverBg.innerHTML = `<img src="${escapeHtml(url)}" alt="cover" loading="lazy" decoding="async">`;

    $pcoverEdit.style.display = isOwnProfile ? "flex" : "none";
    $pcoverDel.style.display = isOwnProfile ? "flex" : "none";
  }

  function renderProfile(p){
    profile = p || {};
    const dn = p.display_name || p.username || username;
    $pName.innerHTML = `${escapeHtml(dn || "User")} ${verifiedBadgeHTML(p.verified === true)}`;
    bindVerifiedTooltip($pName);
    $pUser.textContent = "@" + (p.username || username);
    $pFollowers.textContent = p.follower_count ?? 0;
    renderAvatarInto($pAva, p.avatar_type, p.avatar_url, p.avatar_emoji, (dn||"U").slice(0,1));

    const bio = (p.bio||"").trim();
    $pBio.style.display = bio ? "block" : "none";
    $pBio.textContent = bio;

    const links = p.links || {};
    const chips = [];
    if(links.youtube) chips.push(`<a class="chip" href="${links.youtube}" target="_blank" rel="noopener">${ICONS.youtube}<span>YouTube</span></a>`);
    if(links.site){
      const host = (()=>{ try{ return new URL(links.site).hostname.replace("www.",""); }catch(e){ return "Website"; } })();
      chips.push(`<a class="chip" href="${links.site}" target="_blank" rel="noopener">${ICONS.link}<span>${escapeHtml(host)}</span></a>`);
    }
    $pLinks.style.display = chips.length ? "flex" : "none";
    $pLinks.innerHTML = chips.join("");
  }

  async function loadProfileHeaderOnce(){
    const j = await api(`/api/u/${encodeURIComponent(username)}?limit=1&offset=0`, { method:"GET" });
    renderProfile(j.profile || {});

    const me = await getCurrentUserId();
    isOwnProfile = !!(me && (String(me) === String((j.profile||{}).user_id)));

    renderProfileCover(j.profile || {});

    if(isOwnProfile){
      $pFollowBtn.style.display = "none";
    }else{
      const pid = (j.profile||{}).user_id;
      $pFollowBtn.style.display = "inline-flex";
      $pFollowBtn.disabled = true;

      if(pid && cacheHas(pid)){
        followState = cacheGet(pid);
        $pFollowBtn.textContent = followState ? "Following" : "Follow";
        $pFollowBtn.classList.toggle("on", followState);
      } else {
        $pFollowBtn.textContent = "…";
        $pFollowBtn.classList.remove("on");
      }

      followState = await syncFollowState(pid);
      $pFollowBtn.disabled = false;
      $pFollowBtn.textContent = followState ? "Following" : "Follow";
      $pFollowBtn.classList.toggle("on", followState);
    }
  }

  async function toggleFollow(){
    if(isOwnProfile || !profile?.user_id) return;
    const token = await getSessionToken();
    if(!token){ toast("Login required"); return; }

    try{
      const path = followState ? "/api/social/unfollow" : "/api/social/follow";
      const payload = { following_id: profile.user_id };
      const j = await api(path, { method:"POST", body: JSON.stringify(payload) });
      followState = !followState;
      cacheSet(profile.user_id, followState);
      $pFollowBtn.textContent = followState ? "Following" : "Follow";
      $pFollowBtn.classList.toggle("on", followState);

      if(j && typeof j.follower_count !== "undefined") {
        profile.follower_count = j.follower_count;
        profile.verified = !!j.verified;
        $pFollowers.textContent = profile.follower_count ?? 0;
        $pName.innerHTML = `${escapeHtml(profile.display_name || profile.username || username)} ${verifiedBadgeHTML(profile.verified === true)}`;
        bindVerifiedTooltip($pName);
      }
    }catch(e){
      console.error("FOLLOW ERROR:", e);
      alert(e?.message || String(e));
    }
  }

  // -------- Tab state ----------
  function renderTabControls(){
    $segSort.style.display = (tab === "collections") ? "flex" : (tab === "library" ? "flex" : "none");
    $pillRange.style.display = (tab === "library") ? "flex" : "none";
    $btnNewPost.style.display = (isOwnProfile && tab === "posts") ? "inline-flex" : "none";
    $btnNewCol.style.display = (isOwnProfile && tab === "collections") ? "inline-flex" : "none";
  }

  function getPaneByTab(name){
    if(name === "collections") return $gridCollections;
    if(name === "library") return $gridLibrary;
    return $gridPosts;
  }

  function setActivePane(name){
    ["posts","collections","library"].forEach(t=>{
      const pane = getPaneByTab(t);
      pane.classList.toggle("active", t === name);
    });
    $grid = getPaneByTab(name);
    const activePane = $grid;
    requestAnimationFrame(()=>{
      const h = Math.max(activePane.offsetHeight || 240, 240);
      $gridWrap.style.minHeight = h + "px";
    });
  }

  function renderErrorForTab(name, message){
    const pane = getPaneByTab(name);
    pane.innerHTML = `<div class="empty" style="color:#ff98a2;border-color:rgba(255,70,90,0.3)">Error: ${escapeHtml(message)}</div>`;
  }

  async function switchTab(newTab){
    if(newTab === tab || isSwitching) return;
    isSwitching = true;
    setTimeout(()=>{ isSwitching = false; }, 180);

    if(activeAbort) activeAbort.abort();
    activeAbort = new AbortController();

    tab = newTab;
    $segTabs.querySelectorAll("button").forEach(b=> b.classList.toggle("active", b.dataset.tab === tab));
    renderTabControls();
    setActivePane(tab);

    const state = tabState[tab];
    if(state.loadedOnce){
      if(tab === "posts") renderPosts();
      else if(tab === "collections") renderCollections();
      else renderLibrary();
      return;
    }

    if(tab === "posts") return loadPosts(true, { signal: activeAbort.signal });
    if(tab === "collections") return loadCollections(true, { signal: activeAbort.signal });
    return loadLibrary(true, { signal: activeAbort.signal });
  }

  function getQS(name){
    try { return new URLSearchParams(location.search).get(name); }
    catch(e){ return null; }
  }

  async function applyTabFromUrl(){
  const tabFromUrl = (getQS("tab") || "").toLowerCase();
  const wanted = (tabFromUrl === "collections" || tabFromUrl === "library" || tabFromUrl === "posts")
    ? tabFromUrl
    : "posts";

  // ✅ ВАЖНО: ищем кнопку ТОЛЬКО в табах artist, НЕ в документе (чтобы не кликать header)
  const btn = $segTabs?.querySelector(`button[data-tab="${wanted}"]`);

  if(btn) btn.click();
  else await switchTab(wanted);
}


  window.addEventListener("DOMContentLoaded", () => {
    applyTabFromUrl().catch(e => console.error(e));
  });

  window.addEventListener("popstate", () => {
    applyTabFromUrl().catch(e => console.error(e));
  });

  // -------- Data loaders ----------
  async function loadLibrary(reset=false, opts={}){
    const state = tabState.library;
    if(state.loading) return;
    state.loading = true;
    showLoader(true);

    try{
      if(reset){ state.offset = 0; state.hasMore = true; libraryItems = []; }

      const j = await api(`/api/u/${encodeURIComponent(username)}?limit=${PAGE_SIZE}&offset=${state.offset}`, { method:"GET", signal: opts.signal });
      let page = Array.isArray(j.works) ? j.works : [];

      // apply sort/range like before
      if(sort === "top"){
        page.sort((a,b)=> (b.like_count||0) - (a.like_count||0));
      } else {
        page.sort((a,b)=> String(b.published_at||"").localeCompare(String(a.published_at||"")));
      }
      if(range === "oldest") page.reverse();

      const seen = new Set(libraryItems.map(x=> String(x.id)));
      for(const it of page){
        const k = String(it.id);
        if(!seen.has(k)){ seen.add(k); libraryItems.push(it); }
      }

      state.offset = (j.nextOffset != null) ? j.nextOffset : (state.offset + page.length);
      state.hasMore = !!j.hasMore;
      state.loadedOnce = true;

      requestAnimationFrame(()=> renderLibrary());
      if(profile) renderProfileCover(profile);
    }catch(e){
      if(e?.name !== "AbortError"){
        renderErrorForTab("library", e.message || "Failed");
        state.hasMore = false;
      }
    }finally{
      state.loading = false;
      showLoader(false);
    }
  }

  async function loadPosts(reset=false, opts={}){
    const state = tabState.posts;
    if(state.loading) return;
    state.loading = true;
    showLoader(true);

    try{
      if(reset){ state.offset = 0; state.hasMore = true; postItems = []; }

      const j = await api(`/api/posts/list?username=${encodeURIComponent(username)}&limit=${PAGE_SIZE}&offset=${state.offset}&sort=new`, { method:"GET", signal: opts.signal });
      const page = Array.isArray(j.items) ? j.items : [];

      const seen = new Set(postItems.map(x=> String(x.id)));
      for(const it of page){
        const k = String(it.id);
        if(!seen.has(k)){ seen.add(k); postItems.push(it); }
      }

      state.offset = j.nextOffset != null ? j.nextOffset : (state.offset + page.length);
      state.hasMore = !!j.hasMore;
      state.loadedOnce = true;

      const token = await getSessionToken();
      if(token){
        for(const p of page){
          try{
            const st = await api(`/api/posts/state?post_id=${encodeURIComponent(p.id)}`, { method:"GET" });
            p._liked = !!st.liked;
            p._saved = !!st.saved;
          }catch(e){}
        }
      }

      // preload library first page if empty (so media viewer can open)
      if(!libraryItems.length){
        try{ await loadLibrary(true); }catch(e){}
      }

      requestAnimationFrame(()=> renderPosts());
    }catch(e){
      if(e?.name !== "AbortError"){
        renderErrorForTab("posts", e.message || "Failed");
        state.hasMore = false;
      }
    }finally{
      state.loading = false;
      showLoader(false);
    }
  }

  async function loadCollections(reset=false, opts={}){
    const state = tabState.collections;
    if(state.loading) return;
    state.loading = true;
    showLoader(true);

    try{
      if(reset){ state.offset = 0; state.hasMore = true; collectionItems = []; }

      const j = await api(`/api/collections/list?username=${encodeURIComponent(username)}&limit=${PAGE_SIZE}&offset=${state.offset}&sort=${encodeURIComponent(sort)}&preview_limit=10`, { method:"GET", signal: opts.signal });
      const page = Array.isArray(j.items) ? j.items : [];

      const seen = new Set(collectionItems.map(x=> String(x.id)));
      for(const it of page){
        const k = String(it.id);
        if(!seen.has(k)){ seen.add(k); collectionItems.push(it); }
      }

      const token = await getSessionToken();
      if(token){
        for(const c of collectionItems){
          try{
            const st = await api(`/api/collections/state?collection_id=${encodeURIComponent(c.id)}`, { method:"GET" });
            c._liked = !!st.liked;
            c._saved = !!st.saved;
          }catch(e){}
        }
      }

      state.offset = j.nextOffset != null ? j.nextOffset : (state.offset + page.length);
      state.hasMore = !!j.hasMore;
      state.loadedOnce = true;

      renderCollections();
      startCollectionsSlideshows();
    }catch(e){
      if(e?.name !== "AbortError"){
        renderErrorForTab("collections", e.message || "Failed");
        state.hasMore = false;
      }
    }finally{
      state.loading = false;
      showLoader(false);
    }
  }

  // -------- Render: POSTS ----------
  // marker: [[collection:UUID]]
  function parseBodyWithEmbeds(text){
    const s = String(text||"");
    const re = /\[\[collection:([0-9a-fA-F-]{36})\]\]/g;
    const parts = [];
    let last = 0;
    let m;
    while((m = re.exec(s))){
      const idx = m.index;
      if(idx > last) parts.push({ type:"text", value: s.slice(last, idx) });
      parts.push({ type:"collection", id: m[1] });
      last = idx + m[0].length;
    }
    if(last < s.length) parts.push({ type:"text", value: s.slice(last) });
    return parts;
  }


  function myAvatarHTML(){
    const letter = ((myProfile?.display_name || myProfile?.username || "U").trim().slice(0,1) || "U").toUpperCase();
    if(!myProfile){
      return `<div class="avatar" style="display:flex;align-items:center;justify-content:center;font-weight:950;color:#fff">${letter}</div>`;
    }
    const em = myProfile.avatar_type === "emoji" && myProfile.avatar_emoji;
    if(em) return `<div class="avatar emoji"><span>${escapeHtml(myProfile.avatar_emoji)}</span></div>`;
    if(myProfile.avatar_url) return `<div class="avatar"><img src="${escapeHtml(myProfile.avatar_url)}"></div>`;
    return `<div class="avatar" style="display:flex;align-items:center;justify-content:center;font-weight:950;color:#fff">${letter}</div>`;
  }


  function autoGrow(ta){
    if(!ta) return;
    ta.style.height = "auto";
    ta.style.height = Math.min(ta.scrollHeight, 180) + "px";
  }

  function renderPosts(){
    if(!postItems.length){
      $grid.innerHTML = `<div class="empty">No posts yet.</div>`;
      return;
    }

    const avIsEmoji = (profile?.avatar_type === "emoji" && profile?.avatar_emoji);
    const avatarHtml = avIsEmoji
      ? `<span>${escapeHtml(profile?.avatar_emoji || "")}</span>`
      : (profile?.avatar_url ? `<img src="${escapeHtml(profile.avatar_url)}" />` : "");

    $grid.innerHTML = `
      <div class="feed" id="feed">
        ${postItems.map((p, idx)=>{
          const media = Array.isArray(p.media) ? p.media : [];
          const parts = parseBodyWithEmbeds(p.body || "");

          const bodyHtml = parts.map(part=>{
            if(part.type === "text"){
              return `<span>${escapeHtml(part.value)}</span>`;
            }
            // collection embed placeholder; will hydrate after render
            return `<div class="embed-collection" data-embed-col="${escapeHtml(part.id)}">
                      <div class="embed-bg" data-embed-bg="${escapeHtml(part.id)}"></div>
                      <div class="embed-overlay">
                        <div class="embed-title">Collection</div>
                        <div class="embed-desc">Loading…</div>
                      </div>
                    </div>`;
          }).join("");

          const hasSlider = media.length > 0;
          const sliderId = `ps_${p.id.replaceAll("-","")}`;

          return `
            <div class="post" data-post="${escapeHtml(p.id)}">
              <div class="post-head">
                <div class="avatar ${avIsEmoji ? "emoji" : ""}">${avatarHtml}</div>
                <div class="post-meta">
                  <div class="post-name">${escapeHtml(p.display_name || p.username || username)} ${verifiedBadgeHTML(p.verified === true)}</div>
                  <div class="post-time">${escapeHtml(fmtDate(p.created_at))}</div>
                </div>
              </div>

              <div class="post-body">${bodyHtml}</div>

              ${hasSlider ? `
                <div class="pslider" data-slider="${sliderId}">
                  <div class="pslide" data-slide></div>
                  ${media.length > 1 ? `<button class="pnav prev" data-prev>‹</button><button class="pnav next" data-next>›</button>` : ``}
                  ${media.length > 1 ? `<div class="pdots" data-dots></div>` : ``}
                </div>
              ` : ``}

              <div class="post-actions">
                <button class="mini ${p._liked ? "on like" : ""}" data-act="like" data-post="${escapeHtml(p.id)}">${ICONS.like}<span>${p.like_count||0}</span></button>
                <button class="mini" data-act="toggle-comments" data-post="${escapeHtml(p.id)}">${ICONS.comm}<span>${p.comment_count||0}</span></button>
                <button class="mini ${p._saved ? "on save" : ""}" data-act="save" data-post="${escapeHtml(p.id)}">${ICONS.save}<span>${p.save_count||0}</span></button>
                <div class="mini" style="pointer-events:none;opacity:.9">${ICONS.view}<span>${p.view_count||0}</span></div>

                ${isOwnProfile ? `
                  <button class="mini" data-act="edit" data-post="${escapeHtml(p.id)}">${ICONS.edit}<span>Edit</span></button>
                  <button class="mini danger" data-act="delete" data-post="${escapeHtml(p.id)}">${ICONS.trash}<span>Delete</span></button>
                ` : ``}
              </div>

              <div class="pc" data-comments="${escapeHtml(p.id)}" style="display:${(p.comment_count||0)>0 ? "flex" : "none"};">
                <div class="pc-list" id="pc-list-${escapeHtml(p.id)}"><div class="empty" style="padding:18px">Loading…</div></div>
                <button class="btn-ghost" data-viewall="${escapeHtml(p.id)}" style="align-self:flex-start;">View all comments</button>
                <div class="pc-form">
                  ${myAvatarHTML()}
                  <textarea class="pc-input pc-ta" id="pc-in-${escapeHtml(p.id)}" rows="1" placeholder="Write a comment…"></textarea>
                  <button class="mini" type="button" data-emo="${escapeHtml(p.id)}">Emoji</button>
                  <button class="pc-send" data-send="${escapeHtml(p.id)}">${ICONS.send}</button>
                </div>
              </div>

              ${idx < postItems.length-1 ? `<div class="feed-sep"></div>` : ``}
            </div>
          `;
        }).join("")}
      </div>
    `;

    bindVerifiedTooltip($grid);

    // init sliders for each post
    postItems.forEach(p=>{
      const media = Array.isArray(p.media) ? p.media : [];
      if(!media.length) return;
      initPostSlider(p.id, media);
    });

    // hydrate collection embeds
    hydrateCollectionEmbeds();

    // actions
    $grid.querySelectorAll("[data-act]").forEach(btn=>{
      btn.onclick = async ()=>{
        const act = btn.getAttribute("data-act");
        const pid = btn.getAttribute("data-post");
        const post = postItems.find(x=> String(x.id)===String(pid));
        if(!post) return;

        if(act === "like"){
          try{
            await requireToken();
            const endpoint = post._liked ? "/api/posts/unlike" : "/api/posts/like";
            const j = await api(endpoint, { method:"POST", body: JSON.stringify({ post_id: pid }) });
            post._liked = !post._liked;
            if(j?.counts){
              post.like_count = j.counts.like_count;
              post.comment_count = j.counts.comment_count;
              post.save_count = j.counts.save_count;
              post.view_count = j.counts.view_count;
            }
            renderPosts();
          }catch(e){ toast(e.message||"Failed"); }
        }

        if(act === "save") {
          try{
            await requireToken();
            const endpoint = post._saved ? "/api/posts/unsave" : "/api/posts/save";
            const j = await api(endpoint, { method:"POST", body: JSON.stringify({ post_id: pid }) });
            post._saved = !post._saved;
            if(j?.counts){
              post.like_count = j.counts.like_count;
              post.comment_count = j.counts.comment_count;
              post.save_count = j.counts.save_count;
              post.view_count = j.counts.view_count;
            }
            renderPosts();
          }catch(e){ toast(e.message||"Failed"); }
        }

        if(act === "toggle-comments"){
          const box = $grid.querySelector(`[data-comments="${CSS.escape(pid)}"]`);
          if(!box) return;
          const willShow = box.style.display === "none";
          box.style.display = willShow ? "flex" : "none";
          if(willShow){
            await loadPostComments(pid);
          }
        }

        if(act === "edit"){
          openPostSheet("edit", post);
        }

        if(act === "delete"){
          if(!confirm("Delete this post?")) return;
          try{
            await requireToken();
            await api("/api/posts/delete", { method:"POST", body: JSON.stringify({ post_id: pid }) });
            postItems = postItems.filter(x=> String(x.id) !== String(pid));
            renderPosts();
            toast("Deleted");
          }catch(e){ toast(e.message||"Failed"); }
        }
      };
    });

    // send comment buttons
    $grid.querySelectorAll("[data-send]").forEach(btn=>{
      btn.onclick = () => sendPostComment(btn.getAttribute("data-send"));
    });

    $grid.querySelectorAll("[data-emo]").forEach(b=>{
      b.onclick = ()=>{
        const pid = b.getAttribute("data-emo");
        const inp = document.getElementById("pc-in-" + pid);
        if(inp) openEmojiPicker(inp);
      };
    });

    document.querySelectorAll(".pc-ta").forEach(ta=>{
      if(ta.dataset.growBound==="1") return;
      ta.dataset.growBound="1";

      ta.addEventListener("focus", ()=> autoGrow(ta));
      ta.addEventListener("input", ()=> autoGrow(ta));

      ta.addEventListener("keydown", (e)=>{
        if(e.key==="Enter" && !e.shiftKey){
          e.preventDefault();
          const pid = ta.id.replace("pc-in-","");
          sendPostComment(pid);
        }
      });
    });

    $grid.querySelectorAll("[data-viewall]").forEach(b=>{
      const pid = b.getAttribute("data-viewall");
      const post = postItems.find(x=> String(x.id) === String(pid));
      if(!post || (post.comment_count||0) <= 3) b.style.display = "none";
      b.onclick = async ()=>{
        postCommentsMode.set(pid, "all");
        await loadPostComments(pid);
        b.style.display = "none";
      };
    });

    postItems.forEach(p=>{
      if((p.comment_count||0) > 0){
        loadPostComments(p.id);
      }
    });

    // count views once per post render (dedupe server-side)
    postItems.forEach(p=>{
      if(p._viewed) return;
      p._viewed = true;
      const client_id = (crypto?.randomUUID ? crypto.randomUUID() : String(Date.now()) + Math.random());
      api("/api/posts/view", { method:"POST", body: JSON.stringify({ post_id: p.id, client_id }) }).catch(()=>{});
    });
  }

  async function loadPostComments(post_id){
    const listEl = document.getElementById("pc-list-" + post_id);
    if(!listEl) return;
    listEl.innerHTML = `<div class="empty" style="padding:18px">Loading…</div>`;
    try{
      const mode = postCommentsMode.get(post_id) || "preview";
      const limit = mode === "all" ? 80 : 3;
      const j = await api(`/api/posts/comments?post_id=${encodeURIComponent(post_id)}&limit=${limit}&offset=0`, { method:"GET" });
      const arr = Array.isArray(j.items) ? j.items : [];
      if(!arr.length){
        listEl.innerHTML = `<div class="empty" style="padding:18px">No comments yet.</div>`;
        return;
      }

      const myId = myUserId ? String(myUserId) : "";
      listEl.innerHTML = arr.map(c=>{
        const avEmoji = (c.avatar_type === "emoji" && c.avatar_emoji);
        const avHtml = avEmoji ? `<span>${escapeHtml(c.avatar_emoji)}</span>` : (c.avatar_url ? `<img src="${escapeHtml(c.avatar_url)}" />` : "");
        const isMine = myId && String(c.user_id) === myId;
        const canDelete = isMine || (isOwnProfile === true);
        const canEdit = isMine;
        return `
          <div class="pc-item" id="c-${escapeHtml(c.id)}" data-reply-to="${escapeHtml(c.reply_to_comment_id || "")}">
            <a href="/artist?username=${encodeURIComponent(c.username||"")}" class="pc-ava-link"><div class="avatar ${avEmoji ? "emoji" : ""}">${avHtml}</div></a>
            <div class="pc-bubble">
              <div class="pc-top">
                <a class="pc-name" href="/artist?username=${encodeURIComponent(c.username||"")}">
                  ${escapeHtml(c.display_name||c.username||"user")}
                  ${c.verified ? `<span class="vfy" data-tip="verified">${VERIFIED_SVG}</span>` : ``}
                </a>
                <div style="margin-left:auto;display:flex;gap:8px;align-items:center;">
                  <button class="cic ${c.liked_by_me ? "on" : ""}" data-clike="${escapeHtml(c.id)}" title="Like">
                    ${ICONS.like}<span>${c.like_count||0}</span>
                  </button>
                </div>
              </div>
              <div class="pc-body" data-body="${c.id}">${linkifyMentions(c.body||"")}</div>
              <div class="pc-edit" data-editbox="${c.id}" style="display:none; margin-top:10px;">
                <textarea class="pc-edit-ta" data-ta="${c.id}"></textarea>
                <div style="display:flex;gap:10px;align-items:center;justify-content:flex-end;margin-top:8px;">
                  <button class="mini" data-emo-edit="${c.id}">Emoji</button>
                  <button class="mini" data-c-cancel="${c.id}">Cancel</button>
                  <button class="mini on save" data-c-save="${c.id}">Save</button>
                </div>
              </div>
              <div class="pc-footer">
                <div class="pc-time">${escapeHtml(fmtDate(c.created_at))}</div>

                <div class="pc-actions">
                  ${canEdit ? `<button class="cact" data-c-edit="${escapeHtml(c.id)}" title="Edit">${ICONS.edit}</button>` : ""}
                  <button class="cact" data-c-reply="${escapeHtml(c.id)}" data-u="${escapeHtml(c.username||"")}" title="Reply">${ICONS.comm}</button>
                  ${canDelete ? `<button class="cact danger" data-c-del="${escapeHtml(c.id)}" title="Delete">${ICONS.trash}</button>` : ""}
                </div>
              </div>
            </div>
          </div>
        `;
      }).join("");

      bindVerifiedTooltip(listEl);

      listEl.querySelectorAll("[data-clike]").forEach(btn=>{
        btn.onclick = async ()=>{
          const cid = btn.getAttribute("data-clike");
          const row = arr.find(x=> String(x.id)===String(cid));
          if(!row) return;
          try{
            await requireToken();
            const endpoint = row.liked_by_me ? "/api/posts/comment_unlike" : "/api/posts/comment_like";
            const r = await api(endpoint, { method:"POST", body: JSON.stringify({ comment_id: cid }) });
            row.liked_by_me = !row.liked_by_me;
            row.like_count = r.like_count ?? row.like_count;
            await loadPostComments(post_id);
          }catch(e){
            toast(e.message||"Failed");
          }
        };
      });

      listEl.querySelectorAll("[data-c-del]").forEach(btn=>{
        btn.onclick = async ()=>{
          const cid = btn.getAttribute("data-c-del");
          if(!cid) return;
          const ok = await confirmUI("Delete comment", "Are you sure you want to delete this comment?");
          if(!ok) return;
          try{
            await requireToken();
            await api("/api/posts/comment_delete", { method:"POST", body: JSON.stringify({ comment_id: cid }) });
            const p = postItems.find(x=> String(x.id)===String(post_id));
            if(p) p.comment_count = Math.max((p.comment_count||0) - 1, 0);
            const commentsBtn = $grid.querySelector(`[data-act="toggle-comments"][data-post="${CSS.escape(String(post_id))}"] span`);
            if(commentsBtn && p) commentsBtn.textContent = String(p.comment_count||0);
            await loadPostComments(post_id);
            toast("Deleted");
          }catch(e){
            toast(e.message||"Failed");
          }
        };
      });

      listEl.querySelectorAll("[data-c-edit]").forEach(btn=>{
        btn.onclick = ()=>{
          const cid = btn.getAttribute("data-c-edit");
          const bodyEl = listEl.querySelector(`[data-body="${CSS.escape(cid)}"]`);
          const boxEl = listEl.querySelector(`[data-editbox="${CSS.escape(cid)}"]`);
          const ta = listEl.querySelector(`[data-ta="${CSS.escape(cid)}"]`);
          if(!bodyEl || !boxEl || !ta) return;
          ta.value = bodyEl.textContent || "";
          boxEl.style.display = "block";
          ta.focus();
        };
      });

      listEl.querySelectorAll("[data-c-cancel]").forEach(btn=>{
        btn.onclick = ()=>{
          const cid = btn.getAttribute("data-c-cancel");
          const boxEl = listEl.querySelector(`[data-editbox="${CSS.escape(cid)}"]`);
          if(boxEl) boxEl.style.display = "none";
        };
      });

      listEl.querySelectorAll("[data-c-save]").forEach(btn=>{
        btn.onclick = async ()=>{
          const cid = btn.getAttribute("data-c-save");
          const ta = listEl.querySelector(`[data-ta="${CSS.escape(cid)}"]`);
          if(!ta) return;
          const text = (ta.value||"").trim();
          if(!text) return toast("Empty");
          try{
            await requireToken();
            await api("/api/posts/comment_edit", { method:"POST", body: JSON.stringify({ comment_id: cid, body: text }) });
            await loadPostComments(post_id);
            toast("Updated");
          }catch(e){
            toast(e.message||"Failed");
          }
        };
      });

      listEl.querySelectorAll("[data-emo-edit]").forEach(btn=>{
        btn.onclick = ()=>{
          const cid = btn.getAttribute("data-emo-edit");
          const ta = listEl.querySelector(`[data-ta="${CSS.escape(cid)}"]`);
          if(ta) openEmojiPicker(ta);
        };
      });

      listEl.querySelectorAll("[data-c-reply]").forEach(btn=>{
        btn.onclick = ()=>{
          const cid = btn.getAttribute("data-c-reply");
          const uname = btn.getAttribute("data-u") || "";
          replyToByPost.set(post_id, { comment_id: cid, username: uname });
          const inp = document.getElementById("pc-in-" + post_id);
          if(!inp) return;
          inp.value = (inp.value||"") + `@${uname} `;
          inp.focus();
          autoGrow(inp);
        };
      });

      const post = postItems.find(x=> String(x.id) === String(post_id));
      const viewAllBtn = $grid.querySelector(`[data-viewall="${CSS.escape(post_id)}"]`);
      if(viewAllBtn){
        if(mode === "all") viewAllBtn.style.display = "none";
        else if(arr.length < 3 || (post?.comment_count||0) <= 3) viewAllBtn.style.display = "none";
        else viewAllBtn.style.display = "inline-flex";
      }
      listEl.scrollTop = listEl.scrollHeight;
    }catch(e){
      listEl.innerHTML = `<div class="empty" style="padding:18px;color:#ff98a2">Error: ${escapeHtml(e.message)}</div>`;
    }
  }


  async function sendPostComment(post_id){
    try{
      await requireToken();
      const inp = document.getElementById("pc-in-" + post_id);
      if(!inp) return;
      const text = (inp.value||"").trim();
      if(!text) return;
      inp.disabled = true;
      const rt = replyToByPost.get(post_id);
      await api("/api/posts/comment", {
        method:"POST",
        body: JSON.stringify({
          post_id,
          body:text,
          reply_to_comment_id: rt?.comment_id || null
        })
      });
      replyToByPost.delete(post_id);
      inp.value = "";
      autoGrow(inp);
      await loadPostComments(post_id);

      // refresh counts locally
      const p = postItems.find(x=> String(x.id)===String(post_id));
      if(p) p.comment_count = (p.comment_count||0) + 1;
      const commentsBtn = $grid.querySelector(`[data-act="toggle-comments"][data-post="${CSS.escape(String(post_id))}"] span`);
      if(commentsBtn && p) commentsBtn.textContent = String(p.comment_count||0);
    }catch(e){
      replyToByPost.delete(post_id);
      toast(e.message||"Failed");
    }finally{
      const inp = document.getElementById("pc-in-" + post_id);
      if(inp) inp.disabled = false;
    }
  }

  // Post slider init
  function initPostSlider(postId, mediaArr){
    const sliderId = `ps_${postId.replaceAll("-","")}`;
    const host = $grid.querySelector(`[data-slider="${CSS.escape(sliderId)}"]`);
    if(!host) return;

    let idx = 0;
    const $slide = host.querySelector("[data-slide]");
    const $prev = host.querySelector("[data-prev]");
    const $next = host.querySelector("[data-next]");
    const $dots = host.querySelector("[data-dots]");
    const imgEl = document.createElement("img");
    imgEl.loading = "lazy";
    imgEl.decoding = "async";
    const vidEl = document.createElement("video");
    vidEl.setAttribute("playsinline", "");
    vidEl.controls = true;
    $slide.innerHTML = "";
    $slide.appendChild(imgEl);
    $slide.appendChild(vidEl);

    function set(i){
      idx = (i + mediaArr.length) % mediaArr.length;
      const item = mediaArr[idx];
      const url = (item.media_url || item.thumb_url || "").trim();
      const isV = isVideoUrl(url);

      if(isV){
        imgEl.style.display = "none";
        vidEl.style.display = "block";
        if(vidEl.getAttribute("src") !== url){
          vidEl.pause();
          vidEl.setAttribute("src", url);
          vidEl.load();
        }
      } else {
        vidEl.pause();
        vidEl.style.display = "none";
        imgEl.style.display = "block";
        const nextSrc = (item.thumb_url || item.media_url || "").trim();
        if(imgEl.getAttribute("src") !== nextSrc){
          imgEl.setAttribute("src", nextSrc);
        }
      }

      // click opens Media Viewer slider for whole post
      $slide.onclick = () => {
        openMediaViewer(
          mediaArr.map(m => ({
            title: m.title || "Untitled",
            url: (m.media_url || m.thumb_url || "").trim(),
            thumb: (m.thumb_url || m.media_url || "").trim(),
            isVideo: isVideoUrl((m.media_url || m.thumb_url || "").trim())
          })),
          idx,
          (newIndex)=>{ set(newIndex); }
        );
      };

      if($dots){
        $dots.innerHTML = mediaArr.map((_,k)=> `<button class="${k===idx?'on':''}" data-dot="${k}"></button>`).join("");
        $dots.querySelectorAll("[data-dot]").forEach(b=>{
          b.onclick = (e)=>{ e.stopPropagation(); set(Number(b.getAttribute("data-dot"))); };
        });
      }
    }

    if($prev) $prev.onclick = (e)=>{ e.stopPropagation(); set(idx-1); };
    if($next) $next.onclick = (e)=>{ e.stopPropagation(); set(idx+1); };

    // basic swipe
    let startX = null;
    $slide.addEventListener("touchstart", (e)=>{ startX = e.touches[0].clientX; }, {passive:true});
    $slide.addEventListener("touchend", (e)=>{
      if(startX==null) return;
      const dx = e.changedTouches[0].clientX - startX;
      startX = null;
      if(Math.abs(dx) < 40) return;
      if(dx < 0) set(idx+1); else set(idx-1);
    }, {passive:true});

    set(0);
  }

  // -------- Render: COLLECTIONS ----------
  function renderCollections(){
    if(!collectionItems.length){
      $grid.innerHTML = `<div class="empty">No collections yet.</div>`;
      return;
    }

    $grid.innerHTML = `
      <div class="cgrid" id="cgridRoot">
        ${collectionItems.map(c=>{
          const prev = Array.isArray(c.preview_items) ? c.preview_items : [];
          // Use thumbs only for slideshow
          const imgs = prev
            .map(x => (x.thumb_url || x.media_url || "").trim())
            .filter(Boolean)
            .slice(0, 10);

          return `
            <div class="ccard" data-col="${escapeHtml(c.id)}">
              <div class="cc-bg" data-ccbg="${escapeHtml(c.id)}">
                ${imgs.map((u,i)=> isVideoUrl(u) ? `<video muted playsinline preload="metadata" src="${escapeHtml(u)}" class="${i===0?'on':''}"></video>` : `<img src="${escapeHtml(u)}" class="${i===0?'on':''}" />`).join("")}
              </div>
              <div class="cc-glass">
                <div>
                  <div class="cc-title">${escapeHtml(c.title || "Untitled collection")}</div>
                  <div class="cc-desc">${escapeHtml(c.description || "")}</div>
                </div>
                <div class="cc-meta">
                  <div class="cc-pill" data-clike="${escapeHtml(c.id)}">${ICONS.like} <b>${c.like_count||0}</b></div>
                  <div class="cc-pill">${ICONS.view} <b>${c.view_count||0}</b></div>
                  <div class="cc-pill ${c._saved ? "mini on save" : ""}" data-csave="${escapeHtml(c.id)}">${ICONS.save} <b>${c.save_count||0}</b></div>
                </div>
              </div>
            </div>
          `;
        }).join("")}
      </div>
    `;

    $grid.querySelectorAll("[data-col]").forEach(el=>{
      el.onclick = () => openCollectionModal(el.getAttribute("data-col"));
    });

    $grid.querySelectorAll("[data-clike]").forEach(el=>{
      el.onclick = async (e)=>{
        e.stopPropagation();
        const id = el.getAttribute("data-clike");
        const col = collectionItems.find(x=> String(x.id)===String(id));
        if(!col) return;
        try{
          await requireToken();
          const endpoint = col._liked ? "/api/collections/unlike" : "/api/collections/like";
          const j = await api(endpoint, { method:"POST", body: JSON.stringify({ collection_id:id }) });
          col._liked = !col._liked;
          if(j?.counts){
            col.like_count = j.counts.like_count;
            col.save_count = j.counts.save_count;
            col.view_count = j.counts.view_count;
          }
          renderCollections();
          startCollectionsSlideshows();
        }catch(e){
          toast(e.message||"Failed");
        }
      };
    });

    $grid.querySelectorAll("[data-csave]").forEach(el=>{
      el.onclick = async (e)=>{
        e.stopPropagation();
        const id = el.getAttribute("data-csave");
        const col = collectionItems.find(x=> String(x.id)===String(id));
        if(!col) return;

        try{
          await requireToken();
          const endpoint = col._saved ? "/api/collections/unsave" : "/api/collections/save";
          const j = await api(endpoint, { method:"POST", body: JSON.stringify({ collection_id: id }) });
          col._saved = !col._saved;
          if(j?.counts){
            col.save_count = j.counts.save_count;
            col.like_count = j.counts.like_count;
            col.view_count = j.counts.view_count;
          }
          renderCollections();
          startCollectionsSlideshows();
        }catch(err){
          toast(err.message || "Failed");
        }
      };
    });

    bindVerifiedTooltip($grid);
  }

  function startCollectionsSlideshows(){
    document.querySelectorAll("[data-ccbg]").forEach(bg=>{
      if(bg.dataset.slBound === "1") return;
      bg.dataset.slBound = "1";
      const slides = Array.from(bg.querySelectorAll("img,video"));
      if(slides.length <= 1) return;

      let i = 0;
      setInterval(()=>{
        const prev = slides[i];
        prev.classList.remove("on");
        if(prev.tagName === "VIDEO"){ try{ prev.pause(); prev.currentTime = 0; }catch(e){} }
        i = (i+1) % slides.length;
        const cur = slides[i];
        cur.classList.add("on");
        if(cur.tagName === "VIDEO"){ try{ cur.play(); }catch(e){} }
      }, 1400);
    });
  }

  async function openCollectionModal(collection_id){
    currentCol = null;
    colReorderMode = false;
    dragFromIndex = null;

    $cb.classList.add("open");
    $ctitle.textContent = "Loading…";
    $cdesc.textContent = "";
    $cmeta.innerHTML = "";
    $cgrid.innerHTML = `<div class="empty" style="grid-column:1/-1">Loading…</div>`;
    $btnColEdit.style.display = "none";
    $btnSceneNew.style.display = "none";
    $btnColReorder.style.display = "none";
    $btnColDelete.style.display = "none";
    $colReorderFooter.classList.remove("open");
    colOriginalOrderIds = [];
    $btnColReorder.textContent = "Reorder";

    try{
      const j = await api(`/api/collections/get?id=${encodeURIComponent(collection_id)}`, { method:"GET" });
      const col = j.collection;
      const items = Array.isArray(j.items) ? j.items : [];
      const sections = Array.isArray(j.sections) ? j.sections : [];
      currentCol = { col, items, sections };

      $ctitle.textContent = col.title || "Untitled collection";
      $cdesc.textContent = col.description || "";
      $cmeta.innerHTML = `
        <div class="stat">${ICONS.like} ${col.like_count||0}</div>
        <div class="stat">${ICONS.view} ${col.view_count||0}</div>
        <div class="stat">${ICONS.save} ${col.save_count||0}</div>
      `;

      const film = j.film || null;
      renderCollectionFilmBlock(film, currentCol.col.id);

      // view count dedupe
      const client_id = (crypto?.randomUUID ? crypto.randomUUID() : String(Date.now()) + Math.random());
      api("/api/collections/view", { method:"POST", body: JSON.stringify({ collection_id: col.id, client_id }) }).catch(()=>{});

      if(isOwnProfile){
        $btnColEdit.style.display = "inline-flex";
        $btnSceneNew.style.display = "inline-flex";
        $btnColReorder.style.display = "inline-flex";
        $btnColDelete.style.display = "inline-flex";
      }

      // страховка: кнопки владельца всегда видны
      if(isOwnProfile){
        $btnColEdit.style.display = "inline-flex";
        $btnSceneNew.style.display = "inline-flex";
        $btnColReorder.style.display = "inline-flex";
        $btnColDelete.style.display = "inline-flex";
      }

      renderCollectionModalGrid();
    }catch(e){
      $cgrid.innerHTML = `<div class="empty" style="grid-column:1/-1;color:#ff98a2;border-color:rgba(255,70,90,0.3)">Error: ${escapeHtml(e.message)}</div>`;
    }
  }

  function renderCollectionModalGrid(){
    if(!currentCol) return;
    const items = currentCol.items || [];
    const sections = Array.isArray(currentCol.sections) ? currentCol.sections : [];
    if (!items.length && !sections.length) {
      $cgrid.innerHTML = `<div class="empty" style="grid-column:1/-1">Empty collection.</div>`;
      return;
    }

    const normalizedSections = sections.map(sc => ({
      id: sc.id == null ? null : String(sc.id),
      title: sc.title || "Scene",
      description: sc.description || ""
    }));
    const defaultItems = items.filter(it => !it.section_id);
    const scenes = normalizedSections.map(sc => ({
      id: sc.id,
      title: sc.title,
      description: sc.description,
      items: items.filter(it => String(it.section_id || "") === String(sc.id || ""))
    }));
    if(defaultItems.length || !scenes.length){
      scenes.push({ id: null, title: "Default", description: "", items: defaultItems.length ? defaultItems : items });
    }

    $cgrid.innerHTML = scenes.map((scene, sceneIdx)=>{
      const grid = scene.items.map((it, idx)=>{
        const url = (it.media_url || it.thumb_url || "").trim();
        const isV = isVideoUrl(url);
        const thumb = (it.thumb_url || it.media_url || "").trim();
        return `
          <div class="col-item" draggable="${(colReorderMode && !sections.length) ? "true" : "false"}" data-idx="${idx}" data-scene="${sceneIdx}">
            ${isV
              ? `<video muted playsinline preload="metadata" src="${escapeHtml(url)}"></video>`
              : `<img src="${escapeHtml(thumb)}" loading="lazy" decoding="async" />`
            }
            ${colReorderMode ? `
              <div class="drag-handle" title="Drag">
                <svg viewBox="0 0 24 24" fill="none">
                  <path d="M9 6h.01M9 12h.01M9 18h.01M15 6h.01M15 12h.01M15 18h.01" stroke="currentColor" stroke-width="3" stroke-linecap="round"/>
                </svg>
              </div>` : ``}
          </div>
        `;
      }).join("");

      return `
        <div class="scene" data-scene="${sceneIdx}">
          <div class="scene-head">
            <div>
              <div class="scene-title">${escapeHtml(scene.title || "Scene")}</div>
              ${scene.description ? `<div class="scene-desc">${escapeHtml(scene.description)}</div>` : ``}
            </div>
            ${isOwnProfile ? `
              <div class="scene-actions">
                <button class="btn-ghost" data-sc-add="${escapeHtml(String(scene.id ?? ""))}">+ Add</button>
                ${scene.id ? `<button class="btn-ghost" data-sc-edit="${escapeHtml(scene.id)}">Edit</button>` : ``}
                ${scene.id ? `<button class="btn-danger" data-sc-del="${escapeHtml(scene.id)}">Delete</button>` : ``}
              </div>
            ` : ``}
          </div>
          <div class="scene-grid">${grid || `<div class="empty" style="grid-column:1/-1">No items.</div>`}</div>
        </div>
      `;
    }).join("");

    $cgrid.querySelectorAll(".col-item").forEach(el=>{
      el.onclick = () => {
        if(colReorderMode) return;
        const sceneIndex = Number(el.getAttribute("data-scene") || "0");
        const idx = Number(el.getAttribute("data-idx") || "0");
        const scene = scenes[sceneIndex] || { items: [] };
        const viewerItems = scene.items.map(m=>{
          const url = (m.media_url || m.thumb_url || "").trim();
          return {
            title: m.title || "Untitled",
            url,
            thumb: (m.thumb_url || m.media_url || "").trim(),
            isVideo: isVideoUrl(url)
          };
        });
        openMediaViewer(viewerItems, idx, null);
      };
    });

    $cgrid.querySelectorAll("[data-sc-edit]").forEach(b=>{
      b.onclick = ()=>{
        const id = b.getAttribute("data-sc-edit");
        const sc = (currentCol.sections||[]).find(x=> String(x.id)===String(id));
        if(sc) openSceneSheet("edit", sc);
      };
    });

    $cgrid.querySelectorAll("[data-sc-add]").forEach(b=>{
      b.onclick = async ()=>{
        try{
          await requireToken();
          if(!currentCol) return;

          const sidRaw = b.getAttribute("data-sc-add");
          const section_id = sidRaw ? String(sidRaw).trim() : null;

          await ensureLibraryLoadedForPicker();

          const items = libraryItems.slice(0, 400).map(it=>({
            id: it.id,
            title: it.title || "Untitled",
            description: "",
            thumb: (it.thumb_url || it.media_url || ""),
            type: it.file_type || "",
            media_url: it.media_url || ""
          }));

          const picked = await openPicker("library", {
            title: "Add to scene",
            hint: "Select items (multi-select).",
            items,
            multi: true,
            layout: "wide",
            preselected: []
          });

          if(!Array.isArray(picked) || !picked.length) return;

          for(const fp of picked){
            await api("/api/collections/items/move", {
              method:"POST",
              body: JSON.stringify({
                collection_id: currentCol.col.id,
                feed_post_id: fp,
                to_section_id: section_id || null,
                to_index: 9999
              })
            });
          }

          const j = await api(`/api/collections/get?id=${encodeURIComponent(currentCol.col.id)}`, { method:"GET" });
          currentCol.sections = j.sections || [];
          currentCol.items = j.items || [];
          renderCollectionModalGrid();
          toast("Added");
        }catch(e){
          toast(e.message || "Failed");
        }
      };
    });

    $cgrid.querySelectorAll("[data-sc-del]").forEach(b=>{
      b.onclick = async ()=>{
        const id = b.getAttribute("data-sc-del");
        const ok = await confirmUI("Delete scene", "Scene will be removed. Items will return to Default.", "Delete", true);
        if(!ok) return;
        try{
          await requireToken();
          await api("/api/collections/sections/delete", { method:"POST", body: JSON.stringify({ section_id:id }) });
          const j = await api(`/api/collections/get?id=${encodeURIComponent(currentCol.col.id)}`, { method:"GET" });
          currentCol.sections = j.sections || [];
          currentCol.items = j.items || [];
          renderCollectionModalGrid();
          toast("Deleted");
        }catch(e){ toast(e.message||"Failed"); }
      };
    });

    $colReorderFooter.classList.toggle("open", !!colReorderMode && !sections.length);
    $btnColReorder.textContent = colReorderMode ? "Exit" : "Reorder";
    if(colReorderMode) bindDnD(scenes);
  }

  function renderCollectionFilmBlock(film, collectionId){
    if(!$colFilm) return;

    // 2) Публичным зрителям НЕ показываем статус отправки/пендинг
    if(!isOwnProfile && film && film.status !== "approved"){
      $colFilm.style.display = "none";
      $colFilm.innerHTML = "";
      return;
    }

    // APPROVED: красивая кинематографичная шапка
    if(film && film.status === "approved" && film.published_url){
      $colFilm.style.display = "block";

      const t = (film.title || "Film").trim();
      const d = (film.description || "").trim();

      $colFilm.innerHTML = `
        <div class="film-hero">
          <div class="film-media">
            <video controls playsinline preload="metadata" src="${escapeHtml(film.published_url)}"></video>
          </div>
          <div class="film-caption">
            <h3 class="film-title">${escapeHtml(t)}</h3>
            ${d ? `
              <div class="film-desc" id="filmDesc">${escapeHtml(d)}</div>
              <button class="film-more" id="filmMore" type="button" aria-label="Toggle description">
                <span>Read more</span>
                <svg viewBox="0 0 24 24" fill="none" aria-hidden="true">
                  <path d="M6 9l6 6 6-6" stroke="currentColor" stroke-width="2.4" stroke-linecap="round" stroke-linejoin="round"/>
                </svg>
              </button>
            ` : ``}
          </div>
        </div>
      `;

      const more = document.getElementById("filmMore");
      const desc = document.getElementById("filmDesc");
      if(more && desc){
        more.onclick = ()=>{
          const on = desc.classList.toggle("open");
          const label = more.querySelector("span");
          const icon = more.querySelector("svg");
          if(label) label.textContent = on ? "Hide" : "Read more";
          if(icon) icon.style.transform = on ? "rotate(180deg)" : "rotate(0deg)";
        };
      }
      return;
    }

    // PENDING: показываем ТОЛЬКО владельцу (isOwnProfile)
    if(isOwnProfile && film && film.status === "pending"){
      $colFilm.style.display = "block";
      $colFilm.innerHTML = `
        <div class="col-film">
          <h3 style="margin:0;">Film submission</h3>
          <p style="margin-top:8px;"><span class="pill">Pending review</span></p>
          <p>We’ll review it within 1–2 days.</p>
        </div>
      `;
      return;
    }

    // Нет фильма: показываем кнопку submit ТОЛЬКО владельцу
    if(!isOwnProfile){
      $colFilm.style.display = "none";
      $colFilm.innerHTML = "";
      return;
    }

    $colFilm.style.display = "block";
    $colFilm.innerHTML = `
      <div class="col-film" style="display:flex;justify-content:space-between;gap:12px;align-items:center;flex-wrap:wrap;">
        <div>
          <h3 style="margin:0;">Your film</h3>
          <p style="margin-top:6px;">You can submit a short film for review.</p>
        </div>
        <button class="btn-primary" id="openFilmSubmit">Submit film</button>
      </div>
    `;

    const btn = document.getElementById("openFilmSubmit");
    if(btn) btn.onclick = ()=> openFilmSheet(collectionId);
  }

  function bindDnD(scenes){
    const sceneNodes = Array.from($cgrid.querySelectorAll(".scene"));
    sceneNodes.forEach(scEl=>{
      const sceneIdx = Number(scEl.getAttribute("data-scene"));
      const sc = scenes?.[sceneIdx];
      const canDragScene = !!(sc && sc.id);

      scEl.setAttribute("draggable", canDragScene ? "true" : "false");

      scEl.addEventListener("dragstart", (ev)=>{
        if(!canDragScene) return ev.preventDefault();
        scEl.classList.add("dragging");
        ev.dataTransfer.effectAllowed = "move";
        scEl.dataset.dragType = "scene";
        scEl.dataset.dragFrom = String(sceneIdx);
      });

      scEl.addEventListener("dragend", ()=>{
        scEl.classList.remove("dragging");
        delete scEl.dataset.dragType;
        delete scEl.dataset.dragFrom;
      });

      scEl.addEventListener("dragover", (ev)=>{
        if(!canDragScene) return;
        ev.preventDefault();
        ev.dataTransfer.dropEffect = "move";
      });

      scEl.addEventListener("drop", (ev)=>{
        ev.preventDefault();
        const fromIdx = Number(document.querySelector(".scene.dragging")?.dataset.dragFrom);
        const toIdx = Number(scEl.getAttribute("data-scene"));
        if(Number.isNaN(fromIdx) || Number.isNaN(toIdx) || fromIdx === toIdx) return;

        const fromScene = scenes[fromIdx];
        const toScene = scenes[toIdx];
        if(!fromScene?.id || !toScene?.id) return;

        const order = scenes
          .filter(x=>x.id)
          .map(x=>String(x.id));

        const moved = order.splice(order.indexOf(String(fromScene.id)), 1)[0];
        order.splice(order.indexOf(String(toScene.id)), 0, moved);

        const byId = new Map((currentCol.sections||[]).map(s=>[String(s.id), s]));
        currentCol.sections = order.map(id=>byId.get(id)).filter(Boolean);

        renderCollectionModalGrid();
      });
    });

    const itemNodes = Array.from($cgrid.querySelectorAll(".col-item"));
    itemNodes.forEach(el=>{
      const sceneIndex = Number(el.getAttribute("data-scene") || "0");

      el.setAttribute("draggable", "true");

      el.addEventListener("dragstart", (ev)=>{
        el.classList.add("dragging");
        el.dataset.dragFromIdx = el.getAttribute("data-idx");
        el.dataset.dragFromScene = String(sceneIndex);
        ev.dataTransfer.effectAllowed = "move";
      });

      el.addEventListener("dragend", ()=>{
        el.classList.remove("dragging");
        delete el.dataset.dragFromIdx;
        delete el.dataset.dragFromScene;
      });

      el.addEventListener("dragover", (ev)=>{
        ev.preventDefault();
        ev.dataTransfer.dropEffect = "move";
      });

      el.addEventListener("drop", (ev)=>{
        ev.preventDefault();

        const fromScene = Number(document.querySelector(".col-item.dragging")?.dataset.dragFromScene);
        const fromIdx = Number(document.querySelector(".col-item.dragging")?.dataset.dragFromIdx);
        const toScene = Number(el.getAttribute("data-scene"));
        const toIdx = Number(el.getAttribute("data-idx"));

        if([fromScene,fromIdx,toScene,toIdx].some(Number.isNaN)) return;
        if(fromScene !== toScene) return;

        const sc = scenes[fromScene];
        if(!sc) return;

        const sectionId = sc.id ? String(sc.id) : "";
        const inScene = (currentCol.items||[]).filter(x => String(x.section_id||"") === sectionId);
        const others  = (currentCol.items||[]).filter(x => String(x.section_id||"") !== sectionId);

        const [moved] = inScene.splice(fromIdx, 1);
        inScene.splice(toIdx, 0, moved);

        currentCol.items = others.concat(inScene);
        renderCollectionModalGrid();
      });
    });
  }

  async function saveCollectionOrder(){
    if(!currentCol) return;
    await requireToken();

    const secs = Array.isArray(currentCol.sections) ? currentCol.sections : [];
    if(secs.length){
      const ordered_section_ids = secs.map(s=>s.id);
      try{
        await api("/api/collections/sections/reorder", {
          method:"POST",
          body: JSON.stringify({ collection_id: currentCol.col.id, ordered_section_ids })
        });
      }catch(e){
        console.warn("sections/reorder failed:", e);
      }
    }

    const ordered = (currentCol.items || []).map(x=> x.id);
    await api("/api/collections/reorder", {
      method:"POST",
      body: JSON.stringify({ id: currentCol.col.id, ordered_feed_post_ids: ordered })
    });
  }

  function closeCollectionModal(){
    $cb.classList.remove("open");
    currentCol = null;
    colReorderMode = false;
    colOriginalOrderIds = [];
    $colReorderFooter.classList.remove("open");
    $btnColReorder.textContent = "Reorder";
    dragFromIndex = null;
  }

  // -------- Render: LIBRARY ----------
  function renderLibrary(){
    const items = libraryItems;
    if(!items.length){
      $grid.innerHTML = `<div class="empty">No published works yet.</div>`;
      return;
    }

    const displayName = profile?.display_name || profile?.username || username;
    const userName = profile?.username || username;
    const avIsEmoji = (profile?.avatar_type === "emoji" && profile?.avatar_emoji);
    const avatarHtml = avIsEmoji
      ? `<span>${escapeHtml(profile?.avatar_emoji || "")}</span>`
      : (profile?.avatar_url ? `<img src="${escapeHtml(profile.avatar_url)}" />` : "");

    $grid.innerHTML = `
      <div class="lf-grid">
        ${items.map(it=>{
          const video = isVideoUrl(it.media_url || it.thumb_url);
          const media = (it.media_url || it.thumb_url || "").trim();

          const mediaHtml = video
            ? `
              <video class="lf-poster-video" muted playsinline preload="metadata" src="${escapeHtml(media)}"></video>
              <video class="lf-hover-video" muted playsinline preload="none">
                <source src="${escapeHtml(media)}" type="video/mp4">
              </video>
            `
            : `
              <img class="lf-thumb" src="${escapeHtml(it.thumb_url || it.media_url || "")}" loading="lazy" decoding="async" />
            `;

          return `
            <div class="lf-card" data-id="${escapeHtml(it.id)}">
              <div class="lf-media">
                ${mediaHtml}
                <div class="card-bottom">
                  <div class="card-author">
                    <div class="avatar ${avIsEmoji ? "emoji" : ""}">${avatarHtml}</div>
                    <div class="author-txt">
                      <div class="author-name">${escapeHtml(displayName)} ${verifiedBadgeHTML(profile?.verified === true)}</div>
                      <div class="author-username">@${escapeHtml(userName)}</div>
                    </div>
                  </div>
                  <div class="card-title">${escapeHtml(it.title||"Untitled")}</div>
                  <div class="card-stats">
                    <div class="stat">${ICONS.like} ${it.like_count||0}</div>
                    <div class="stat">${ICONS.comm} ${it.comment_count||0}</div>
                    <div class="stat">${ICONS.save} ${it.save_count||0}</div>
                    <div class="stat">${ICONS.view} ${it.view_count||0}</div>
                  </div>
                </div>
              </div>
            </div>
          `;
        }).join("")}
      </div>
    `;

    bindVerifiedTooltip($grid);

    $grid.querySelectorAll(".lf-card").forEach(c=>{
      c.onclick = () => {
        const id = c.getAttribute("data-id");
        const it = libraryItems.find(x=> String(x.id)===String(id));
        if(it) openWorkModal(it);
      };
    });

    wireHoverVideos();
    primePosterVideos();
  }

  function wireHoverVideos(){
    document.querySelectorAll(".lf-card").forEach(card=>{
      if(card.dataset.hoverBound === "1") return;
      card.dataset.hoverBound = "1";

      const v = card.querySelector("video.lf-hover-video");
      if(!v) return;

      card.addEventListener("mouseenter", async () => {
        try{ v.load(); await v.play(); }catch(e){}
      });
      card.addEventListener("mouseleave", () => {
        try{ v.pause(); v.currentTime = 0; }catch(e){}
      });
    });
  }
  function primePosterVideos(){
    document.querySelectorAll("video.lf-poster-video").forEach(v=>{
      if(v.dataset.primed === "1") return;
      v.dataset.primed = "1";
      v.addEventListener("loadeddata", () => {}, { once:true });
      v.load();
    });
  }

  // -------- Collection embeds inside posts ----------
  const embedCache = new Map(); // id -> {collection, items}
  async function hydrateCollectionEmbeds(){
    const nodes = Array.from(document.querySelectorAll("[data-embed-col]"));
    for(const el of nodes){
      const id = el.getAttribute("data-embed-col");
      if(!id) continue;
      if(el.dataset.hydrated === "1") continue;
      el.dataset.hydrated = "1";

      try{
        let data = embedCache.get(id);
        if(!data){
          const j = await api(`/api/collections/get?id=${encodeURIComponent(id)}`, { method:"GET" });
          data = j;
          embedCache.set(id, data);
        }
        const col = data.collection;
        const items = Array.isArray(data.items) ? data.items : [];
        el.querySelector(".embed-title").textContent = col.title || "Collection";
        el.querySelector(".embed-desc").textContent = col.description || "";

        // build bg slideshow
        const bg = el.querySelector("[data-embed-bg]");
        const thumbs = items
          .map(x => (x.thumb_url || x.media_url || "").trim())
          .filter(Boolean)
          .slice(0, 8);

        bg.innerHTML = thumbs.map((u,i)=> isVideoUrl(u)
          ? `<video muted playsinline preload="metadata" src="${escapeHtml(u)}" class="${i===0?'on':''}"></video>`
          : `<img src="${escapeHtml(u)}" class="${i===0?'on':''}" />`).join("");
        if(thumbs.length > 1){
          const slides = Array.from(bg.querySelectorAll("img,video"));
          let i = 0;
          setInterval(()=>{
            const prev = slides[i];
            prev.classList.remove("on");
            if(prev.tagName === "VIDEO"){ try{ prev.pause(); prev.currentTime = 0; }catch(e){} }
            i = (i+1) % slides.length;
            const cur = slides[i];
            cur.classList.add("on");
            if(cur.tagName === "VIDEO"){ try{ cur.play(); }catch(e){} }
          }, 1300);
        }

        el.onclick = () => openCollectionModal(id);
      }catch(e){
        el.querySelector(".embed-title").textContent = "Collection";
        el.querySelector(".embed-desc").textContent = "Failed to load";
      }
    }
  }

  // -------- Media Viewer ----------
  function openMediaViewer(items, startIndex=0, onChange=null){
    mvItems = Array.isArray(items) ? items : [];
    if(!mvItems.length) return;
    mvIndex = Math.max(0, Math.min(startIndex, mvItems.length-1));
    mvOnChange = (typeof onChange === "function") ? onChange : null;

    $mb.classList.remove("open");
    $mvb.classList.add("open");
    renderMediaViewer();
  }

  function closeMediaViewer(){
    $mvb.classList.remove("open");
    $mvHost.innerHTML = "";
    $mvDots.innerHTML = "";
    mvItems = [];
    mvIndex = 0;
    mvOnChange = null;
  }

  function renderMediaViewer(){
    const item = mvItems[mvIndex];
    if(!item) return;

    $mvTitle.textContent = (item.title || "—") + `  •  ${mvIndex+1}/${mvItems.length}`;

    // render media
    $mvHost.innerHTML = "";
    if(item.isVideo){
      const v = document.createElement("video");
      v.src = item.url;
      v.controls = true;
      v.playsInline = true;
      v.autoplay = true;
      v.className = "mv-media";
      $mvHost.appendChild(v);
    } else {
      const img = document.createElement("img");
      img.src = item.url || item.thumb;
      img.className = "mv-media";
      $mvHost.appendChild(img);
    }

    // dots
    $mvDots.innerHTML = mvItems.map((_,i)=> `<button class="${i===mvIndex?'on':''}" data-mvdot="${i}"></button>`).join("");
    $mvDots.querySelectorAll("[data-mvdot]").forEach(b=>{
      b.onclick = ()=> setMediaIndex(Number(b.getAttribute("data-mvdot")));
    });

    // nav visible?
    $mvPrev.style.display = mvItems.length > 1 ? "flex" : "none";
    $mvNext.style.display = mvItems.length > 1 ? "flex" : "none";
  }

  function setMediaIndex(i){
    if(!mvItems.length) return;
    mvIndex = (i + mvItems.length) % mvItems.length;
    renderMediaViewer();
    if(mvOnChange) mvOnChange(mvIndex);
  }

  // swipe for viewer
  function bindViewerSwipe(){
    let startX = null;
    $mvHost.addEventListener("touchstart", (e)=>{ startX = e.touches[0].clientX; }, {passive:true});
    $mvHost.addEventListener("touchend", (e)=>{
      if(startX==null) return;
      const dx = e.changedTouches[0].clientX - startX;
      startX = null;
      if(Math.abs(dx) < 40) return;
      if(dx < 0) setMediaIndex(mvIndex+1);
      else setMediaIndex(mvIndex-1);
    }, {passive:true});
  }

  // -------- Work modal (Library item) ----------
  async function openWorkModal(it){
    currentWork = Object.assign({}, it);
    liked = false;
    saved = false;

    try{
      const token = await getSessionToken();
      if(token){
        const st = await api(`/api/feed/state?post_id=${encodeURIComponent(currentWork.id)}`, { method:"GET" });
        liked = !!st.liked;
        saved = !!st.saved;
      }
    }catch(e){}

    const avatarType = it.avatar_type || profile?.avatar_type || "image";
    const av = it.avatar_url || profile?.avatar_url || "";
    const avatarEmoji = it.avatar_emoji || profile?.avatar_emoji || "";
    const uname = it.username || profile?.username || username;
    const dname = it.display_name || profile?.display_name || uname;

    renderAvatarInto($mAvatar, avatarType, av, avatarEmoji);
    document.getElementById("m-userline").textContent = "@" + uname;
    $mUserlink.innerHTML = `${escapeHtml(dname)} ${verifiedBadgeHTML((it.verified ?? profile?.verified) === true)}`;
    bindVerifiedTooltip($mUserlink.parentElement);
    $mUserlink.href = "/artist?username=" + encodeURIComponent(uname);

    $mmeta.textContent = fmtDate(it.published_at);
    $mFollowers.style.display = "inline-flex";
    $mFollowers.innerHTML = `<span>Followers</span><b>${it.follower_count ?? profile?.follower_count ?? 0}</b>`;
    $mtitle.textContent = it.title || "Untitled";
    $titleEditBtn.style.display = isOwnProfile ? "inline-flex" : "none";

    setWorkModalStats(it);
    setWorkActionButtons();
    renderWorkModalMedia(it);

    $dlBtn.onclick = async (e) => {
      e.preventDefault(); e.stopPropagation();
      const url = (it.media_url || it.thumb_url || "").trim();
      if(!url) return;
      const resp = await fetch(url, { mode:"cors" });
      const blob = await resp.blob();
      const a = document.createElement("a");
      a.href = URL.createObjectURL(blob);
      a.download = (it.title || "download").replace(/[^\w\- ]+/g, "").slice(0,40) + (isVideoUrl(url) ? ".mp4" : ".png");
      document.body.appendChild(a); a.click(); a.remove();
      setTimeout(()=> URL.revokeObjectURL(a.href), 1000);
    };

    $mb.classList.add("open");

    try{
      const token = await getSessionToken();
      const headers = { "Content-Type":"application/json" };
      if(token) headers.Authorization = "Bearer " + token;
      await fetch(WRITE_BACKEND + "/api/feed/view", {
        method:"POST", headers,
        body: JSON.stringify({ post_id: it.id, client_id: (crypto?.randomUUID?crypto.randomUUID():String(Date.now()) + Math.random()) })
      });
    }catch(e){}

    await loadWorkComments();
  }

  function closeWorkModal(){
    $mb.classList.remove("open");
    currentWork = null;
    $mp.innerHTML = "";
    $clist.innerHTML = "";
    $cinput.value = "";
    $titleEdit.style.display = "none";
    $titleEditBtn.style.display = "none";
  }

  function setWorkModalStats(it){
    $mstats.innerHTML = `
      <div class="stat">${ICONS.like} ${it.like_count||0}</div>
      <div class="stat">${ICONS.comm} ${it.comment_count||0}</div>
      <div class="stat">${ICONS.save} ${it.save_count||0}</div>
      <div class="stat">${ICONS.view} ${it.view_count||0}</div>
    `;
  }

  function setWorkActionButtons(){
    $likeBtn.classList.add("like");
    $saveBtn.classList.add("save");
    $likeBtn.classList.toggle("on", liked);
    $saveBtn.classList.toggle("on", saved);
    $likeBtn.innerHTML = `${ICONS.like} <span>${liked ? "Liked" : "Like"}</span>`;
    $saveBtn.innerHTML = `${ICONS.save} <span>${saved ? "Saved" : "Save"}</span>`;
    $dlBtn.innerHTML = ICONS.dl;
  }

  function renderWorkModalMedia(it){
    const media = (it.media_url || "").trim();
    const thumb = (it.thumb_url || "").trim();
    const url = media || thumb;
    if(isVideoUrl(url)){
      $mp.innerHTML = `<video src="${escapeHtml(url)}" controls autoplay playsinline loop style="width:100%;height:100%;object-fit:contain"></video>`;
    } else {
      $mp.innerHTML = `<img src="${escapeHtml(url)}" />`;
    }
  }

  function startTitleEdit(){
    if(!currentWork || !isOwnProfile) return;
    $titleInput.value = currentWork.title || "";
    $titleEdit.style.display = "flex";
    $titleInput.focus();
  }

  async function saveTitle(){
    if(!currentWork || !isOwnProfile) return;
    const title = ($titleInput.value||"").trim();
    const j = await api("/api/feed/update_title", { method:"POST", body: JSON.stringify({ post_id: currentWork.id, title }) });
    currentWork.title = j?.title ?? title;
    $mtitle.textContent = currentWork.title || "Untitled";
    const idx = libraryItems.findIndex(x=> String(x.id)===String(currentWork.id));
    if(idx>=0){ libraryItems[idx].title = currentWork.title; }
    $titleEdit.style.display = "none";
    if(tab === "library") renderLibrary();
  }

  async function loadWorkComments(){
    if(!currentWork) return;
    $clist.innerHTML = `<div class="empty" style="padding:18px">Loading…</div>`;
    try{
      const j = await api(`/api/feed/comments?post_id=${encodeURIComponent(currentWork.id)}&limit=80&offset=0`, { method:"GET" });
      const arr = Array.isArray(j.items) ? j.items : [];
      if(!arr.length){ $clist.innerHTML = `<div class="empty" style="padding:18px">No comments yet.</div>`; return; }
      $clist.innerHTML = arr.map(c=>`
        <div class="c-item">
          <div class="avatar ${((c.avatar_type === "emoji" && c.avatar_emoji) ? "emoji" : "")}">
            ${(c.avatar_type === "emoji" && c.avatar_emoji) ? `<span>${escapeHtml(c.avatar_emoji)}</span>` : (c.avatar_url ? `<img src="${escapeHtml(c.avatar_url)}" />` : "")}
          </div>
          <div class="c-bubble">
            <div class="c-top"><div class="c-name">${escapeHtml(c.display_name||c.username||"user")}</div><div class="c-time">${escapeHtml(fmtDate(c.created_at))}</div></div>
            <div class="c-body">${escapeHtml(c.body)}</div>
          </div>
        </div>
      `).join("");
      $clist.scrollTop = $clist.scrollHeight;
    }catch(e){
      $clist.innerHTML = `<div class="empty" style="padding:18px;color:#ff98a2">Error: ${escapeHtml(e.message)}</div>`;
    }
  }

  async function toggleWorkLike(){
    if(!currentWork) return;
    await requireToken();
    const path = liked ? "/api/feed/unlike" : "/api/feed/like";
    const j = await api(path, { method:"POST", body: JSON.stringify({ post_id: currentWork.id }) });
    if(j?.counts){
      currentWork.like_count = j.counts.like_count;
      currentWork.comment_count = j.counts.comment_count;
      currentWork.save_count = j.counts.save_count;
      currentWork.view_count = j.counts.view_count;
      setWorkModalStats(currentWork);
      const idx = libraryItems.findIndex(x=> String(x.id)===String(currentWork.id));
      if(idx>=0){ libraryItems[idx] = Object.assign({}, libraryItems[idx], currentWork); }
    }
    liked = !liked;
    setWorkActionButtons();
  }

  async function toggleWorkSave(){
    if(!currentWork) return;
    await requireToken();
    const path = saved ? "/api/feed/unsave" : "/api/feed/save";
    const j = await api(path, { method:"POST", body: JSON.stringify({ post_id: currentWork.id }) });
    if(j?.counts){
      currentWork.like_count = j.counts.like_count;
      currentWork.comment_count = j.counts.comment_count;
      currentWork.save_count = j.counts.save_count;
      currentWork.view_count = j.counts.view_count;
      setWorkModalStats(currentWork);
      const idx = libraryItems.findIndex(x=> String(x.id)===String(currentWork.id));
      if(idx>=0){ libraryItems[idx] = Object.assign({}, libraryItems[idx], currentWork); }
    }
    saved = !saved;
    setWorkActionButtons();
  }

  async function sendWorkComment(){
    if(!currentWork) return;
    await requireToken();
    const text = ($cinput.value||"").trim();
    if(!text) return;
    $csend.disabled = true;
    try{
      await api("/api/feed/comment", { method:"POST", body: JSON.stringify({ post_id: currentWork.id, body: text }) });
      $cinput.value = "";
      await loadWorkComments();
    } finally {
      $csend.disabled = false;
    }
  }

  // -------- Sheets: Post ----------
  function openPostSheet(mode, post=null){
    editingPostId = null;
    postDraftMedia = [];

    $ptitle.textContent = mode === "edit" ? "Edit post" : "New post";
    $ptext.value = post?.body || "";

    if(mode === "edit" && post){ editingPostId = post.id; }
    const media = Array.isArray(post?.media) ? post.media : [];
    postDraftMedia = media.map(m => m.id);

    $pPickedInfo.textContent = `Selected: ${postDraftMedia.length}`;
    $pPickGrid.style.display = "none";
    $pPickGrid.innerHTML = "";

    $pb.classList.add("open");
  }

  function closePostSheet(){ $pb.classList.remove("open"); editingPostId = null; postDraftMedia = []; }

  async function ensureLibraryLoadedForPicker(){
    if(libraryItems.length) return;
    await loadLibrary(true);
  }

  function openPicker(mode, data){
    pickMode = mode;
    pickSelectedId = null;
    pickSelectedSet = new Set();
    $pickTitle.textContent = data.title || "Pick";
    $pickHint.textContent = data.hint || "";
    $pickSearch.value = "";
    $pickList.innerHTML = `<div class="empty" style="padding:18px">Loading…</div>`;
    $pickB.classList.add("open");

    const layout = data.layout === "wide" ? "wide" : "list";
    let filterType = "all";
    const allowedKinds = Array.isArray(data.allowedKinds) ? data.allowedKinds : null;
    if(allowedKinds && allowedKinds.length === 1){
      filterType = allowedKinds[0];
    }
    let visibleCount = layout === "wide" ? 48 : 200;

    if(data.preselected && Array.isArray(data.preselected)){
      data.preselected.forEach(id => pickSelectedSet.add(String(id)));
    }

    if($pickFilters){
      const show = layout === "wide" && !allowedKinds && !data.hideTypeTabs;
      $pickFilters.style.display = show ? "flex" : "none";
      $pickFilters.querySelectorAll("[data-type]").forEach(btn=>{
        btn.classList.toggle("on", btn.getAttribute("data-type") === "all");
        btn.onclick = ()=>{
          filterType = btn.getAttribute("data-type") || "all";
          $pickFilters.querySelectorAll("[data-type]").forEach(x=> x.classList.toggle("on", x===btn));
          visibleCount = layout === "wide" ? 48 : 200;
          renderList($pickSearch.value);
        };
      });
    }

    function resolveKind(it){
      const type = String(it.type || "").toLowerCase();
      if(type.includes("video")) return "video";
      const u = String(it.media_url || it.thumb || "").toLowerCase();
      return /\.(mp4|mov|webm|m3u8)(\?|$)/.test(u) ? "video" : "image";
    }

    function renderList(filterText=""){
      const q = (filterText||"").toLowerCase().trim();
      const source = (data.items || []).filter(it=>{
        const kind = resolveKind(it);
        if(allowedKinds && !allowedKinds.includes(kind)) return false;
        if(filterType !== "all" && kind !== filterType) return false;
        if(!q) return true;
        return String(it.title||"").toLowerCase().includes(q) || String(it.description||"").toLowerCase().includes(q);
      });
      const items = source.slice(0, visibleCount);

      $pickList.innerHTML = `
        <div class="pick-list ${layout === "wide" ? "wide" : ""}" id="pickListInner">
          ${items.map(it=>{
            const pid = String(it.id);
            const on = data.multi ? pickSelectedSet.has(pid) : (String(pickSelectedId) === pid);
            const kind = resolveKind(it);
            return `
              <div class="pick-row ${on?'on':''} ${layout === "wide" ? "wide" : ""}" data-pid="${pid}">
                <div class="pick-thumb ${layout === "wide" ? "wide" : ""}">${it.thumb ? `<img src="${it.thumb}">` : ""}</div>
                <div class="pick-main ${layout === "wide" ? "wide" : ""}">
                  <div class="pick-name">${escapeHtml(it.title||"Untitled")}</div>
                  <div class="pick-sub">${escapeHtml(it.description||"")}</div>
                  ${layout === "wide" ? `<div class="pick-sub" style="margin-top:6px;">${kind === "video" ? "Video" : "Image"}</div>` : ``}
                </div>
                ${layout === "wide" ? `<div class="pick-check">${on ? "✓" : ""}</div>` : `<div style="font-weight:950;opacity:.9">${on ? "✓" : ""}</div>`}
              </div>
            `;
          }).join("")}
        </div>
      `;

      $pickList.querySelectorAll("[data-pid]").forEach(row=>{
        row.onclick = ()=>{
          const id = row.getAttribute("data-pid");
          if(data.multi){
            if(pickSelectedSet.has(id)) pickSelectedSet.delete(id);
            else pickSelectedSet.add(id);
            renderList($pickSearch.value);
          }else{
            pickSelectedId = id;
            renderList($pickSearch.value);
          }
        };
      });

      const inner = document.getElementById("pickListInner");
      if(layout === "wide" && inner){
        inner.onscroll = ()=>{
          if(visibleCount >= source.length) return;
          const nearBottom = inner.scrollTop + inner.clientHeight >= inner.scrollHeight - 120;
          if(!nearBottom) return;
          visibleCount += 48;
          renderList($pickSearch.value);
        };
      }
    }

    renderList("");

    $pickSearch.oninput = ()=> {
      visibleCount = layout === "wide" ? 48 : 200;
      renderList($pickSearch.value);
    };

    return new Promise((resolve)=>{
      pickResolve = resolve;
      $pickOk.onclick = ()=>{
        const result = data.multi ? Array.from(pickSelectedSet) : pickSelectedId;
        closePicker();
        resolve(result);
      };
      $pickCancel.onclick = ()=>{ closePicker(); resolve(data.multi ? [] : null); };
      $pickClose.onclick = ()=>{ closePicker(); resolve(data.multi ? [] : null); };
      $pickB.onclick = (e)=>{ if(e.target === $pickB){ closePicker(); resolve(data.multi ? [] : null); } };
    });
  }

  function closePicker(){
    $pickB.classList.remove("open");
    if($pickFilters) $pickFilters.style.display = "none";
    pickMode = null;
    pickSelectedId = null;
    pickSelectedSet = new Set();
    pickResolve = null;
  }

  async function savePostDraft(){
    try{
      await requireToken();
      const body = ($ptext.value || "").trim();

      if(editingPostId){
        await api("/api/posts/update", { method:"POST", body: JSON.stringify({ post_id: editingPostId, body, feed_post_ids: postDraftMedia }) });
        toast("Updated");
      } else {
        await api("/api/posts/create", { method:"POST", body: JSON.stringify({ body, feed_post_ids: postDraftMedia }) });
        toast("Created");
      }

      closePostSheet();
      await loadPosts(true);
    }catch(e){
      toast(e.message || "Failed");
    }
  }

  // Attach collection into post body via marker
  async function attachCollectionMarker(){
    try{
      if(!collectionItems.length){
        const oldTab = tab;
        await loadCollections(true);
        tab = oldTab;
        if(oldTab === "posts") renderPosts();
      }
      if(!collectionItems.length){ toast("No collections"); return; }

      const items = collectionItems.map(c=>{
        const prev = Array.isArray(c.preview_items) ? c.preview_items : [];
        const thumb = (prev[0]?.thumb_url || prev[0]?.media_url || "") || "";
        return { id: c.id, title: c.title || "Untitled", description: c.description || "", thumb };
      });

      const picked = await openPicker("collection", {
        title: "Attach collection",
        hint: "Choose a collection to attach to the post",
        items,
        multi: false
      });

      if(!picked) return;

      const marker = `[[collection:${picked}]]`;
      $ptext.value = ($ptext.value || "") + ($ptext.value ? "\n\n" : "") + marker;
      toast("Collection attached");
    }catch(e){
      toast("Failed");
    }
  }

  // -------- Sheets: Collection ----------
  async function openCollectionSheet(mode, col=null){
    editingColId = null;
    colDraftMedia = [];
    colDraftCover = null;

    $ktitle.textContent = mode === "edit" ? "Edit collection" : "New collection";
    $kname.value = col?.title || "";
    $kdesc.value = col?.description || "";

    await ensureLibraryLoadedForPicker();

    if(mode === "edit" && col){
      editingColId = col.id;
    }

    $kPickMedia.style.display = "none";
    $kPickedInfo.style.display = "none";
    $kSelectedWrap.style.display = "none";
    $kPickGrid.style.display = "none";
    $kPickGrid.innerHTML = "";
    $kPickedInfo.textContent = "";
    $kSelectedGrid.innerHTML = "";
    $kb.classList.add("open");
  }


  function renderCollectionDraftSelected(){
    if(!colDraftMedia.length){
      $kSelectedWrap.style.display = "none";
      $kSelectedGrid.innerHTML = "";
      return;
    }
    $kSelectedWrap.style.display = "block";
    const byId = new Map(libraryItems.map(it=> [String(it.id), it]));
    if(!colDraftCover || !colDraftMedia.includes(colDraftCover)) colDraftCover = colDraftMedia[0] || null;
    $kSelectedGrid.innerHTML = colDraftMedia.map(id=>{
      const it = byId.get(String(id)) || {};
      const thumb = (it.thumb_url || it.media_url || "").trim();
      const title = it.title || "Untitled";
      const isCover = String(colDraftCover||"") === String(id);
      return `<div class="picked-item ${isCover?"is-cover":""}" data-picked="${escapeHtml(String(id))}" title="Set as cover">
        ${thumb ? `<img src="${escapeHtml(thumb)}" alt="">` : ``}
        <button type="button" class="picked-remove" data-remove-picked="${escapeHtml(String(id))}">×</button>
        ${isCover ? `<div class="picked-cover">Cover</div>` : ``}
      </div>`;
    }).join("");

    $kSelectedGrid.querySelectorAll("[data-picked]").forEach(el=>{
      el.onclick = (e)=>{
        if(e.target.closest("[data-remove-picked]")) return;
        colDraftCover = el.getAttribute("data-picked");
        renderCollectionDraftSelected();
      };
    });
    $kSelectedGrid.querySelectorAll("[data-remove-picked]").forEach(btn=>{
      btn.onclick = (e)=>{
        e.stopPropagation();
        const id = btn.getAttribute("data-remove-picked");
        colDraftMedia = colDraftMedia.filter(x=> String(x)!==String(id));
        if(String(colDraftCover||"")===String(id)) colDraftCover = colDraftMedia[0] || null;
        $kPickedInfo.textContent = `Selected: ${colDraftMedia.length}`;
        renderCollectionDraftSelected();
      };
    });
  }

  function closeCollectionSheet(){ $kb.classList.remove("open"); editingColId = null; colDraftMedia = []; colDraftCover = null; $kSelectedGrid.innerHTML = ""; $kSelectedWrap.style.display = "none"; }

  async function saveCollectionDraft(){
    try{
      await requireToken();
      const title = ($kname.value || "").trim();
      const description = ($kdesc.value || "").trim();

      if(editingColId){
        await api("/api/collections/update", {
          method:"POST",
          body: JSON.stringify({ id: editingColId, title, description })
        });
        toast("Updated");
      } else {
        const r = await api("/api/collections/create", {
          method:"POST",
          body: JSON.stringify({ title, description, feed_post_ids: [], cover_feed_post_id: null })
        });

        closeCollectionSheet();
        await loadCollections(true);

        const newColId = r?.id || r?.collection_id || r?.collection?.id;
        if(newColId) await openCollectionModal(newColId);
        openSceneSheet("new", null);
        toast("Now create a scene");
        return;
      }

      closeCollectionSheet();
      await loadCollections(true);
    }catch(e){
      toast(e.message || "Failed");
    }
  }

  // -------- Events ----------
  $segTabs.querySelectorAll("button").forEach(b=>{
    b.onclick = () => switchTab(b.dataset.tab).catch(e=>toast(e.message||"Failed"));
  });

  $segSort.querySelectorAll("button").forEach(b=>{
    b.onclick = () => {
      $segSort.querySelectorAll("button").forEach(x=>x.classList.remove("active"));
      b.classList.add("active");
      sort = b.dataset.sort || "new";
      if(tab === "collections") loadCollections(true);
      if(tab === "library") loadLibrary(true);
    };
  });

  $range.onchange = () => { range = $range.value; if(tab === "library") loadLibrary(true); };

  window.addEventListener("scroll", () => {
    const state = tabState[tab];
    if(!state || !state.hasMore || state.loading) return;
    const nearBottom = (window.innerHeight + window.scrollY) >= (document.body.offsetHeight - 900);
    if(!nearBottom) return;

    if(tab === "posts") loadPosts(false);
    else if(tab === "collections") loadCollections(false);
    else loadLibrary(false);
  });

  $pFollowBtn.onclick = () => toggleFollow().catch(e=>toast(e.message||"Failed"));

  // Work modal events
  $mclose.onclick = closeWorkModal;
  $mb.onclick = (e) => { if(e.target === $mb) closeWorkModal(); };
  $likeBtn.onclick = () => toggleWorkLike().catch(e=>toast(e.message||"Failed"));
  $saveBtn.onclick = () => toggleWorkSave().catch(e=>toast(e.message||"Failed"));
  $reloadComments.onclick = loadWorkComments;
  $csend.onclick = sendWorkComment;
  $titleEditBtn.onclick = startTitleEdit;
  $titleCancel.onclick = () => { $titleEdit.style.display = "none"; };
  $titleSave.onclick = async () => { try{ await saveTitle(); }catch(e){ toast(e.message || "Save failed"); } };

  // Collection modal events
  $cclose.onclick = closeCollectionModal;
  $cb.onclick = (e) => { if(e.target === $cb) closeCollectionModal(); };

  $btnColReorder.onclick = () => {
    if(!currentCol) return;
    if(!colReorderMode){
      colReorderMode = true;
      colOriginalOrderIds = (currentCol.items || []).map(x=> x.id);
      toast("Drag items and press Save order");
    } else {
      colReorderMode = false;
    }
    renderCollectionModalGrid();
  };

  $btnColReorderSave.onclick = async () => {
    if(!currentCol || !colReorderMode) return;
    const ok = await confirmUI("Save order", "Apply new order?", "Save", false);
    if(!ok) return;
    try{
      await saveCollectionOrder();
      colReorderMode = false;
      renderCollectionModalGrid();
      toast("Order saved");
      tabState.collections.loadedOnce = false;
      await loadCollections(true);
    }catch(e){
      toast(e.message || "Failed");
    }
  };

  $btnColReorderCancel.onclick = () => {
    if(!currentCol) return;
    const map = new Map((currentCol.items || []).map(it=> [String(it.id), it]));
    currentCol.items = (colOriginalOrderIds || []).map(id=> map.get(String(id))).filter(Boolean);
    colReorderMode = false;
    renderCollectionModalGrid();
  };

  $btnColEdit.onclick = () => { if(currentCol) openCollectionSheet("edit", currentCol.col).catch(e=>toast(e.message||"Failed")); };

  $btnSceneNew.onclick = ()=>{
    if(!currentCol) return;
    openSceneSheet("new", null);
  };

  $btnColDelete.onclick = async () => {
    if(!currentCol) return;
    if(!confirm("Delete this collection?")) return;
    try{
      await requireToken();
      await api("/api/collections/delete", { method:"POST", body: JSON.stringify({ id: currentCol.col.id }) });
      toast("Deleted");
      closeCollectionModal();
      await loadCollections(true);
    }catch(e){
      toast(e.message||"Failed");
    }
  };

  // Post sheet
  $btnNewPost.onclick = () => openPostSheet("new", null);
  $pclose.onclick = closePostSheet;
  $pb.onclick = (e)=>{ if(e.target === $pb) closePostSheet(); };
  $pcancel.onclick = closePostSheet;
  $psave.onclick = savePostDraft;

  $pPickMedia.onclick = async () => {
    await ensureLibraryLoadedForPicker();

    const items = libraryItems.slice(0, 200).map(it=>{
      const thumb = (it.thumb_url || it.media_url || "") || "";
      return { id: it.id, title: it.title || "Untitled", description: "", thumb, type: it.file_type || "", media_url: it.media_url || "" };
    });

    const picked = await openPicker("library", {
      title: "Add media from Library",
      hint: "Select images/videos (multi-select). Upload from ПК disabled.",
      items,
      multi: true,
      layout: "wide",
      preselected: postDraftMedia
    });

    if(Array.isArray(picked)){
      const merged = new Set(postDraftMedia.map(String));
      picked.forEach(id => merged.add(String(id)));
      postDraftMedia = Array.from(merged);
      $pPickedInfo.textContent = `Selected: ${postDraftMedia.length}`;
    }
  };

  $pPickCollection.onclick = attachCollectionMarker;

  // Collection sheet
  $btnNewCol.onclick = () => openCollectionSheet("new", null).catch(e=>toast(e.message||"Failed"));
  $kclose.onclick = closeCollectionSheet;
  $kb.onclick = (e)=>{ if(e.target === $kb) closeCollectionSheet(); };
  $kcancel.onclick = closeCollectionSheet;
  $ksave.onclick = saveCollectionDraft;

  $kPickMedia.onclick = async () => {
    toast("Add media only via Scenes");
    return;
  };

  $pcoverEdit.onclick = async () => {
    if(!isOwnProfile) return;
    await ensureLibraryLoadedForPicker();

    const items = libraryItems
      .filter(it => {
        const u = (it.thumb_url || it.media_url || "").trim();
        return u && !isVideoUrl(u);
      })
      .slice(0, 400)
      .map(it => ({
        id: it.id,
        title: it.title || "Untitled",
        thumb: (it.thumb_url || it.media_url || "")
      }));

    if(!items.length){
      toast("No images in Library");
      return;
    }

    const picked = await openPicker("profile_cover", {
      title: "Choose profile cover",
      hint: "Pick one image from your Library",
      items,
      multi: false,
      layout: "wide",
      hideTypeTabs: true
    });

    if(!picked) return;

    await requireToken();
    await api("/api/profile/header_set", {
      method: "POST",
      body: JSON.stringify({ feed_post_id: picked })
    });

    profile.header_feed_post_id = picked;
    renderProfileCover(profile);
    toast("Cover updated");
  };

  $pcoverDel.onclick = async () => {
    if(!isOwnProfile) return;
    const ok = await confirmUI("Remove cover", "Reset to default cover?");
    if(!ok) return;
    await requireToken();
    await api("/api/profile/header_set", {
      method: "POST",
      body: JSON.stringify({ feed_post_id: null })
    });
    profile.header_feed_post_id = null;
    renderProfileCover(profile);
    toast("Cover reset");
  };

  $scClose.onclick = closeSceneSheet;
  $scCancel.onclick = closeSceneSheet;
  $scB.onclick = (e)=>{ if(e.target === $scB) closeSceneSheet(); };

  $scSave.onclick = async ()=>{
    try{
      await requireToken();
      if(!currentCol) return;

      const title = ($scName.value||"").trim();
      const description = ($scDesc.value||"").trim();
      if(!title) return scStatus("Title required", "err");

      scStatus("Saving…", "");

      if(editingSceneId){
        await api("/api/collections/sections/update", {
          method:"POST",
          body: JSON.stringify({ section_id: editingSceneId, title, description })
        });
      } else {
        await api("/api/collections/sections/create", {
          method:"POST",
          body: JSON.stringify({ collection_id: currentCol.col.id, title, description })
        });
      }

      closeSceneSheet();
      const j = await api(`/api/collections/get?id=${encodeURIComponent(currentCol.col.id)}`, { method:"GET" });
      currentCol.sections = j.sections || [];
      currentCol.items = j.items || [];
      renderCollectionModalGrid();
      toast("Saved");
    }catch(e){
      scStatus(e.message||"Failed", "err");
    }
  };

  $fsSubmit.onclick = async ()=>{
    try{
      await requireToken();
      const title = ($fsTitle.value||"").trim();
      const description = ($fsDesc.value||"").trim();
      const source_url = ($fsUrl.value||"").trim();
      if(!fsCollectionId) return;
      if(!title || !source_url) return fsShowStatus("Title and link are required", "err");

      fsShowStatus("Submitting…", "");
      const r = await api("/api/collections/film_submit", {
        method:"POST",
        body: JSON.stringify({ collection_id: fsCollectionId, title, description, source_url })
      });

      fsShowStatus("Submitted. Status: pending review.", "ok");
      toast("Submitted");
      renderCollectionFilmBlock(r.film || { status:"pending" }, fsCollectionId);
      setTimeout(()=> closeFilmSheet(), 650);
    }catch(e){
      fsShowStatus(e.message || "Failed", "err");
    }
  };

  $fsCancel.onclick = closeFilmSheet;
  $fsClose.onclick = closeFilmSheet;
  $fsB.onclick = (e)=>{ if(e.target === $fsB) closeFilmSheet(); };

  // Media Viewer events
  $mvClose.onclick = closeMediaViewer;
  $mvb.onclick = (e)=>{ if(e.target === $mvb) closeMediaViewer(); };
  $mvPrev.onclick = ()=> setMediaIndex(mvIndex-1);
  $mvNext.onclick = ()=> setMediaIndex(mvIndex+1);
  bindViewerSwipe();

  $emoClose.onclick = closeEmojiPicker;
  $emoB.onclick = (e)=>{ if(e.target === $emoB) closeEmojiPicker(); };
  $emoSearch.oninput = ()=> renderEmojiGrid($emoSearch.value);
  $cfClose.onclick = ()=> $cfB.classList.remove("open");
  $cfCancel.onclick = ()=> $cfB.classList.remove("open");
  $cfB.onclick = (e)=>{ if(e.target === $cfB) $cfB.classList.remove("open"); };

  // -------- Init ----------
  async function init(){
    username = (qs("username") || "").trim();
    if(!username){
      $pName.textContent = "No username";
      $pUser.textContent = "Add ?username=...";
      $gridPosts.innerHTML = `<div class="empty">Open like: /artist?username=username</div>`;
      return;
    }

    await loadProfileHeaderOnce();
    myUserId = await getCurrentUserId();

    try{
      const { data } = await window.sb.auth.getSession();
      const token = data?.session?.access_token;
      if(token){
        myProfile = await fetchMyPublicProfile(token);
      }
    }catch(e){}

    if(!myProfile){
      myProfile = { display_name:"User", username:"", avatar_type:"image", avatar_url:"", avatar_emoji:"" };
    }
    tab = "";
    setActivePane("posts");
    renderTabControls();

    window.setArtistTab = async (nextTab) => {
      const allowed = new Set(["posts", "collections", "library"]);
      const normalized = String(nextTab || "").toLowerCase();
      const targetTab = allowed.has(normalized) ? normalized : "posts";
      await switchTab(targetTab);
    };

    bindFilmRulesTooltip();
    await applyTabFromUrl();
  }

  init().catch(e=>{
    console.error(e);
    $grid.innerHTML = `<div class="empty" style="color:#ff98a2;border-color:rgba(255,70,90,0.3)">Error: ${escapeHtml(e.message)}</div>`;
  });
})();
</script>
